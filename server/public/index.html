<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Begeç Asansör - Stok Takip Sistemi</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* Custom CSS variables for consistent theming */
        :root {
            --primary-color: #3182ce; /* Mavi */
            --primary-dark-color: #2b6cb0; /* Koyu Mavi */
            --secondary-color: #2d3748; /* Koyu Gri Mavi (Sidebar için) */
            --secondary-light-color: #4a5568; /* Açık Gri Mavi */
            --text-light: #a0aec0; /* Açık Gri Metin */
            --text-dark: #1f2937; /* Koyu Metin */
            --text-muted: #4b5563;
            --bg-light: #f3f4f6; /* Açık Gri Arka Plan */
            --bg-content: #ffffff; /* Beyaz İçerik Alanı Arka Planı */
            --border-color: #e2e8f0; /* Kenarlık Rengi */
            --danger-color: #e53e3e; /* Kırmızı Hata/Silme Rengi */
            --success-color: #38a169; /* Yeşil Başarı Rengi */
            --warning-color: #dd6b20; /* Turuncu Uyarı Rengi */
        }

        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* Login Sayfası Stilleri */
        /* Login sayfasının tüm ekranı kaplamasını ve en üstte olmasını sağlar */
        #login-page {
            position: fixed; /* Sayfayı sabitler */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-light); /* Arka plan rengi */
            display: flex; /* İçeriği ortalamak için */
            justify-content: center; /* Yatayda ortala */
            align-items: center; /* Dikeyde ortala */
            z-index: 1000; /* Diğer tüm içeriklerin üzerinde olmasını sağlar */
            opacity: 1; /* Başlangıçta görünür */
            visibility: visible; /* Başlangıçta görünür */
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; /* Geçiş efekti */
        }

        #login-page.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none; /* Gizlendiğinde tıklanamaz yapar */
        }

        /* Ana Uygulama Konteyner Stilleri */
        /* Uygulama içeriğinin başlangıçta gizli olmasını sağlar */
        #app-container {
            display: flex;
            min-height: 100vh;
            transition: margin-left 0.3s ease-in-out;
            opacity: 0; /* Başlangıçta gizli */
            visibility: hidden; /* Başlangıçta gizli */
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; /* Geçiş efekti */
        }

        #app-container.active {
            opacity: 1;
            visibility: visible;
        }


        /* Layout specific styles */
        #sidebar {
            width: 250px;
            background-color: var(--secondary-color);
            color: white;
            flex-shrink: 0;
            transition: transform 0.3s ease-in-out;
            transform: translateX(-250px); /* Hidden by default on mobile */
            position: fixed;
            height: 100%;
            z-index: 1000; /* Ensure sidebar is on top */
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            border-radius: 0 12px 12px 0; /* Rounded right corners */
        }

        #sidebar.open {
            transform: translateX(0); /* Show sidebar */
        }

        #main-content-wrapper {
            flex-grow: 1;
            margin-left: 0; /* No margin by default */
            transition: margin-left 0.3s ease-in-out;
            padding: 1rem;
            background-color: var(--bg-light);
        }

        #main-content-wrapper.sidebar-open {
            margin-left: 250px; /* Adjust content when sidebar is open */
        }

        /* Header styles */
        #header {
            background-color: var(--bg-content);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0.5rem; /* Rounded corners for header */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }

        /* Hamburger menu for mobile */
        #hamburger-menu-button {
            display: none; /* Hidden by default on desktop */
            background-color: var(--primary-color);
            color: white;
            padding: 0.5rem 0.8rem;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Page content styling */
        .page-content {
            background-color: var(--bg-content);
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }

        /* Table styling */
        .table-container {
            overflow-x: auto; /* Enable horizontal scroll for tables on small screens */
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th, .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background-color: var(--bg-light);
            font-weight: 600;
            color: var(--text-dark);
            white-space: nowrap; /* Prevent wrapping for headers */
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .data-table tbody tr:hover {
            background-color: #f0f4f8;
        }

        /* Form styling */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="number"],
        .form-group input[type="email"],
        .form-group input[type="date"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            color: var(--text-dark);
            background-color: #f8fafc;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(49, 130, 206, 0.2);
        }

        .form-group input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        /* Button styling */
        .btn {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background-color: var(--secondary-light-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #3b485b;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c53030;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #2f855a;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-info {
            background-color: #319795; /* Teal */
            color: white;
        }

        .btn-info:hover {
            background-color: #2c7a7b;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Above everything else */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--bg-content);
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
            position: relative;
        }

        .modal-overlay.open .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
        }

        .modal-close-button {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s ease-in-out;
        }

        .modal-close-button:hover {
            color: var(--text-dark);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        /* Message Box / Toast Notification */
        #message-box {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
            max-width: 350px;
            pointer-events: none; /* Allow clicks on elements underneath */
        }

        .message-item {
    padding: 1rem 1.25rem;
    border-radius: 0.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    color: white;
    font-weight: 600;
    opacity: 0;
    transform: translateY(-20px);
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    pointer-events: auto;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    position: relative;
}

.message-item i {
    font-size: 1.1rem;
    flex-shrink: 0;
}

.message-item span {
    flex-grow: 1;
}

.toast-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s;
}

.toast-close:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

        .message-item.show {
            opacity: 1;
            transform: translateY(0);
        }

        .message-item.success {
            background-color: var(--success-color);
        }

        .message-item.error {
            background-color: var(--danger-color);
        }

        .message-item.warning {
            background-color: var(--warning-color);
        }

        .message-item.info {
            background-color: var(--primary-color);
        }

        /* Responsive adjustments */
        @media (max-width: 991px) {
            #sidebar {
                transform: translateX(-250px); /* Hide sidebar on mobile */
            }

            #sidebar.open {
                transform: translateX(0); /* Show sidebar when open */
            }

            #main-content-wrapper {
                margin-left: 0; /* No left margin on mobile */
            }

            #hamburger-menu-button {
                display: block; /* Show hamburger menu on mobile */
            }

            /* Prevent horizontal scrolling when sidebar is open on mobile */
            html.sidebar-active {
                overflow-x: hidden;
            }
        }

        @media (min-width: 992px) {
            #sidebar {
                transform: translateX(0); /* Always show sidebar on desktop */
                position: relative; /* Take up space in layout */
            }

            #main-content-wrapper {
                margin-left: 250px; /* Adjust content when sidebar is open on desktop */
            }

            #hamburger-menu-button {
                display: none; /* Hide hamburger menu on desktop */
            }
        }

        /* Specific styles for elements */
        .sidebar-header {
            padding: 1.5rem 1rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
        }

        .sidebar-header img {
            max-width: 120px;
            height: auto;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .sidebar-header h2 {
            font-size: 1.4rem;
            font-weight: 700;
            color: white;
            margin: 0;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        .sidebar-menu li {
            margin-bottom: 0.5rem;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: var(--text-light);
            text-decoration: none;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 500;
        }

        .sidebar-menu a i {
            margin-right: 0.75rem;
            font-size: 1.1rem;
        }

        .sidebar-menu a:hover {
            background-color: var(--secondary-light-color);
            color: white;
        }

        .sidebar-menu a.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .sidebar-footer {
            padding: 1.5rem 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .sidebar-footer .user-info {
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .sidebar-footer button {
            width: 100%;
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .sidebar-footer button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Login Page */
        .login-box {
            background-color: var(--bg-content);
            padding: 2.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-box h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 1.5rem;
        }

        .login-box .form-group {
            text-align: left;
        }

        .login-box .btn-primary {
            width: 100%;
            margin-top: 1.5rem;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card {
            background-color: var(--bg-content);
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .card h4 {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 0;
        }

        .card .value.critical {
            color: var(--danger-color);
        }

        /* Stock Operation Sections */
        .stock-operation-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .stock-operation-section .input-area,
        .stock-operation-section .product-info-area,
        .stock-operation-section .transaction-details-area,
        .stock-operation-section .recent-transactions-area {
            background-color: var(--bg-content);
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .search-results {
            position: absolute;
            width: calc(100% - 3rem); /* Adjust for padding */
            background-color: var(--bg-content);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .search-result-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background-color: var(--bg-light);
        }

        .search-result-item .stock-info {
            font-weight: 600;
            color: var(--primary-color);
        }

        .product-info-area .current-stock-display {
            font-size: 2rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }

        .product-info-area .current-stock-display.low-stock {
            color: var(--danger-color);
        }

        /* DÜZELTME: Sayı artırma/azaltma butonları arasındaki boşluk */
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.25rem; /* Boşluğu azaltıldı */
        }

        .quantity-controls button {
            width: 36px; /* Buton genişliği küçültüldü */
            height: 36px; /* Buton yüksekliği küçültüldü */
            font-size: 1.1rem; /* Font boyutu ayarlandı */
            border-radius: 0.5rem;
            background-color: var(--secondary-light-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }

        .quantity-controls button:hover {
            background-color: var(--secondary-color);
        }

        .quantity-controls input {
            flex-grow: 1;
            text-align: center;
            font-size: 1rem; /* Input font boyutu ayarlandı */
            padding: 0.5rem; /* Input padding'i azaltıldı */
        }

        .btn-process {
    width: 100%;
    padding: 1rem;
    font-size: 1.1rem;
    margin-top: 1.5rem;
}

/* Loading Spinner */
.table-loading {
    position: relative;
    opacity: 0.6;
    pointer-events: none;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 0.5rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-active { background-color: #d1fae5; color: #065f46; }
.status-inactive { background-color: #fee2e2; color: #991b1b; }
.status-critical { background-color: #fef3c7; color: #92400e; }

        /* Filter and Sort Controls */
        .filter-sort-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: flex-end; /* Align items to the bottom */
        }

        .filter-sort-controls .form-group {
            flex: 1;
            min-width: 180px; /* Minimum width for filter inputs */
            margin-bottom: 0; /* Remove default margin */
        }

        .filter-sort-controls .action-buttons {
            display: flex;
            gap: 0.75rem;
        }

        /* Company Detail Page */
        .company-detail-header {
            background-color: var(--bg-content);
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }

        .company-detail-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }

        .company-detail-header p {
            margin: 0.5rem 0;
            font-size: 1rem;
            color: var(--text-dark);
        }

        .company-detail-header p strong {
            color: var(--secondary-color);
        }

        .company-row {
            cursor: pointer;
        }
        .company-row:hover {
            background-color: var(--bg-light);
        }

        /* Audit logs preformatted text */
        #auditLogsTableBody pre {
            white-space: pre-wrap; /* Allow long text to wrap */
            word-break: break-all; /* Break long words */
            font-size: 0.8rem;
            background-color: #f8fafc;
            padding: 0.5rem;
            border-radius: 0.25rem;
            max-height: 100px; /* Limit height */
            overflow-y: auto; /* Scroll if content overflows */
        }
        
        /* BOM Management Specific Styles */
        #bom-display-area {
            transition: opacity 0.3s ease-in-out;
        }

        #bom-display-area.hidden {
            display: none;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        #bom-items-table .action-buttons {
            white-space: nowrap;
        }

        #bom-items-table .action-buttons .btn {
            margin-right: 0.5rem;
        }

        #bom-items-table .action-buttons .btn:last-child {
            margin-right: 0;
        }

        /* BOM success indicators */
        .bom-success-flash {
            animation: flash-green 0.5s ease-in-out;
        }





        @keyframes flash-green {
            0% { background-color: transparent; }
            50% { background-color: #d1fae5; }
            100% { background-color: transparent; }
        }


        @media (max-width: 768px) {
    .table-container { /* Bu sınıf zaten tablonun etrafındaki div'de olmalı */
        font-size: 0.8rem; /* Tablo içindeki yazı boyutunu biraz küçültür */
    }
    .data-table th, 
    .data-table td {
        padding: 0.5rem 0.25rem; /* Hücre iç boşluklarını azaltır */
        white-space: nowrap;     /* Metinlerin alt satıra kaymasını engeller */
        overflow: hidden;        /* Taşan metni gizler */
        text-overflow: ellipsis; /* Taşan metnin sonuna "..." ekler */
        max-width: 120px;        /* Hücrelerin maksimum genişliğini sınırlar, çok uzun metinler için */
    }
    /* Eğer belirli sütunların daha geniş/dar olmasını isterseniz, onlara özel sınıflar ekleyebilirsiniz */
    /* Örneğin:
    .data-table .td-product-name { max-width: 150px; }
    .data-table .td-quantity { max-width: 60px; white-space: normal; } 
    */
}


    </style>



    <div id="message-box"></div>

    <div id="login-page" class="flex justify-center items-center min-h-screen w-full bg-gray-100">
        <div class="login-box">
            <img src="https://placehold.co/150x50/2d3748/ffffff?text=BEGE%C3%87%0AASANS%C3%96R" alt="Begeç Asansör Logo" class="mx-auto mb-6 rounded-lg">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Stok Takip Sistemi</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="username" class="block text-gray-700 font-medium mb-2">Kullanıcı Adı</label>
                    <input type="text" id="username" name="username" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="form-group">
                    <label for="password" class="block text-gray-700 font-medium mb-2">Şifre</label>
                    <input type="password" id="password" name="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="btn btn-primary w-full mt-6">Giriş Yap</button>
            </form>
        </div>
    </div>

    <div id="app-container">
        <aside id="sidebar" class="flex flex-col">
            <div class="sidebar-header">
                <img src="https://placehold.co/120x40/2d3748/ffffff?text=BEGE%C3%87%0AASANS%C3%96R" alt="Begeç Asansör Logo">
                <h2>Begeç Asansör</h2>
            </div>
            <nav class="sidebar-menu">
                <ul>
                    <li data-roles="admin,uretim,sevkiyat"><a href="#dashboard" class="menu-item active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li data-roles="admin,uretim"><a href="#manage-products" class="menu-item" data-page="manageProducts"><i class="fas fa-boxes"></i> Ürün Yönetimi</a></li>
                    <li data-roles="admin"><a href="#manage-categories" class="menu-item" data-page="manageCategories"><i class="fas fa-tags"></i> Kategori ve Birim Yönetimi</a></li>
                    <li data-roles="admin,uretim"><a href="#manage-bom" class="menu-item" data-page="manageBom"><i class="fas fa-cogs"></i> Ürün Reçeteleri</a></li>
                    <li data-roles="admin,uretim"><a href="#purchase-in" class="menu-item" data-page="purchaseIn"><i class="fas fa-shopping-cart"></i> 📦 Satın Alma Girişi</a></li>
<li data-roles="admin,uretim"><a href="#production-in" class="menu-item" data-page="productionIn"><i class="fas fa-industry"></i> 🏭 Üretim Tamamlama</a></li>
                    <li data-roles="admin,sevkiyat"><a href="#stock-out" class="menu-item" data-page="stockOut"><i class="fas fa-arrow-alt-circle-up"></i> Sevkiyat Hazırlık (Çıkış)</a></li>
                    <li data-roles="admin,uretim"><a href="#stock-adjustment" class="menu-item" data-page="stockAdjustment"><i class="fas fa-exchange-alt"></i> Envanter Sayım / Düzeltme</a></li>
                    <li data-roles="admin,uretim,sevkiyat"><a href="#manage-companies" class="menu-item" data-page="manageCompanies"><i class="fas fa-building"></i> Firma Yönetimi</a></li>
                    <li data-roles="admin,uretim,sevkiyat"><a href="#reports" class="menu-item" data-page="reports"><i class="fas fa-chart-line"></i> Raporlar</a></li>
                    <li data-roles="admin"><a href="#manage-users" class="menu-item" data-page="manageUsers"><i class="fas fa-users"></i> Kullanıcı Yönetimi</a></li>
                    <li data-roles="admin"><a href="#audit-logs" class="menu-item" data-page="auditLogs"><i class="fas fa-history"></i> Denetim Kayıtları</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    Hoş Geldiniz, <span id="logged-in-user-full-name"></span> (<span id="logged-in-user-role"></span>)
                </div>
                <button id="logout-button" class="btn btn-secondary">Çıkış Yap</button>
                <p class="mt-2">&copy; <span id="current-year"></span> Begeç Asansör</p>
            </div>
        </aside>

        <main id="main-content-wrapper" class="flex flex-col">
            <header id="header">
                <button id="hamburger-menu-button" class="btn btn-primary">☰</button>
                <h1 id="page-title" class="text-2xl font-bold text-gray-800">Dashboard</h1>
                <div></div> </header>

            <section id="page-content" class="flex-grow">
                <div id="dashboard-content" class="page-content">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Dashboard</h2>
                    <div class="dashboard-cards">
                        <div class="card">
                            <h4>Toplam Ürün Çeşidi</h4>
                            <div class="value" id="total-product-types">0</div>
                        </div>
                        <div class="card">
                            <h4>Toplam Stok Miktarı</h4>
                            <div class="value" id="total-stock-quantity">0</div>
                        </div>
                        <div class="card">
                            <h4>Kritik Stoktaki Ürünler</h4>
                            <div class="value critical" id="critical-stock-products">0</div>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-800 mb-3 mt-6">Son Stok Hareketleri</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Sipariş No</th>
                                    <th>Ürün Adı</th>
                                    <th>İşlem Tipi</th>
                                    <th>Miktar</th>
                                    <th>Kullanıcı</th>
                                    <th>Tarih</th>
                                </tr>
                            </thead>
                            <tbody id="latest-transactions-table-body">
                                <tr><td colspan="6" class="text-center">Son hareketler yükleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-800 mb-3 mt-6">Kritik Stok Uyarıları</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ürün Adı</th>
                                    <th>Barkod</th>
                                    <th>Mevcut Stok</th>
                                    <th>Min. Stok Seviyesi</th>
                                    <th>Kategori</th>
                                </tr>
                            </thead>
                            <tbody id="low-stock-products-table-body">
                                <tr><td colspan="5" class="text-center">Kritik stoktaki ürün bulunamadı.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="manage-products-content" class="page-content hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Ürün Yönetimi</h2>

                    <div class="filter-sort-controls">
                        <div class="form-group">
                            <label for="product-search-input">Ürün Ara (Barkod veya Ad)</label>
                            <input type="text" id="product-search-input" placeholder="Barkod veya ürün adı girin...">
                        </div>
                        <div class="form-group">
                            <label for="product-status-filter">Stok Durumu</label>
                            <select id="product-status-filter">
                                <option value="all">Tümü</option>
                                <option value="active">Aktif</option>
                                <option value="inactive">Pasif</option>
                                <option value="critical">Kritik Stok</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="product-category-filter">Kategori</label>
                            <select id="product-category-filter">
                                <option value="">Tümü</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="product-sort-by">Sırala</label>
                            <select id="product-sort-by">
                                <option value="id_asc">ID (Artan)</option>
                                <option value="id_desc">ID (Azalan)</option>
                                <option value="name_asc">Ürün Adı (A-Z)</option>
                                <option value="name_desc">Ürün Adı (Z-A)</option>
                                <option value="barcode_asc">Barkod (A-Z)</option>
                                <option value="barcode_desc">Barkod (Z-A)</option>
                                <option value="stock_asc">Stok (Artan)</option>
                                <option value="stock_desc">Stok (Azalan)</option>
                                <option value="category_name_asc">Kategori (A-Z)</option>
                                <option value="category_name_desc">Kategori (Z-A)</option>
                            </select>
                        </div>
                        <div class="action-buttons">
                            <button id="filter-products-button" class="btn btn-secondary">Filtrele</button>
                            <button id="clear-product-filter-button" class="btn btn-secondary">Filtreyi Temizle</button>
                        </div>
                    </div>
                    <div class="flex justify-end mb-4" data-roles="admin,uretim">
                        <button id="add-new-product-button" class="btn btn-success"><i class="fas fa-plus mr-2"></i> Yeni Ürün Ekle</button>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Barkod</th>
                                    <th>Ürün Adı</th>
                                    <th>Kategori</th>
                                    <th>Stok</th>
                                    <th>Min. Stok</th>
                                    <th>Aktif</th>
                                    <th data-roles="admin,uretim">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="manage-products-table-body">
                                <tr><td colspan="8" class="text-center">Ürünler yükleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination flex justify-center items-center gap-4 mt-6">
                        <button id="prev-product-page-button" class="btn btn-secondary" disabled>Önceki</button>
                        <span>Sayfa <span id="current-product-page">1</span> / <span id="total-product-pages">1</span></span>
                        <button id="next-product-page-button" class="btn btn-secondary">Sonraki</button>
                    </div>
                </div>

                <div id="manage-categories-content" class="page-content hidden">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Kategori Yönetimi</h2>
    
    <div class="form-group mb-4">
        <label for="category-search-input" class="block text-gray-700 font-medium mb-1">Kategori Ara</label>
        <input type="text" id="category-search-input" placeholder="Kategori adında ara..." class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        <div id="category-search-results"></div> 
    </div>

    <div class="flex justify-end mb-4" data-roles="admin">
        <button id="add-new-category-button" class="btn btn-success"><i class="fas fa-plus mr-2"></i> Yeni Kategori Ekle</button>
    </div>

    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Kategori Adı</th>
                    <th>Açıklama</th>
                    <th data-roles="admin">İşlemler</th>
                </tr>
            </thead>
            <tbody id="manage-categories-table-body">
                <tr><td colspan="4" class="text-center">Kategoriler yükleniyor...</td></tr>
            </tbody>
        </table>
    </div>
    <div class="pagination flex justify-center items-center gap-4 mt-6">
        <button id="prev-category-page-button" class="btn btn-secondary" disabled>Önceki</button>
        <span>Sayfa <span id="current-category-page">1</span> / <span id="total-category-pages">1</span></span>
        <button id="next-category-page-button" class="btn btn-secondary">Sonraki</button>
    </div>

    <hr class="my-8 border-gray-300"> 

    <div>
        <h3 class="text-xl font-semibold text-gray-800 mb-4 mt-6">Birim Yönetimi</h3>

        <div class="form-group mb-4">
            <label for="unit-search-input" class="block text-gray-700 font-medium mb-1">Birim Ara</label>
            <input type="text" id="unit-search-input" placeholder="Birim adı veya kısaltmasında ara..." class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            <div id="unit-search-results"></div> 
        </div>

        <div class="flex justify-end mb-4" data-roles="admin">
            <button id="add-new-unit-button" class="btn btn-success"><i class="fas fa-plus mr-2"></i> Yeni Birim Ekle</button>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Birim Adı</th>
                        <th>Kısaltma</th>
                        <th>Oluşturma Tarihi</th>
                        <th data-roles="admin">İşlemler</th>
                    </tr>
                </thead>
                <tbody id="manage-units-table-body">
                    <tr><td colspan="5" class="text-center">Birimler yükleniyor...</td></tr>
                </tbody>
            </table>
        </div>
        <div class="pagination flex justify-center items-center gap-4 mt-6">
            <button id="prev-unit-page-button" class="btn btn-secondary" disabled>Önceki</button>
            <span>Sayfa <span id="current-unit-page">1</span> / <span id="total-unit-pages">1</span></span>
            <button id="next-unit-page-button" class="btn btn-secondary">Sonraki</button>
        </div>
    </div>
</div>

                <div id="stock-in-content" class="page-content hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Mal Kabul (Stok Girişi)</h2>
                    <div class="stock-operation-section">
                        <div class="input-area relative">
                            <label for="stock-in-product-search-input" class="block text-gray-700 font-medium mb-2">Ürün Okut / Ara</label>
                            <input type="text" id="stock-in-product-search-input" placeholder="Barkod okutun veya ürün adı girin..." autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg text-lg">
                            <div id="stock-in-search-results" class="search-results"></div>
                        </div>

                        <div class="product-info-area">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Seçilen Ürün Bilgileri</h3>
                            <div id="stock-in-selected-product-info">
                                <p class="text-gray-600">Lütfen bir ürün seçin veya barkod okutun.</p>
                            </div>
                        </div>

                        <div class="transaction-details-area">
    <h3 class="text-lg font-semibold text-gray-800 mb-3">İşlem Detayları</h3>
    <div class="form-group">
    <label for="stock-in-company-input" class="block text-gray-700 font-medium mb-2">Firma Seçimi</label>
    <div class="relative">
        <input type="text" id="stock-in-company-input" placeholder="Firma adı yazın veya 'Kendi Üretimimiz' seçin..." required>
        <input type="hidden" id="stock-in-company-id">
        <div id="stock-in-company-results" class="search-results"></div>
    </div>
</div>
    <div class="form-group">
        <label for="stock-in-quantity-input" class="block text-gray-700 font-medium mb-2">Miktar</label>
                                <div class="quantity-controls">
                                    <button type="button" id="stock-in-quantity-minus-button" class="btn">-</button>
                                    <input type="number" id="stock-in-quantity-input" value="1" min="1" required class="text-center">
                                    <button type="button" id="stock-in-quantity-plus-button" class="btn">+</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="stock-in-notes-input" class="block text-gray-700 font-medium mb-2">Notlar (Opsiyonel)</label>
                                <textarea id="stock-in-notes-input" rows="2" placeholder="Üretim partisi, irsaliye no vb."></textarea>
                            </div>
                            <button id="process-stock-in-button" class="btn btn-success btn-process" disabled><i class="fas fa-plus-circle mr-2"></i> Stoğa Ekle</button>
                        </div>

                        <div class="recent-transactions-area">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Son Stok Girişleri</h3>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Sipariş No</th>
                                            <th>Ürün Adı</th>
                                            <th>Miktar</th>
                                            <th>Tarih</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stock-in-recent-transactions-table-body">
                                        <tr><td colspan="4" class="text-center">Son girişler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="stock-out-content" class="page-content hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Sevkiyat Hazırlık (Stok Çıkışı)</h2>
                    <div class="stock-operation-section">
                        <div class="input-area relative">
                            <label for="stock-out-product-search-input" class="block text-gray-700 font-medium mb-2">Ürün Okut / Ara</label>
                            <input type="text" id="stock-out-product-search-input" placeholder="Barkod okutun veya ürün adı girin..." autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg text-lg">
                            <div id="stock-out-search-results" class="search-results"></div>
                        </div>

                        <div class="product-info-area">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Seçilen Ürün Bilgileri</h3>
                            <div id="stock-out-selected-product-info">
                                <p class="text-gray-600">Lütfen bir ürün seçin veya barkod okutun.</p>
                            </div>
                        </div>

                        <div class="transaction-details-area">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">İşlem Detayları</h3>
                            <div class="form-group">
    <label for="stock-out-company-input" class="block text-gray-700 font-medium mb-2">Firma Seçimi</label>
    <div class="relative">
        <input type="text" id="stock-out-company-input" placeholder="Firma adı yazın veya 'Kendi Üretimimiz' seçin..." required>
        <input type="hidden" id="stock-out-company-id">
        <div id="stock-out-company-results" class="search-results"></div>
    </div>
</div>
                            <div class="form-group">
                                <label for="stock-out-quantity-input" class="block text-gray-700 font-medium mb-2">Miktar</label>
                                <div class="quantity-controls">
                                    <button type="button" id="stock-out-quantity-minus-button" class="btn">-</button>
                                    <input type="number" id="stock-out-quantity-input" value="1" min="1" required class="text-center">
                                    <button type="button" id="stock-out-quantity-plus-button" class="btn">+</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="stock-out-notes-input" class="block text-gray-700 font-medium mb-2">Notlar (Opsiyonel)</label>
                                <textarea id="stock-out-notes-input" rows="2" placeholder="İrsaliye no, sevkiyat bilgisi vb."></textarea>
                            </div>
                            <button id="process-stock-out-button" class="btn btn-primary btn-process" disabled><i class="fas fa-truck mr-2"></i> Stoktan Düş / Sevket</button>
                        </div>

                        <div class="recent-transactions-area">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Son Stok Çıkışları</h3>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Sipariş No</th>
                                            <th>Ürün Adı</th>
                                            <th>Miktar</th>
                                            <th>Firma</th>
                                            <th>Tarih</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stock-out-recent-transactions-table-body">
                                        <tr><td colspan="5" class="text-center">Son çıkışlar yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="stock-adjustment-content" class="page-content hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Envanter Sayım / Düzeltme</h2>
                    <div class="stock-operation-section">
                        <div class="input-area relative">
                            <label for="stock-adjustment-product-search-input" class="block text-gray-700 font-medium mb-2">Ürün Okut / Ara</label>
                            <input type="text" id="stock-adjustment-product-search-input" placeholder="Barkod okutun veya ürün adı girin..." autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg text-lg">
                            <div id="stock-adjustment-search-results" class="search-results"></div>
                        </div>

                        <div class="product-info-area">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Seçilen Ürün Bilgileri</h3>
                            <div id="stock-adjustment-selected-product-info">
                                <p class="text-gray-600">Lütfen bir ürün seçin veya barkod okutun.</p>
                            </div>
                        </div>

                        <div class="transaction-details-area">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Düzeltme Detayları</h3>
                            <div class="form-group">
                                <label for="stock-adjustment-current-stock-display" class="block text-gray-700 font-medium mb-2">Mevcut Stok</label>
                                <input type="number" id="stock-adjustment-current-stock-display" readonly placeholder="Otomatik dolar" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed">
                            </div>
                            <div class="form-group">
                                <label for="stock-adjustment-new-quantity-input" class="block text-gray-700 font-medium mb-2">Yeni Stok Miktarı (Sayım Sonucu)</label>
                                <input type="number" id="stock-adjustment-new-quantity-input" value="0" min="0" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="form-group">
                                <label for="stock-adjustment-notes-input" class="block text-gray-700 font-medium mb-2">Notlar (Zorunlu)</label>
                                <textarea id="stock-adjustment-notes-input" rows="2" placeholder="Düzeltme nedeni (örn: sayım farkı, kırık ürün)" required></textarea>
                            </div>
                            <button id="process-stock-adjustment-button" class="btn btn-info btn-process" disabled><i class="fas fa-sync-alt mr-2"></i> Stok Düzelt</button>
                        </div>

                        <div class="recent-transactions-area">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Son Stok Düzeltmeleri</h3>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Sipariş No</th>
                                            <th>Ürün Adı</th>
                                            <th>Eski Stok</th>
                                            <th>Yeni Stok</th>
                                            <th>Fark</th>
                                            <th>Tarih</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stock-adjustment-recent-transactions-table-body">
                                        <tr><td colspan="6" class="text-center">Son düzeltmeler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                


                <div id="production-in-content" class="page-content hidden">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Üretim Tamamlama</h2>
    <div class="stock-operation-section">
        <div class="input-area relative">
            <label for="production-in-product-search-input" class="block text-gray-700 font-medium mb-2">Ürün Ara (Bitmiş Ürün/Yarı Mamul)</label>
            <input type="text" id="production-in-product-search-input" placeholder="Üretimi tamamlanan ürün ara..." autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg text-lg">
            <div id="production-in-search-results" class="search-results"></div>
        </div>

        <div class="product-info-area">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Seçilen Ürün Bilgileri</h3>
            <div id="production-in-selected-product-info">
                <p class="text-gray-600">Lütfen bir ürün seçin veya arayın.</p>
            </div>
        </div>

        <div id="bom-preview-area" class="transaction-details-area hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Reçete Önizleme</h3>
            <div class="form-group">
                <label for="production-in-quantity-input" class="block text-gray-700 font-medium mb-2">Üretim Miktarı</label>
                <div class="quantity-controls">
                    <button type="button" id="production-in-quantity-minus-button" class="btn">-</button>
                    <input type="number" id="production-in-quantity-input" value="1" min="1" required class="text-center">
                    <button type="button" id="production-in-quantity-plus-button" class="btn">+</button>
                </div>
            </div>
            <div id="bom-preview-table-container" class="mb-4">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Gerekli Hammadde</th>
                            <th>Gereken Miktar</th>
                            <th>Mevcut Stok</th>
                            <th>Durum</th>
                        </tr>
                    </thead>
                    <tbody id="bom-preview-table-body">
                        <tr><td colspan="4" class="text-center">Reçete bilgisi yükleniyor...</td></tr>
                    </tbody>
                </table>
            </div>
            <div id="bom-validation-message" class="mb-4"></div>
        </div>

        <div class="transaction-details-area">
            <div class="form-group">
                <label for="production-in-notes-input" class="block text-gray-700 font-medium mb-2">Notlar (Opsiyonel)</label>
                <textarea id="production-in-notes-input" rows="2" placeholder="Üretim partisi, kalite kontrol notları vb."></textarea>
            </div>
            <button id="process-production-in-button" class="btn btn-success btn-process" disabled><i class="fas fa-industry mr-2"></i> Üretimi Tamamla</button>
        </div>

        <div class="recent-transactions-area">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Son Üretim Tamamlamalar</h3>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>İşlem Kodu</th>
                            <th>Ürün Adı</th>
                            <th>Miktar</th>
                            <th>Tarih</th>
                        </tr>
                    </thead>
                    <tbody id="production-in-recent-transactions-table-body">
                        <tr><td colspan="4" class="text-center">Son üretimler yükleniyor...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>





                <div id="purchase-in-content" class="page-content hidden">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Satın Alma Girişi</h2>
    <div class="stock-operation-section">
        <div class="input-area relative">
            <label for="purchase-in-product-search-input" class="block text-gray-700 font-medium mb-2">Ürün Ara (Hammadde/Yarı Mamul)</label>
            <input type="text" id="purchase-in-product-search-input" placeholder="Hammadde veya yarı mamul ara..." autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg text-lg">
            <div id="purchase-in-search-results" class="search-results"></div>
        </div>

        <div class="product-info-area">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Seçilen Ürün Bilgileri</h3>
            <div id="purchase-in-selected-product-info">
                <p class="text-gray-600">Lütfen bir ürün seçin veya arayın.</p>
            </div>
        </div>

        <div class="transaction-details-area">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">İşlem Detayları</h3>
            <div class="form-group">
                <label for="purchase-in-company-input" class="block text-gray-700 font-medium mb-2">Tedarikçi Firma Seçimi <span class="text-red-500">*</span></label>
                <div class="relative">
                    <input type="text" id="purchase-in-company-input" placeholder="Tedarikçi firma adı yazın..." required>
                    <input type="hidden" id="purchase-in-company-id">
                    <div id="purchase-in-company-results" class="search-results"></div>
                </div>
            </div>
            <div class="form-group">
                <label for="purchase-in-quantity-input" class="block text-gray-700 font-medium mb-2">Miktar</label>
                <div class="quantity-controls">
                    <button type="button" id="purchase-in-quantity-minus-button" class="btn">-</button>
                    <input type="number" id="purchase-in-quantity-input" value="1" min="1" required class="text-center">
                    <button type="button" id="purchase-in-quantity-plus-button" class="btn">+</button>
                </div>
            </div>
            <div class="form-group">
                <label for="purchase-in-notes-input" class="block text-gray-700 font-medium mb-2">Notlar (Opsiyonel)</label>
                <textarea id="purchase-in-notes-input" rows="2" placeholder="İrsaliye no, lot bilgisi vb."></textarea>
            </div>
            <button id="process-purchase-in-button" class="btn btn-success btn-process" disabled><i class="fas fa-plus-circle mr-2"></i> Satın Almayı Tamamla</button>
        </div>

        <div class="recent-transactions-area">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Son Satın Alma Girişleri</h3>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>İşlem Kodu</th>
                            <th>Ürün Adı</th>
                            <th>Miktar</th>
                            <th>Tedarikçi</th>
                            <th>Tarih</th>
                        </tr>
                    </thead>
                    <tbody id="purchase-in-recent-transactions-table-body">
                        <tr><td colspan="5" class="text-center">Son girişler yükleniyor...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>



                <div id="manage-companies-content" class="page-content hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Firma Yönetimi</h2>
                    <div class="flex justify-end mb-4" data-roles="admin">
                        <button id="add-new-company-button" class="btn btn-success"><i class="fas fa-plus mr-2"></i> Yeni Firma Ekle</button>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Firma Adı</th>
                                    <th>İlgili Kişi</th>
                                    <th>Telefon</th>
                                    <th>Adres</th>
                                    <th>Vergi Dairesi</th>
                                    <th>Vergi No</th>
                                    <th>Tipi</th>
                                    <th>Oluşturma Tarihi</th>
                                    <th data-roles="admin">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="manage-companies-table-body">
                                <tr><td colspan="10" class="text-center">Firmalar yükleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination flex justify-center items-center gap-4 mt-6">
                        <button id="prev-company-page-button" class="btn btn-secondary" disabled>Önceki</button>
                        <span>Sayfa <span id="current-company-page">1</span> / <span id="total-company-pages">1</span></span>
                        <button id="next-company-page-button" class="btn btn-secondary">Sonraki</button>
                    </div>
                </div>

                <div id="company-detail-content" class="page-content hidden">
                    <div class="company-detail-header">
                        <button id="back-to-companies-button" class="btn btn-secondary mb-4"><i class="fas fa-arrow-left mr-2"></i> Firmalar Listesine Dön</button>
                        <h2 id="company-detail-name" class="text-3xl font-bold text-gray-800">Firma Adı Yükleniyor...</h2>
                        <p><strong>İlgili Kişi:</strong> <span id="company-detail-contact-person">-</span></p>
                        <p><strong>Telefon:</strong> <span id="company-detail-phone">-</span></p>
                        <p><strong>Adres:</strong> <span id="company-detail-address">-</span></p>
                        <p><strong>Vergi Dairesi:</strong> <span id="company-detail-tax-office">-</span></p>
                        <p><strong>Vergi Numarası:</strong> <span id="company-detail-tax-number">-</span></p>
                        <p><strong>Firma Tipi:</strong> <span id="company-detail-type">-</span></p>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Firma Hareketleri</h3>
                    <div class="filter-sort-controls">
    <div class="form-group">
        <label for="company-report-global-search">Genel Arama:</label>
        <input type="text" id="company-report-global-search" placeholder="İşlem kodu, notlar, ürün adında ara...">
    </div>
    <div class="form-group">
        <label for="company-report-start-date">Başlangıç Tarihi:</label>
        <input type="date" id="company-report-start-date">
    </div>
                        <div class="form-group">
                            <label for="company-report-end-date">Bitiş Tarihi:</label>
                            <input type="date" id="company-report-end-date">
                        </div>
                        <div class="form-group">
                            <label for="company-report-product-filter">Ürün:</label>
                            <select id="company-report-product-filter">
                                <option value="">Tümü</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="company-report-transaction-type-filter">İşlem Tipi:</label>
                            <select id="company-report-transaction-type-filter">
                                <option value="">Tümü</option>
                                <option value="in">Giriş</option>
                                <option value="out">Çıkış</option>
                                <option value="adjustment">Düzeltme</option>
                            </select>
                        </div>
                        <div class="action-buttons">
    <button id="filter-company-reports-button" class="btn btn-secondary">Filtrele</button>
    <button id="clear-company-report-filter-button" class="btn btn-secondary">Filtreyi Temizle</button>
    <button id="export-company-transactions-csv-button" class="btn btn-info"><i class="fas fa-file-csv mr-2"></i> CSV İndir</button>
    <button id="export-company-transactions-pdf-button" class="btn btn-danger"><i class="fas fa-file-pdf mr-2"></i> PDF İndir</button>
</div>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Sipariş No</th>
                                    <th>Ürün Adı</th>
                                    <th>Kategori</th>
                                    <th>Barkod</th>
                                    <th>İşlem Tipi</th>
                                    <th>Miktar</th>
                                    <th>Kullanıcı</th>
                                    <th>Tarih ve Saat</th>
                                    <th>Notlar</th>
                                </tr>
                            </thead>
                            <tbody id="company-transactions-table-body">
                                <tr><td colspan="9" class="text-center">Firma hareketleri yükleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination flex justify-center items-center gap-4 mt-6">
                        <button id="prev-company-report-page-button" class="btn btn-secondary" disabled>Önceki</button>
                        <span>Sayfa <span id="current-company-report-page">1</span> / <span id="total-company-report-pages">1</span></span>
                        <button id="next-company-report-page-button" class="btn btn-secondary">Sonraki</button>
                    </div>
                </div>

                <div id="reports-content" class="page-content hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Raporlar</h2>
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Tüm Stok Hareketleri</h3>
                    <div class="filter-sort-controls">
    <div class="form-group">
        <label for="report-global-search">Genel Arama:</label>
        <input type="text" id="report-global-search" placeholder="İşlem kodu, notlar, firma adı, kullanıcı adında ara...">
    </div>
    <div class="form-group">
        <label for="report-start-date">Başlangıç Tarihi:</label>
        <input type="date" id="report-start-date">
    </div>
                        <div class="form-group">
                            <label for="report-end-date">Bitiş Tarihi:</label>
                            <input type="date" id="report-end-date">
                        </div>
                        <div class="form-group">
                            <label for="report-product-filter">Ürün:</label>
                            <select id="report-product-filter">
                                <option value="">Tümü</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="report-category-filter">Kategori:</label>
                            <select id="report-category-filter">
                                <option value="">Tümü</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="report-company-filter">Firma:</label>
                            <select id="report-company-filter">
                                <option value="">Tümü</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="report-transaction-type-filter">İşlem Tipi:</label>
                            <select id="report-transaction-type-filter">
                                <option value="">Tümü</option>
                                <option value="in">Giriş</option>
                                <option value="out">Çıkış</option>
                                <option value="adjustment">Düzeltme</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="report-user-filter">Kullanıcı:</label>
                            <select id="report-user-filter">
                                <option value="">Tümü</option>
                            </select>
                        </div>
                        <div class="action-buttons">
    <button id="filter-reports-button" class="btn btn-secondary">Filtrele</button>
    <button id="barcode-search-reports-button" class="btn btn-info">🔍 Barkod Ara</button>
    <button id="clear-reports-filter-button" class="btn btn-secondary">Filtreyi Temizle</button>
    <button id="quick-filter-today" class="btn btn-outline">Bugün</button>
    <button id="quick-filter-week" class="btn btn-outline">Bu Hafta</button>
    <button id="quick-filter-month" class="btn btn-outline">Bu Ay</button>
    <button id="export-transactions-csv-button" class="btn btn-info"><i class="fas fa-file-csv mr-2"></i> CSV İndir</button>
    <button id="export-transactions-pdf-button" class="btn btn-danger"><i class="fas fa-file-pdf mr-2"></i> PDF İndir</button>
</div>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Sipariş No</th>
                                    <th>Ürün Adı</th>
                                    <th>Barkod</th>
                                    <th>Kategori</th>
                                    <th>İşlem Tipi</th>
                                    <th>Miktar</th>
                                    <th>Firma Adı</th>
                                    <th>Kullanıcı</th>
                                    <th>Tarih ve Saat</th>
                                    <th>Notlar</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table-body">
                                <tr><td colspan="10" class="text-center">Hareketler yükleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination flex justify-center items-center gap-4 mt-6">
                        <button id="prev-report-page-button" class="btn btn-secondary" disabled>Önceki</button>
                        <span>Sayfa <span id="current-report-page">1</span> / <span id="total-report-pages">1</span></span>
                        <button id="next-report-page-button" class="btn btn-secondary">Sonraki</button>
                    </div>
                </div>

                <div id="manage-users-content" class="page-content hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Kullanıcı Yönetimi</h2>
                    <div class="flex justify-end mb-4" data-roles="admin">
                        <button id="add-new-user-button" class="btn btn-success"><i class="fas fa-plus mr-2"></i> Yeni Kullanıcı Ekle</button>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Kullanıcı Adı</th>
                                    <th>Tam Adı</th>
                                    <th>Rol</th>
                                    <th>Aktif</th>
                                    <th>Oluşturma Tarihi</th>
                                    <th>Son Giriş</th>
                                    <th data-roles="admin">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="manage-users-table-body">
                                <tr><td colspan="8" class="text-center">Kullanıcılar yükleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination flex justify-center items-center gap-4 mt-6">
                        <button id="prev-user-page-button" class="btn btn-secondary" disabled>Önceki</button>
                        <span>Sayfa <span id="current-user-page">1</span> / <span id="total-user-pages">1</span></span>
                        <button id="next-user-page-button" class="btn btn-secondary">Sonraki</button>
                    </div>
                </div>

                <div id="audit-logs-content" class="page-content hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Denetim Kayıtları</h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Kullanıcı</th>
                                    <th>İşlem Tipi</th>
                                    <th>Tablo</th>
                                    <th>Kayıt ID</th>
                                    <th>Eski Değer</th>
                                    <th>Yeni Değer</th>
                                    <th>Zaman Damgası</th>
                                </tr>
                            </thead>
                            <tbody id="audit-logs-table-body">
                                <tr><td colspan="8" class="text-center">Denetim kayıtları yükleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination flex justify-center items-center gap-4 mt-6">
                        <button id="prev-audit-log-page-button" class="btn btn-secondary" disabled>Önceki</button>
                        <span>Sayfa <span id="current-audit-log-page">1</span> / <span id="total-audit-log-pages">1</span></span>
                        <button id="next-audit-log-page-button" class="btn btn-secondary">Sonraki</button>
                    </div>
                </div>
<!-- BOM Management Content -->
                <div id="manage-bom-content" class="page-content hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Ürün Reçetesi Yönetimi</h2>
                    
                    <!-- Bitmiş Ürün Seçim Alanı -->
                    <div class="bg-white p-6 rounded-lg shadow-sm mb-6 relative"> 
    <label for="bom-finished-product-search" class="block text-sm font-medium text-gray-700 mb-2">
        Reçetesini Yönetmek İstediğiniz Ürün
    </label>
    <input type="text" id="bom-finished-product-search" placeholder="Bitmiş ürün veya yarı mamul ara..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
    <div id="bom-finished-product-results" class="search-results hidden bg-white border border-gray-300 rounded-md mt-1 max-h-60 overflow-y-auto z-20 absolute w-full left-0"></div>
    
    <input type="hidden" id="bom-finished-product-selected-id">
    
</div>

                    <!-- Seçili Ürün Reçete Görüntüleme Alanı -->
                    <div id="bom-display-area" class="hidden">
                        <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 id="bom-title" class="text-lg font-semibold text-gray-900"></h3>
                                <div class="text-sm text-gray-600">
                                    <span id="bom-items-count">0</span> bileşen
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table id="bom-items-table" class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Hammadde/Yarı Mamul Adı</th>
                                            <th>Barkod</th>
                                            <th>Gerekli Miktar</th>
                                            <th>Ölçü Birimi</th>
                                            <th>İşlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bom-items-table-body">
                                        <tr><td colspan="5" class="text-center text-gray-500">Reçete bilgisi yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Yeni Bileşen Ekleme Formu -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h4 class="text-md font-semibold text-gray-900 mb-4">Reçeteye Yeni Bileşen Ekle</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="form-group">
                                    <label for="bom-raw-material-select" class="block text-sm font-medium text-gray-700 mb-2">Hammadde/Yarı Mamul</label>
                                    <input type="text" id="bom-raw-material-search" placeholder="Hammadde/Yarı mamul ara..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
<div id="bom-raw-material-results" class="search-results hidden bg-white border border-gray-300 rounded-md mt-1 max-h-60 overflow-y-auto z-10 absolute w-full"></div>
<input type="hidden" id="bom-raw-material-selected-id">
                                        <option value="">Bileşen Seçiniz...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="bom-quantity-required-input" class="block text-sm font-medium text-gray-700 mb-2">Gerekli Miktar</label>
                                    <input type="number" id="bom-quantity-required-input" min="0.0001" step="0.0001" placeholder="Miktar" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                                </div>
                                <div class="form-group flex items-end">
                                    <button id="add-to-bom-button" class="btn btn-success w-full" disabled>
                                        <i class="fas fa-plus mr-2"></i> Reçeteye Ekle
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="product-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="product-modal-title">Ürün Ekle/Düzenle</h3>
                <button class="modal-close-button" data-modal-close="product-modal">&times;</button>
            </div>
            <form id="product-modal-form">
                <input type="hidden" id="modal-product-id">
                <div class="form-group">
                    <label for="modal-product-barcode">Barkod</label>
                    <input type="text" id="modal-product-barcode" required>
                </div>
                <div class="form-group">
                    <label for="modal-product-name">Ürün Adı</label>
                    <input type="text" id="modal-product-name" required>
                </div>
                <div class="form-group">
                    <label for="modal-product-category">Kategori</label>
                    <select id="modal-product-category">
                        <option value="">Kategori Seçiniz</option>
                        </select>
                </div>
                <div class="form-group">
                    <label for="modal-product-type">Ürün Tipi</label>
                    <select id="modal-product-type" required>
                        <option value="BITMIS_URUN">Bitmiş Ürün</option>
                        <option value="YARI_MAMUL">Yarı Mamul</option>
                        <option value="HAMMADDE">Hammadde</option>
                    </select>
                </div>
                <div class="form-group">
    <label for="modal-product-unit-of-measure">Ölçü Birimi</label>
    <select id="modal-product-unit-of-measure" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        <option value="adet">Adet</option>
        <option value="kg">Kilogram (kg)</option>
        <option value="gr">Gram (gr)</option>
        <option value="mt">Metre (mt)</option>
        <option value="cm">Santimetre (cm)</option>
        <option value="m²">Metrekare (m²)</option>
        <option value="m³">Metreküp (m³)</option>
        <option value="lt">Litre (lt)</option>
        <option value="ton">Ton</option>
        <option value="koli">Koli</option>
        <option value="paket">Paket</option>
        <option value="set">Set</option>
        </select>
</div>
                <div class="form-group">
                    <label for="modal-product-stock">Stok Miktarı</label>
                    <input type="number" id="modal-product-stock" min="0" required>
                </div>
                <div class="form-group">
                    <label for="modal-product-min-stock-level">Minimum Stok Seviyesi (Uyarı Eşiği)</label>
                    <input type="number" id="modal-product-min-stock-level" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="modal-product-is-active">Aktif</label>
                    <select id="modal-product-is-active">
                        <option value="true">Evet</option>
                        <option value="false">Hayır</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                    <button type="button" class="btn btn-secondary" data-modal-close="product-modal">İptal</button>
                </div>
            </form>
        </div>
    </div>

    <div id="category-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="category-modal-title">Kategori Ekle/Düzenle</h3>
                <button class="modal-close-button" data-modal-close="category-modal">&times;</button>
            </div>
            <form id="category-modal-form">
                <input type="hidden" id="modal-category-id">
                <div class="form-group">
                    <label for="modal-category-name">Kategori Adı</label>
                    <input type="text" id="modal-category-name" required>
                </div>
                <div class="form-group">
                    <label for="modal-category-description">Açıklama (Opsiyonel)</label>
                    <textarea id="modal-category-description" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                    <button type="button" class="btn btn-secondary" data-modal-close="category-modal">İptal</button>
                </div>
            </form>
        </div>
    </div>

    <div id="company-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="company-modal-title">Firma Ekle/Düzenle</h3>
                <button class="modal-close-button" data-modal-close="company-modal">&times;</button>
            </div>
            <form id="company-modal-form">
                <input type="hidden" id="modal-company-id">
                <div class="form-group">
                    <label for="modal-company-name">Firma Adı</label>
                    <input type="text" id="modal-company-name" required>
                </div>
                <div class="form-group">
                    <label for="modal-company-contact-person">İlgili Kişi</label>
                    <input type="text" id="modal-company-contact-person">
                </div>
                <div class="form-group">
                    <label for="modal-company-phone">Telefon</label>
                    <input type="text" id="modal-company-phone">
                </div>
                <div class="form-group">
                    <label for="modal-company-address">Adres</label>
                    <textarea id="modal-company-address" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="modal-company-tax-office">Vergi Dairesi</label>
                    <input type="text" id="modal-company-tax-office">
                </div>
                <div class="form-group">
                    <label for="modal-company-tax-number">Vergi Numarası</label>
                    <input type="text" id="modal-company-tax-number">
                </div>
                <div class="form-group">
                    <label for="modal-company-type">Firma Tipi</label>
                    <select id="modal-company-type" required>
                        <option value="both">Müşter & Tedarikçi</option>
                        <option value="customer">Müşteri</option>
                        <option value="supplier">Tedarikçi</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                    <button type="button" class="btn btn-secondary" data-modal-close="company-modal">İptal</button>
                </div>
            </form>
        </div>
    </div>

    <div id="user-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="user-modal-title">Kullanıcı Ekle/Düzenle</h3>
                <button class="modal-close-button" data-modal-close="user-modal">&times;</button>
            </div>
            <form id="user-modal-form">
                <input type="hidden" id="modal-user-id">
                <div class="form-group">
                    <label for="modal-user-username">Kullanıcı Adı</label>
                    <input type="text" id="modal-user-username" required>
                </div>
                <div class="form-group">
                    <label for="modal-user-password">Şifre (Değiştirmek istemiyorsanız boş bırakın)</label>
                    <input type="password" id="modal-user-password">
                </div>
                <div class="form-group">
                    <label for="modal-user-full-name">Tam Adı</label>
                    <input type="text" id="modal-user-full-name" required>
                </div>
                <div class="form-group">
                    <label for="modal-user-role">Rol</label>
                    <select id="modal-user-role" required>
                        <option value="admin">Admin</option>
                        <option value="uretim">Üretim</option>
                        <option value="sevkiyat">Sevkiyat</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modal-user-is-active">Aktif</label>
                    <select id="modal-user-is-active">
                        <option value="true">Evet</option>
                        <option value="false">Hayır</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                    <button type="button" class="btn btn-secondary" data-modal-close="user-modal">İptal</button>
                </div>
            </form>
        </div>
    </div>


    <div id="unit-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="unit-modal-title">Birim Ekle/Düzenle</h3>
                <button class="modal-close-button" data-modal-close="unit-modal">&times;</button>
            </div>
            <form id="unit-modal-form">
                <input type="hidden" id="modal-unit-id">
                <div class="form-group">
                    <label for="modal-unit-name">Birim Adı</label>
                    <input type="text" id="modal-unit-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="form-group">
                    <label for="modal-unit-abbreviation">Kısaltma</label>
                    <input type="text" id="modal-unit-abbreviation" required placeholder="Örn: kg, adet, mt" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                    <button type="button" class="btn btn-secondary" data-modal-close="unit-modal">İptal</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // JavaScript kodunuz burada başlar
        // ...
    </script>
</body>
</html>



    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Onay</h3>
            <p id="confirm-message" class="text-gray-700 mb-6">Emin misiniz?</p>
            <div class="modal-actions justify-center">
                <button id="confirm-yes-button" class="btn btn-danger">Evet</button>
                <button id="confirm-no-button" class="btn btn-secondary">Hayır</button>
            </div>
        </div>
    </div>


    
    <script>
        // API URL'si
        // Telefonunuzdan veya diğer cihazlardan erişim için burayı bilgisayarınızın IP adresiyle güncelleyin.
        // Örn: 'http://192.168.1.100:3000/api';
        const API_URL = 'http://192.168.0.218:3000/api'; // BURAYI KENDİ IP ADRESİNİZLE DEĞİŞTİRMEYİ UNUTMAYIN!

        // DOM Elementleri Referansları
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loggedInUserFullNameSpan = document.getElementById('logged-in-user-full-name');
        const loggedInUserRoleSpan = document.getElementById('logged-in-user-role');
        const logoutButton = document.getElementById('logout-button');
        const currentYearSpan = document.getElementById('current-year');
        
        //Sayfadaki urun sayisini guncelleme cikti sayfa alti sonu altta altindaki vs
        const RECENT_TRANSACTIONS_LIMIT = 5; // Göstermek istediğiniz son hareket sayısı

        
        // Kategori Yönetimi için Arama Inputu (YENİ)
        const categorySearchInput = document.getElementById('category-search-input');

        // Birim Yönetimi Elementleri (YENİ)
        const manageUnitsContent = document.getElementById('manage-units-content'); // Bu ID'yi HTML'de kullanmadık, doğrudan manage-categories-content içinde. Bu satır gereksiz olabilir.
        const unitSearchInput = document.getElementById('unit-search-input');
        const addNewUnitButton = document.getElementById('add-new-unit-button');
        const manageUnitsTableBody = document.getElementById('manage-units-table-body');
        const prevUnitPageButton = document.getElementById('prev-unit-page-button');
        const nextUnitPageButton = document.getElementById('next-unit-page-button');
        const currentUnitPageSpan = document.getElementById('current-unit-page');
        const totalUnitPagesSpan = document.getElementById('total-unit-pages');
        let currentUnitPage = 1;
        const unitsPerPage = 3; // Sayfa başına birim sayısı, istediğiniz gibi ayarlayın

        // Birim Modalı Elementleri (YENİ)
        const unitModal = document.getElementById('unit-modal');
        const unitModalForm = document.getElementById('unit-modal-form');
        const modalUnitId = document.getElementById('modal-unit-id');
        const modalUnitName = document.getElementById('modal-unit-name');
        const modalUnitAbbreviation = document.getElementById('modal-unit-abbreviation');


        const sidebarDiv = document.getElementById('sidebar');
        const mainContentWrapperDiv = document.getElementById('main-content-wrapper');
        const hamburgerMenuButton = document.getElementById('hamburger-menu-button');
        const pageTitle = document.getElementById('page-title');
        const pageContent = document.getElementById('page-content');
        const messageBox = document.getElementById('message-box'); // Toast mesajları için container

        // İçerik Bölümleri
        const dashboardContent = document.getElementById('dashboard-content');
        const manageProductsContent = document.getElementById('manage-products-content');
        const manageCategoriesContent = document.getElementById('manage-categories-content');
        const manageCompaniesContent = document.getElementById('manage-companies-content');
        const companyDetailContent = document.getElementById('company-detail-content');
        const reportsContent = document.getElementById('reports-content');
        const manageUsersContent = document.getElementById('manage-users-content');
        const auditLogsContent = document.getElementById('audit-logs-content');
        const manageBomContent = document.getElementById('manage-bom-content');

        const bomRawMaterialSearchInput = document.getElementById('bom-raw-material-search');         // <<< BU TANIMLAMA ÖNEMLİ
        const bomRawMaterialResultsDiv = document.getElementById('bom-raw-material-results');       // <<< BU TANIMLAMA ÖNEMLİ
        const bomRawMaterialSelectedIdInput = document.getElementById('bom-raw-material-selected-id'); // <<< BU TANIMLAMA ÖNEMLİ

        // BOM Yönetimi Elementleri
        //const bomFinishedProductSelect = document.getElementById('bom-finished-product-select');
        const bomFinishedProductSearchInput = document.getElementById('bom-finished-product-search');
        const bomFinishedProductResultsDiv = document.getElementById('bom-finished-product-results');
        const bomFinishedProductSelectedIdInput = document.getElementById('bom-finished-product-selected-id'); // Bu aslında selectedFinishedProductId global değişkeniyle yönetilecek.

        const bomDisplayArea = document.getElementById('bom-display-area');
        const bomTitle = document.getElementById('bom-title');
        const bomItemsCount = document.getElementById('bom-items-count');
        const bomItemsTableBody = document.getElementById('bom-items-table-body');
        //const bomRawMaterialSelect = document.getElementById('bom-raw-material-select');
        const bomQuantityRequiredInput = document.getElementById('bom-quantity-required-input');
        const addToBomButton = document.getElementById('add-to-bom-button');
        let selectedFinishedProductId = null; // Seçilen bitmiş ürünün ID'si
        const stockInContent = document.getElementById('stock-in-content');
        const stockOutContent = document.getElementById('stock-out-content');
        const stockAdjustmentContent = document.getElementById('stock-adjustment-content');

        // Dashboard Elementleri
        const totalProductTypesSpan = document.getElementById('total-product-types');
        const totalStockQuantitySpan = document.getElementById('total-stock-quantity');
        const criticalStockProductsSpan = document.getElementById('critical-stock-products');
        const latestTransactionsTableBody = document.getElementById('latest-transactions-table-body');
        const lowStockProductsTableBody = document.getElementById('low-stock-products-table-body');

        // Ürün Yönetimi Elementleri
        const manageProductsTableBody = document.getElementById('manage-products-table-body');
        const productSearchInput = document.getElementById('product-search-input');
        const productStatusFilterSelect = document.getElementById('product-status-filter');
        const productCategoryFilterSelect = document.getElementById('product-category-filter');
        console.log('Debug - productCategoryFilterSelect (tanımlama sonrası):', productCategoryFilterSelect); // YENİ LOG
        const productSortBySelect = document.getElementById('product-sort-by'); // Yeni
        const filterProductsButton = document.getElementById('filter-products-button');
        const clearProductFilterButton = document.getElementById('clear-product-filter-button');
        const addNewProductButton = document.getElementById('add-new-product-button');
        const prevProductPageButton = document.getElementById('prev-product-page-button');
        const nextProductPageButton = document.getElementById('next-product-page-button');
        const currentProductPageSpan = document.getElementById('current-product-page');
        const totalProductPagesSpan = document.getElementById('total-product-pages');
        let currentProductPage = 1;
        const productsPerPage = 10;
        


        // Kategori Yönetimi Elementleri
        const manageCategoriesTableBody = document.getElementById('manage-categories-table-body');
        const addNewCategoryButton = document.getElementById('add-new-category-button');
        const prevCategoryPageButton = document.getElementById('prev-category-page-button');
        const nextCategoryPageButton = document.getElementById('next-category-page-button');
        const currentCategoryPageSpan = document.getElementById('current-category-page');
        const totalCategoryPagesSpan = document.getElementById('total-category-pages');
        let currentCategoryPage = 1;
        const categoriesPerPage = 3;
        let allReportCategories = []; // Raporlar sayfası için tüm kategorileri saklayacak

        // Mal Kabul (Stok Girişi) Elementleri
        // Mal Kabul (Stok Girişi) Elementleri
const stockInProductSearchInput = document.getElementById('stock-in-product-search-input');
const stockInSearchResults = document.getElementById('stock-in-search-results');
const stockInSelectedProductInfo = document.getElementById('stock-in-selected-product-info');
const stockInCompanyInput = document.getElementById('stock-in-company-input');
const stockInCompanyId = document.getElementById('stock-in-company-id');
const stockInCompanyResults = document.getElementById('stock-in-company-results');
const stockInQuantityInput = document.getElementById('stock-in-quantity-input');
        const stockInQuantityMinusButton = document.getElementById('stock-in-quantity-minus-button');
        const stockInQuantityPlusButton = document.getElementById('stock-in-quantity-plus-button');
        const stockInNotesInput = document.getElementById('stock-in-notes-input');
        const processStockInButton = document.getElementById('process-stock-in-button');
        const stockInRecentTransactionsTableBody = document.getElementById('stock-in-recent-transactions-table-body');
        let selectedProductForStockIn = null; // Seçilen ürün objesini tutar

        // Sevkiyat Hazırlık (Stok Çıkışı) Elementleri
        const stockOutProductSearchInput = document.getElementById('stock-out-product-search-input');
        const stockOutSearchResults = document.getElementById('stock-out-search-results');
        const stockOutSelectedProductInfo = document.getElementById('stock-out-selected-product-info');
        const stockOutCompanyInput = document.getElementById('stock-out-company-input');
const stockOutCompanyId = document.getElementById('stock-out-company-id');
const stockOutCompanyResults = document.getElementById('stock-out-company-results');
const stockOutQuantityInput = document.getElementById('stock-out-quantity-input');
        const stockOutQuantityMinusButton = document.getElementById('stock-out-quantity-minus-button');
        const stockOutQuantityPlusButton = document.getElementById('stock-out-quantity-plus-button');
        const stockOutNotesInput = document.getElementById('stock-out-notes-input');
        const processStockOutButton = document.getElementById('process-stock-out-button');
        const stockOutRecentTransactionsTableBody = document.getElementById('stock-out-recent-transactions-table-body');
        let selectedProductForStockOut = null; // Seçilen ürün objesini tutar

        // Envanter Sayım / Düzeltme Elementleri
        const stockAdjustmentProductSearchInput = document.getElementById('stock-adjustment-product-search-input');
        const stockAdjustmentSearchResults = document.getElementById('stock-adjustment-search-results');
        const stockAdjustmentSelectedProductInfo = document.getElementById('stock-adjustment-selected-product-info');
        const stockAdjustmentCurrentStockDisplay = document.getElementById('stock-adjustment-current-stock-display');
        const stockAdjustmentNewQuantityInput = document.getElementById('stock-adjustment-new-quantity-input');
        const stockAdjustmentNotesInput = document.getElementById('stock-adjustment-notes-input');
        const processStockAdjustmentButton = document.getElementById('process-stock-adjustment-button');
        const stockAdjustmentRecentTransactionsTableBody = document.getElementById('stock-adjustment-recent-transactions-table-body');
        let selectedProductForStockAdjustment = null; // Seçilen ürün objesini tutar

        // Firma Yönetimi Elementleri
        const manageCompaniesTableBody = document.getElementById('manage-companies-table-body');
        const addNewCompanyButton = document.getElementById('add-new-company-button');
        const prevCompanyPageButton = document.getElementById('prev-company-page-button');
        const nextCompanyPageButton = document.getElementById('next-company-page-button');
        const currentCompanyPageSpan = document.getElementById('current-company-page');
        const totalCompanyPagesSpan = document.getElementById('total-company-pages');
        let currentCompanyPage = 1;
        const companiesPerPage = 10;

        // Firma Detay Sayfası Elementleri
        const backToCompaniesButton = document.getElementById('back-to-companies-button');
        const companyDetailName = document.getElementById('company-detail-name');
        const companyDetailContactPerson = document.getElementById('company-detail-contact-person');
        const companyDetailPhone = document.getElementById('company-detail-phone');
        const companyDetailAddress = document.getElementById('company-detail-address');
        const companyDetailTaxOffice = document.getElementById('company-detail-tax-office');
        const companyDetailTaxNumber = document.getElementById('company-detail-tax-number');
        const companyDetailType = document.getElementById('company-detail-type');
        const companyTransactionsTableBody = document.getElementById('company-transactions-table-body');
        const companyReportGlobalSearchInput = document.getElementById('company-report-global-search');
const companyReportStartDateInput = document.getElementById('company-report-start-date');
const companyReportEndDateInput = document.getElementById('company-report-end-date');
        const companyReportProductFilterSelect = document.getElementById('company-report-product-filter');
        const companyReportTransactionTypeFilterSelect = document.getElementById('company-report-transaction-type-filter');
        const filterCompanyReportsButton = document.getElementById('filter-company-reports-button');
        const clearCompanyReportFilterButton = document.getElementById('clear-company-report-filter-button');
        const exportCompanyTransactionsCsvButton = document.getElementById('export-company-transactions-csv-button');
const exportCompanyTransactionsPdfButton = document.getElementById('export-company-transactions-pdf-button');
const prevCompanyReportPageButton = document.getElementById('prev-company-report-page-button');
        const nextCompanyReportPageButton = document.getElementById('next-company-report-page-button');
        const currentCompanyReportPageSpan = document.getElementById('current-company-report-page');
        const totalCompanyReportPagesSpan = document.getElementById('total-company-report-pages');
        let currentCompanyReportPage = 1;
        const companyTransactionsPerPage = 10;
        let currentCompanyId = null; // Detayları gösterilen firmanın ID'si

       // Raporlar Elementleri
const transactionsTableBody = document.getElementById('transactions-table-body');
const reportGlobalSearchInput = document.getElementById('report-global-search');
const reportStartDateInput = document.getElementById('report-start-date');
        const reportEndDateInput = document.getElementById('report-end-date');
        const reportProductFilterSelect = document.getElementById('report-product-filter');
        const reportCategoryFilterSelect = document.getElementById('report-category-filter');
        const reportCompanyFilterSelect = document.getElementById('report-company-filter');
        const reportTransactionTypeFilterSelect = document.getElementById('report-transaction-type-filter');
        const reportUserFilterSelect = document.getElementById('report-user-filter');
        const filterReportsButton = document.getElementById('filter-reports-button');
        const clearReportsFilterButton = document.getElementById('clear-reports-filter-button');
const quickFilterTodayButton = document.getElementById('quick-filter-today');
const quickFilterWeekButton = document.getElementById('quick-filter-week');
const quickFilterMonthButton = document.getElementById('quick-filter-month');
const exportTransactionsCsvButton = document.getElementById('export-transactions-csv-button');
const exportTransactionsPdfButton = document.getElementById('export-transactions-pdf-button');
const prevReportPageButton = document.getElementById('prev-report-page-button');
        const nextReportPageButton = document.getElementById('next-report-page-button');
        const currentReportPageSpan = document.getElementById('current-report-page');
        const totalReportPagesSpan = document.getElementById('total-report-pages');
        let currentReportPage = 1;
        const transactionsPerPage = 10;

        // Kullanıcı Yönetimi Elementleri
        const manageUsersTableBody = document.getElementById('manage-users-table-body');
        const addNewUserButton = document.getElementById('add-new-user-button');
        const prevUserPageButton = document.getElementById('prev-user-page-button');
        const nextUserPageButton = document.getElementById('next-user-page-button');
        const currentUserPageSpan = document.getElementById('current-user-page');
        const totalUserPagesSpan = document.getElementById('total-user-pages');
        let currentUserPage = 1;
        const usersPerPage = 10;

        // Denetim Kayıtları Elementleri
        const auditLogsTableBody = document.getElementById('audit-logs-table-body');
        const prevAuditLogPageButton = document.getElementById('prev-audit-log-page-button');
        const nextAuditLogPageButton = document.getElementById('next-audit-log-page-button');
        const currentAuditLogPageSpan = document.getElementById('current-audit-log-page');
        const totalAuditLogPagesSpan = document.getElementById('total-audit-log-pages');
        let currentAuditLogPage = 1;
        const auditLogsPerPage = 10;
        

        


        // Purchase-In Elements
const purchaseInContent = document.getElementById('purchase-in-content');
const purchaseInProductSearchInput = document.getElementById('purchase-in-product-search-input');
const purchaseInSearchResults = document.getElementById('purchase-in-search-results');
const purchaseInSelectedProductInfo = document.getElementById('purchase-in-selected-product-info');
const purchaseInCompanyInput = document.getElementById('purchase-in-company-input');
const purchaseInCompanyId = document.getElementById('purchase-in-company-id');
const purchaseInCompanyResults = document.getElementById('purchase-in-company-results');
const purchaseInQuantityInput = document.getElementById('purchase-in-quantity-input');
const purchaseInQuantityMinusButton = document.getElementById('purchase-in-quantity-minus-button');
const purchaseInQuantityPlusButton = document.getElementById('purchase-in-quantity-plus-button');
const purchaseInNotesInput = document.getElementById('purchase-in-notes-input');
const processPurchaseInButton = document.getElementById('process-purchase-in-button');
const purchaseInRecentTransactionsTableBody = document.getElementById('purchase-in-recent-transactions-table-body');

// Production-In Elements
const productionInContent = document.getElementById('production-in-content');
const productionInProductSearchInput = document.getElementById('production-in-product-search-input');
const productionInSearchResults = document.getElementById('production-in-search-results');
const productionInSelectedProductInfo = document.getElementById('production-in-selected-product-info');
const bomPreviewArea = document.getElementById('bom-preview-area');
const productionInQuantityInput = document.getElementById('production-in-quantity-input');
const productionInQuantityMinusButton = document.getElementById('production-in-quantity-minus-button');
const productionInQuantityPlusButton = document.getElementById('production-in-quantity-plus-button');
const bomPreviewTableBody = document.getElementById('bom-preview-table-body');
const bomValidationMessage = document.getElementById('bom-validation-message');
const productionInNotesInput = document.getElementById('production-in-notes-input');
const processProductionInButton = document.getElementById('process-production-in-button');
const productionInRecentTransactionsTableBody = document.getElementById('production-in-recent-transactions-table-body');

let selectedProductForPurchaseIn = null;
let selectedProductForProductionIn = null;
let currentBomPreview = null;

        // Modallar
        const productModal = document.getElementById('product-modal');
        const productModalForm = document.getElementById('product-modal-form');
        const modalProductIdInput = document.getElementById('modal-product-id');
        const modalProductBarcodeInput = document.getElementById('modal-product-barcode');
        const modalProductNameInput = document.getElementById('modal-product-name');
        const modalProductCategorySelect = document.getElementById('modal-product-category');
        const modalProductStockInput = document.getElementById('modal-product-stock');
        const modalProductMinStockLevelInput = document.getElementById('modal-product-min-stock-level');
        const modalProductIsActiveSelect = document.getElementById('modal-product-is-active');

// YENİ EKLENEN MODAL ALAN REFERANSLARI
        const modalProductTypeSelect = document.getElementById('modal-product-type');
        const modalProductUnitOfMeasureInput = document.getElementById('modal-product-unit-of-measure');
        // YENİ EKLENEN MODAL ALAN REFERANSLARI SONU

 // ------ DEBUG LOGLARI BAŞLANGIÇ ------
        console.log('Debug - modalProductCategorySelect:', document.getElementById('modal-product-category')); 
        console.log('Debug - modalProductTypeSelect:', modalProductTypeSelect);
        console.log('Debug - modalProductUnitOfMeasureInput:', modalProductUnitOfMeasureInput);
        // ------ DEBUG LOGLARI SONU ------

        const categoryModal = document.getElementById('category-modal');
        const categoryModalForm = document.getElementById('category-modal-form');
        const modalCategoryIdInput = document.getElementById('modal-category-id');
        const modalCategoryNameInput = document.getElementById('modal-category-name');
        const modalCategoryDescriptionInput = document.getElementById('modal-category-description');

        const companyModal = document.getElementById('company-modal');
        const companyModalForm = document.getElementById('company-modal-form');
        const modalCompanyIdInput = document.getElementById('modal-company-id');
        const modalCompanyNameInput = document.getElementById('modal-company-name');
        const modalCompanyContactPersonInput = document.getElementById('modal-company-contact-person');
        const modalCompanyPhoneInput = document.getElementById('modal-company-phone');
        const modalCompanyAddressInput = document.getElementById('modal-company-address');
        const modalCompanyTaxOfficeInput = document.getElementById('modal-company-tax-office');
        const modalCompanyTaxNumberInput = document.getElementById('modal-company-tax-number');
        const modalCompanyTypeSelect = document.getElementById('modal-company-type');

        const userModal = document.getElementById('user-modal');
        const userModalForm = document.getElementById('user-modal-form');
        const modalUserIdInput = document.getElementById('modal-user-id');
        const modalUserUsernameInput = document.getElementById('modal-user-username');
        const modalUserPasswordInput = document.getElementById('modal-user-password');
        const modalUserFullNameInput = document.getElementById('modal-user-full-name');
        const modalUserRoleSelect = document.getElementById('modal-user-role');
        const modalUserIsActiveSelect = document.getElementById('modal-user-is-active');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesButton = document.getElementById('confirm-yes-button');
        const confirmNoButton = document.getElementById('confirm-no-button');
        let confirmCallback = null; // Onay callback fonksiyonu

        // Yardımcı Fonksiyonlar

        /**
         * Global bildirim (toast) mesajı gösterir.
         * @param {string} message Gösterilecek mesaj metni.
         * @param {'success'|'error'|'info'|'warning'} type Mesaj tipi.
         * @param {number} duration Mesajın ekranda kalma süresi (ms).
         */
        function showToast(message, type = 'info', duration = 3000) {
    const messageItem = document.createElement('div');
    messageItem.className = `message-item ${type}`;
    
    // Icon ekleme
    const iconMap = {
        'success': 'fas fa-check-circle',
        'error': 'fas fa-exclamation-circle',
        'warning': 'fas fa-exclamation-triangle',
        'info': 'fas fa-info-circle'
    };
    
    messageItem.innerHTML = `
        <i class="${iconMap[type] || iconMap.info}"></i>
        <span>${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">×</button>
    `;

    messageBox.prepend(messageItem); // En üste ekle

    // Animasyon için kısa bir gecikme
    setTimeout(() => {
        messageItem.classList.add('show');
    }, 10);

    // Belirli bir süre sonra kaldır
    setTimeout(() => {
        messageItem.classList.remove('show');
        messageItem.addEventListener('transitionend', () => messageItem.remove());
    }, duration);
}

        /**
         * Modalı gösterir.
         * @param {HTMLElement} modalElement Gösterilecek modal DOM elementi.
         */
        function openModal(modalElement) {
            modalElement.classList.add('open');
        }

        /**
         * Modalı gizler.
         * @param {HTMLElement} modalElement Gizlenecek modal DOM elementi.
         */
        function closeModal(modalElement) {
            modalElement.classList.remove('open');
        }

        /**
         * Onay modalını gösterir.
         * @param {string} message Onay mesajı.
         * @returns {Promise<boolean>} Kullanıcının evet/hayır yanıtını döndüren Promise.
         */
        function showConfirmModal(message) {
            confirmMessage.textContent = message;
            openModal(confirmModal);

            return new Promise((resolve) => {
                confirmCallback = (result) => {
                    closeModal(confirmModal);
                    resolve(result);
                    confirmCallback = null; // Callback'i sıfırla
                };
            });
        }

        // fetchWithAuth fonksiyonu - Token ile API çağrıları yapmak için
        async function fetchWithAuth(url, options = {}) {
    const token = localStorage.getItem('token');
    const headers = {
        'Content-Type': 'application/json',
        ...(options.headers || {})
    };

    // Global loading indicator
    if (options.showGlobalLoading !== false) {
        document.body.style.cursor = 'wait';
    }

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const finalOptions = {
                ...options,
                headers,
            };

            // GET veya DELETE isteklerinde body olmamalı
            if ((finalOptions.method === 'GET' || finalOptions.method === 'DELETE') && finalOptions.body) {
                delete finalOptions.body;
            }

            try {
                const response = await fetch(url, finalOptions);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Bilinmeyen bir hata oluştu.' }));
                    showToast(errorData.message || 'API isteği başarısız oldu.', 'error');
                    if (response.status === 401 || response.status === 403) {
                        logoutUser(); // Yetkilendirme hatasında çıkış yap
                    }
                    throw new Error(errorData.message || `API isteği başarısız oldu: ${response.status}`);
                }

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                }
                // JSON olmayan yanıtlar için (örn: CSV) doğrudan yanıtı döndür
                return response;

    } catch (error) {
        console.error('fetchWithAuth hatası:', error);
        showToast(error.message || 'Bir ağ hatası oluştu.', 'error');
        throw error;
    } finally {
        // Global loading indicator kaldır
        if (options.showGlobalLoading !== false) {
            document.body.style.cursor = 'default';
        }
    }
}
        // Sipariş No formatlama fonksiyonu
        function formatTransactionId(id, dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const paddedId = String(id).padStart(6, '0'); // ID'yi 6 haneye tamamla
            return `TRN-${year}${month}${day}-${paddedId}`;
        }

        function getTransactionTypeDisplay(type) {
    switch(type) {
        case 'purchase_in': return 'Satın Alma';
        case 'production_in': return 'Üretim';
        case 'in': return 'Giriş'; // Legacy support (Eski girişler için)
        case 'out': return 'Çıkış';
        case 'adjustment': return 'Düzeltme';
        default: return type; // Bilinmeyen bir tip gelirse olduğu gibi döndür
    }
}

        // Kullanıcı Giriş/Çıkış İşlemleri
        async function handleLogin(event) {
            event.preventDefault(); // Sayfa yenilenmesini engeller

            const username = loginForm.username.value;
            const password = loginForm.password.value;

            if (!username || !password) {
                showToast('Kullanıcı adı ve şifre gereklidir.', 'warning');
                return;
            }

            try {
                const data = await fetchWithAuth(`${API_URL}/auth/login`, {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });

                localStorage.setItem('token', data.token);
                localStorage.setItem('userRole', data.user.role);
                localStorage.setItem('userFullName', data.user.full_name);
                localStorage.setItem('username', data.user.username);
                localStorage.setItem('userId', data.user.id);

                showContent(window.location.hash.substring(1) || 'dashboard'); // Başarılı girişte içeriği göster
                showToast(`Hoş Geldiniz, ${localStorage.getItem('userFullName')}!`, 'success');
            } catch (error) {
                // Hata mesajı fetchWithAuth tarafından gösterildiği için burada tekrar göstermiyoruz
            }
        }

        function logoutUser() {
            localStorage.removeItem('token');
            localStorage.removeItem('userRole');
            localStorage.removeItem('userFullName');
            localStorage.removeItem('username');
            localStorage.removeItem('userId');
            showContent('login'); // Çıkış yapıldığında login sayfasını göster
            showToast('Başarıyla çıkış yapıldı.', 'info');
        }

        // Rol bazlı menü öğelerini ve butonları göster/gizle
        function updateUIVisibilityByRole() {
            const userRole = localStorage.getItem('userRole');
            if (!userRole) {
                // Kullanıcı girişi yapılmamışsa tüm menüleri gizle
                document.querySelectorAll('[data-roles]').forEach(el => {
                    el.classList.add('hidden');
                });
                return;
            }

            document.querySelectorAll('[data-roles]').forEach(el => {
                const allowedRoles = el.dataset.roles.split(',');
                if (allowedRoles.includes(userRole)) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
        }

        // Sayfa içeriğini ve login ekranını yöneten ana fonksiyon
        async function showContent(targetPage) {
            const token = localStorage.getItem('token');

            if (token) {
                // Kullanıcı giriş yapmışsa: login sayfasını gizle, uygulama konteynerini göster
                loginPage.classList.add('hidden');
                appContainer.classList.add('active'); // opacity ve visibility geçişi için
                
                // appContainer'ın tamamen görünür olmasını bekle (CSS transition süresi kadar)
                await new Promise(resolve => setTimeout(resolve, 300)); 
                
                loginPage.style.display = 'none'; // Geçiş sonrası display'i tamamen kaldır
                appContainer.style.display = 'flex'; // app-container'ı flex olarak göster
                
                loggedInUserFullNameSpan.textContent = localStorage.getItem('userFullName');
                loggedInUserRoleSpan.textContent = localStorage.getItem('userRole');
                updateUIVisibilityByRole();

                // Eğer targetPage 'login' ise, default olarak dashboard'a yönlendir
                const actualPage = targetPage === 'login' ? 'dashboard' : targetPage;
                window.location.hash = actualPage; // URL hash'i güncelle
                await showPage(actualPage); // İstenen sayfayı yükle
            } else {
                // Kullanıcı giriş yapmamışsa: login sayfasını göster, uygulama konteynerini gizle
                appContainer.classList.remove('active'); // opacity ve visibility geçişi için
                
                // appContainer'ın tamamen gizlenmesini bekle
                await new Promise(resolve => setTimeout(resolve, 300));

                appContainer.style.display = 'none'; // Geçiş sonrası display'i tamamen kaldır
                loginPage.style.display = 'flex'; // login-page'i flex olarak göster
                loginPage.classList.remove('hidden'); // Gizli sınıfını kaldır

                window.location.hash = ''; // URL hash'i temizle
                // Mobil menüyü kapat ve overflow'u kaldır (çıkış yapıldığında)
                sidebarDiv.classList.remove('open');
                mainContentWrapperDiv.classList.remove('sidebar-open');
                hamburgerMenuButton.textContent = '☰';
                document.documentElement.classList.remove('sidebar-active');
            }
        }


        function checkLoginStatus() {
            // Sayfa yüklendiğinde veya hash değiştiğinde çağrılır
            // showContent fonksiyonu zaten token kontrolünü yapıyor ve ilgili sayfayı yüklüyor.
            const initialHash = window.location.hash.substring(1);
            showContent(initialHash || 'dashboard');
        }

        // Sayfa Gösterimi
        async function showPage(pageName, params = {}) {
            document.querySelectorAll('.page-content').forEach(section => {
                section.classList.add('hidden');
            });
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });

            let contentToShow;
            let title;
            let activeMenuItem;

            switch (pageName) {
                case 'dashboard':
                    contentToShow = dashboardContent;
                    title = 'Dashboard';
                    activeMenuItem = document.querySelector('[data-page="dashboard"]');
                    await loadDashboardData();
                    break;
                case 'manageProducts':
                    contentToShow = manageProductsContent;
                    title = 'Ürün Yönetimi';
                    activeMenuItem = document.querySelector('[data-page="manageProducts"]');
                    currentProductPage = 1; // Sayfa değiştiğinde ilk sayfaya dön
                    await loadCategoriesToProductFilter(); // Kategori filtresini doldur
                    await populateManageProductsTable();
                    break;
                case 'manageCategories': // Bu case artık "Kategori ve Birim Yönetimi" sayfasını yönetiyor
                contentToShow = manageCategoriesContent;
                title = 'Kategori ve Birim Yönetimi'; // Sayfa başlığını güncelleyebiliriz
                activeMenuItem = document.querySelector('[data-page="manageCategories"]');
                
                // Kategori Arama Kutusunu Temizle (YENİ)
                if (categorySearchInput) categorySearchInput.value = ''; 
                currentCategoryPage = 1;
                await populateManageCategoriesTable(); // Kategorileri yükle

                // Birim Arama Kutusunu Temizle (YENİ)
                if (unitSearchInput) unitSearchInput.value = '';
                currentUnitPage = 1;
                await populateManageUnitsTable(); // Birimleri yükle (Bu fonksiyonu birazdan yazacağız)
                break;
                

                case 'purchaseIn':
    contentToShow = purchaseInContent;
    title = 'Satın Alma Girişi';
    activeMenuItem = document.querySelector('[data-page="purchaseIn"]');
    
    
    async function loadPurchaseInScreen() {
    selectedProductForPurchaseIn = null;

    // Clear form
    purchaseInProductSearchInput.value = '';
    purchaseInSelectedProductInfo.innerHTML = '<p class="text-gray-600">Lütfen bir ürün seçin veya arayın.</p>';
    purchaseInCompanyInput.value = '';
    purchaseInCompanyId.value = '';
    purchaseInCompanyResults.innerHTML = '';
    purchaseInQuantityInput.value = 1;
    purchaseInNotesInput.value = '';
    processPurchaseInButton.disabled = true;

    // Setup autocompletes
    setupProductSearchForPurchase(); // Bu fonksiyonu bir sonraki adımda (Adım 6) oluşturacağız
    setupCompanyAutocomplete(purchaseInCompanyInput, purchaseInCompanyId, purchaseInCompanyResults, 'supplier');

    // Setup quantity controls
    setupQuantityControls(purchaseInQuantityMinusButton, purchaseInQuantityPlusButton, purchaseInQuantityInput);

    // Load recent transactions
    await fetchRecentTransactions('purchase_in', purchaseInRecentTransactionsTableBody);

    // Focus on product search
    purchaseInProductSearchInput.focus();
}
    
    
    await loadPurchaseInScreen(); // Bu fonksiyonu bir sonraki adımda oluşturacağız
    break;
case 'productionIn':
    contentToShow = productionInContent;
    title = 'Üretim Tamamlama';
    activeMenuItem = document.querySelector('[data-page="productionIn"]');
    



    async function loadProductionInScreen() {
    selectedProductForProductionIn = null;
    currentBomPreview = null;

    // Clear form
    productionInProductSearchInput.value = '';
    productionInSelectedProductInfo.innerHTML = '<p class="text-gray-600">Lütfen bir ürün seçin veya arayın.</p>';
    bomPreviewArea.classList.add('hidden');
    productionInQuantityInput.value = 1;
    productionInNotesInput.value = '';
    processProductionInButton.disabled = true;

    // Setup product search and quantity controls
    setupProductSearchForProduction(); // Bu fonksiyonu bir sonraki adımda (Adım 6) oluşturacağız
    setupQuantityControls(productionInQuantityMinusButton, productionInQuantityPlusButton, productionInQuantityInput);

    // Setup quantity change listener for BOM preview
    productionInQuantityInput.addEventListener('input', debounce(updateBomPreview, 500)); // updateBomPreview & debounce fonksiyonlarını Adım 7'de oluşturacağız

    // Load recent transactions
    await fetchRecentTransactions('production_in', productionInRecentTransactionsTableBody);

    // Focus on product search
    productionInProductSearchInput.focus();
}
    
    
    await loadProductionInScreen(); // Bu fonksiyonu bir sonraki adımda oluşturacağız
    break;

                case 'stockOut':
                    contentToShow = stockOutContent;
                    title = 'Sevkiyat Hazırlık (Çıkış)';
                    activeMenuItem = document.querySelector('[data-page="stockOut"]');
                    await loadStockScreen('out');
                    break;
                case 'stockAdjustment':
                    contentToShow = stockAdjustmentContent;
                    title = 'Envanter Sayım / Düzeltme';
                    activeMenuItem = document.querySelector('[data-page="stockAdjustment"]');
                    await loadStockScreen('adjustment');
                    break;
                case 'manageCompanies':
                    contentToShow = manageCompaniesContent;
                    title = 'Firma Yönetimi';
                    activeMenuItem = document.querySelector('[data-page="manageCompanies"]');
                    currentCompanyPage = 1;
                    await populateManageCompaniesTable();
                    break;
                case 'company-detail':
                    contentToShow = companyDetailContent;
                    title = 'Firma Detayı';
                    activeMenuItem = document.querySelector('[data-page="manageCompanies"]'); // Firma yönetimi menüsünü aktif tut
                    currentCompanyId = params.companyId;
                    if (currentCompanyId) {
                        await loadCompanyDetails(currentCompanyId);
                        await loadProductsToCompanyReportFilter(); // Firma rapor filtresi için ürünleri yükle
                        await fetchCompanyTransactions(); // Firma hareketlerini yükle
                    } else {
                        showToast('Firma ID\'si bulunamadı.', 'error');
                        window.location.hash = '#manage-companies'; // Firmalar sayfasına geri dön
                    }
                    break;
                case 'reports':
                    contentToShow = reportsContent;
                    title = 'Raporlar';
                    activeMenuItem = document.querySelector('[data-page="reports"]');
                    currentReportPage = 1;
                    await loadProductsToReportFilter();
                    await loadCategoriesToReportFilter();
                    await loadCompaniesToReportFilter();
                    await loadUsersToReportFilter();
                    await fetchAllTransactionsForReports();
                    break;
                case 'manageUsers':
                    contentToShow = manageUsersContent;
                    title = 'Kullanıcı Yönetimi';
                    activeMenuItem = document.querySelector('[data-page="manageUsers"]');
                    currentUserPage = 1;
                    await populateManageUsersTable();
                    break;
                case 'auditLogs':
                    contentToShow = auditLogsContent;
                    title = 'Denetim Kayıtları';
                    activeMenuItem = document.querySelector('[data-page="auditLogs"]');
                    currentAuditLogPage = 1;
                    await fetchAuditLogs();
                    break;
                case 'manageBom':
                    contentToShow = manageBomContent;
                    title = 'Ürün Reçetesi Yönetimi';
                    activeMenuItem = document.querySelector('[data-page="manageBom"]');
                    await loadManageBomPage();
                    break;    
                default:
                    contentToShow = dashboardContent;
                    title = 'Dashboard';
                    activeMenuItem = document.querySelector('[data-page="dashboard"]');
                    await loadDashboardData();
                    break;
            }

            if (contentToShow) {
                contentToShow.classList.remove('hidden');
            }
            if (activeMenuItem) {
                activeMenuItem.classList.add('active');
            }
            pageTitle.textContent = title;

            // Mobil menüyü kapat (sadece mobil boyutta) ve overflow'u kaldır
            if (window.innerWidth <= 991 && sidebarDiv.classList.contains('open')) {
                sidebarDiv.classList.remove('open');
                hamburgerMenuButton.textContent = '☰';
                document.documentElement.classList.remove('sidebar-active'); // Overflow'u kaldır
            }
        }

        // Dashboard Verilerini Yükle
        async function loadDashboardData() {
            try {
                // Toplam ürün çeşidi
                const productsRes = await fetchWithAuth(`${API_URL}/products?limit=1`); // Sadece count için 1 limit
                totalProductTypesSpan.textContent = productsRes.totalItems || 0;

                // Toplam stok miktarı (tüm ürünlerin stoğunu toplayarak)
                const allProductsForStock = await fetchWithAuth(`${API_URL}/products?limit=9999`); // Tüm ürünleri çek
                const totalStock = allProductsForStock.products.reduce((sum, product) => sum + product.stock, 0);
                totalStockQuantitySpan.textContent = totalStock;

                // Kritik Stoktaki Ürünler
                const lowStockRes = await fetchWithAuth(`${API_URL}/alerts/low-stock`);
                const criticalProducts = lowStockRes.lowStockProducts;
                criticalStockProductsSpan.textContent = criticalProducts.length;
                if (criticalProducts.length > 0) {
                    criticalStockProductsSpan.classList.add('critical');
                } else {
                    criticalStockProductsSpan.classList.remove('critical');
                }

                // Kritik Stok Uyarıları Tablosu
                lowStockProductsTableBody.innerHTML = '';
                if (Array.isArray(criticalProducts) && criticalProducts.length > 0) {
                    criticalProducts.forEach(product => {
                        const row = lowStockProductsTableBody.insertRow();
                        row.innerHTML = `
    <td class="font-medium">${product.name}</td>
    <td class="text-gray-600">${product.barcode}</td>
    <td class="text-red-600 font-bold">${product.stock}</td>
    <td class="text-gray-600">${product.min_stock_level}</td>
    <td class="text-gray-600">${product.category_name || '-'}</td>
`;
                    });
                } else {
                    lowStockProductsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Kritik stoktaki ürün bulunamadı.</td></tr>';
                }

                // Son 5 stok hareketi
                const latestTransactionsRes = await fetchWithAuth(`${API_URL}/reports/transactions?limit=5`);
console.log('🔍 API Response type:', typeof latestTransactionsRes);
console.log('🔍 API Response:', latestTransactionsRes);
console.log('🔍 Is Array:', Array.isArray(latestTransactionsRes));

const latestTransactions = latestTransactionsRes;
                latestTransactionsTableBody.innerHTML = '';

                if (Array.isArray(latestTransactions) && latestTransactions.length > 0) {
    latestTransactions.slice(0, 5).forEach(transaction => { // Sadece ilk 5'ini al
                        const row = latestTransactionsTableBody.insertRow();
                        const transactionTypeDisplay = getTransactionTypeDisplay(transaction.transaction_type);
                        row.innerHTML = `
    <td>${transaction.transaction_code || '-'}</td>
    <td>${transaction.product_name}</td>
    <td>${transactionTypeDisplay}</td>
    <td>${transaction.quantity}</td>
    <td>${transaction.user_username || transaction.user_full_name || '-'}</td>
    <td>${transaction.transaction_date || '-'}</td>
`;
                    });
                } else {
                    latestTransactionsTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Henüz bir stok hareketi bulunamadı.</td></tr>';
                }

            } catch (error) {
                console.error('Dashboard verileri yüklenirken hata:', error);
                showToast(`Dashboard verileri yüklenirken hata: ${error.message}`, 'error');
            }
        }


        // Stok İşlemleri Ekranları (Mal Kabul, Sevkiyat, Düzeltme) Ortak Fonksiyonları
        let currentSelectedProduct = null; // Genel olarak seçilen ürünü tutar

        async function loadStockScreen(type) {
            currentSelectedProduct = null; // Her ekran açıldığında seçilen ürünü sıfırla
            let productSearchInput, selectedProductInfoDiv, quantityInput, notesInput, processButton, recentTransactionsTableBodyElement, companySelectElement = null; // companySelectElement'i buraya taşıdım

            // Elementleri işlem tipine göre ata
if (type === 'in') {
    productSearchInput = stockInProductSearchInput;
    selectedProductInfoDiv = stockInSelectedProductInfo;
    quantityInput = stockInQuantityInput;
    notesInput = stockInNotesInput;
    processButton = processStockInButton;
    recentTransactionsTableBodyElement = stockInRecentTransactionsTableBody;
    stockInQuantityInput.value = 1; // Giriş için varsayılan 1
    companySelectElement = stockInCompanyInput; // Input olarak değişti
    setupCompanyAutocomplete(stockInCompanyInput, stockInCompanyId, stockInCompanyResults, 'supplier');
} else if (type === 'out') {
    productSearchInput = stockOutProductSearchInput;
    selectedProductInfoDiv = stockOutSelectedProductInfo;
    quantityInput = stockOutQuantityInput;
    notesInput = stockOutNotesInput;
    processButton = processStockOutButton;
    recentTransactionsTableBodyElement = stockOutRecentTransactionsTableBody;
    stockOutQuantityInput.value = 1; // Çıkış için varsayılan 1
    companySelectElement = stockOutCompanyInput; // Input olarak değişti
    setupCompanyAutocomplete(stockOutCompanyInput, stockOutCompanyId, stockOutCompanyResults, 'customer');
            } else if (type === 'adjustment') {
                productSearchInput = stockAdjustmentProductSearchInput;
                selectedProductInfoDiv = stockAdjustmentSelectedProductInfo;
                quantityInput = stockAdjustmentNewQuantityInput; // Düzeltme için yeni miktar inputu
                notesInput = stockAdjustmentNotesInput;
                processButton = processStockAdjustmentButton;
                recentTransactionsTableBodyElement = stockAdjustmentRecentTransactionsTableBody;
                stockAdjustmentCurrentStockDisplay.value = ''; // Mevcut stok gösterimini temizle
                stockAdjustmentNewQuantityInput.value = 0; // Düzeltme için varsayılan 0
            }

            // Ortak temizleme ve başlangıç ayarları
productSearchInput.value = '';
selectedProductInfoDiv.innerHTML = '<p class="text-gray-600">Lütfen bir ürün seçin veya barkod okutun.</p>';
notesInput.value = '';
processButton.disabled = true;

// Firma autocomplete temizleme
if (type === 'in') {
    stockInCompanyInput.value = '';
    stockInCompanyId.value = '';
    stockInCompanyResults.innerHTML = '';
} else if (type === 'out') {
    stockOutCompanyInput.value = '';
    stockOutCompanyId.value = '';
    stockOutCompanyResults.innerHTML = '';
}
            recentTransactionsTableBodyElement.innerHTML = `<tr><td colspan="${type === 'out' ? 5 : (type === 'adjustment' ? 6 : 4)}" class="text-center">Son ${type === 'in' ? 'girişler' : (type === 'out' ? 'çıkışlar' : 'düzeltmeler')} yükleniyor...</td></tr>`;

            // Otomatik odaklanma
            productSearchInput.focus();

            // Son işlemleri yükle
            await fetchRecentTransactions(type, recentTransactionsTableBodyElement);
        }
    
        // Ürün arama ve otomatik tamamlama (tüm stok işlem ekranları için ortak)
        let searchTimeout;
        function setupProductSearch(searchInput, searchResultsDiv, selectedProductInfoDiv, processButton, quantityInput, currentStockDisplayInput = null) {
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                const query = searchInput.value.trim();
                if (query.length < 2) {
                    searchResultsDiv.innerHTML = '';
                    processButton.disabled = true;
                    selectedProductInfoDiv.innerHTML = '<p class="text-gray-600">Lütfen bir ürün seçin veya barkod okutun.</p>';
                    currentSelectedProduct = null;
                    if(currentStockDisplayInput) currentStockDisplayInput.value = '';
                    return;
                }
                searchTimeout = setTimeout(async () => {
                    await fetchProductsForAutocomplete(query, searchResultsDiv, selectedProductInfoDiv, processButton, quantityInput, currentStockDisplayInput);
                }, 300);
            });

            // Barkod okutma veya Enter ile arama
            searchInput.addEventListener('keypress', async (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const inputVal = searchInput.value.trim();

                    if (inputVal.length > 5 && !isNaN(inputVal)) { // Barkod olma ihtimali yüksek
                        try {
                            const response = await fetchWithAuth(`${API_URL}/products?search=${encodeURIComponent(inputVal)}&limit=1`);
                            const products = response.products;
                            const product = products.find(p => p.barcode === inputVal); // Tam eşleşme

                            if (product) {
                                selectProductForTransaction(product, selectedProductInfoDiv, processButton, quantityInput, currentStockDisplayInput);
                                searchInput.value = product.name; // Inputu ürün adıyla doldur
                                searchResultsDiv.innerHTML = '';
                            } else {
                                // Ürün bulunamazsa, yeni ürün olarak ekleme senaryosu
                                currentSelectedProduct = null;
                                selectedProductInfoDiv.innerHTML = `
                                    <p class="text-yellow-600 font-semibold mb-2">Barkod <strong>${inputVal}</strong> ile ürün bulunamadı. Yeni ürün olarak eklenecek.</p>
                                    <div class="form-group">
                                        <label for="new-product-name-input" class="block text-gray-700 font-medium mb-2">Yeni Ürün Adı:</label>
                                        <input type="text" id="new-product-name-input" placeholder="Yeni ürün adını girin" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    <p class="text-gray-600"><strong>Barkod:</strong> ${inputVal}</p>
                                    <p class="text-gray-600"><strong>Mevcut Stok:</strong> 0 adet</p>
                                `;
                                // Yeni ürün adı inputuna odaklan
                                const newProductNameInput = document.getElementById('new-product-name-input');
                                if (newProductNameInput) newProductNameInput.focus();
                                processButton.disabled = false; // İşlem butonu aktif
                            }
                        } catch (error) {
                            console.error('Barkod ile ürün arama hatası:', error);
                            showToast(`Ürün bilgisi alınırken hata: ${error.message}`, 'error');
                            selectedProductInfoDiv.innerHTML = `<p class="text-red-600">Ürün bilgisi alınırken hata oluştu.</p>`;
                            processButton.disabled = true;
                        }
                    } else {
                        const firstResult = searchResultsDiv.querySelector('.search-result-item');
                        if (firstResult) {
                            const product = {
                                id: parseInt(firstResult.dataset.productId),
                                name: firstResult.dataset.productName,
                                barcode: firstResult.dataset.productBarcode,
                                stock: parseInt(firstResult.dataset.productStock),
                                min_stock_level: parseInt(firstResult.dataset.productMinStockLevel)
                            };
                            selectProductForTransaction(product, selectedProductInfoDiv, processButton, quantityInput, currentStockDisplayInput);
                            searchInput.value = product.name;
                            searchResultsDiv.innerHTML = '';
                        } else {
                            showToast('Lütfen geçerli bir barkod okutun veya ürün adı girerek listeden seçin.', 'warning');
                        }
                    }
                }
            });

            // Arama sonuçlarına tıklama
            searchResultsDiv.addEventListener('click', (e) => {
                const item = e.target.closest('.search-result-item');
                if (item) {
                    const product = {
                        id: parseInt(item.dataset.productId),
                        name: item.dataset.productName,
                        barcode: item.dataset.productBarcode,
                        stock: parseInt(item.dataset.productStock),
                        min_stock_level: parseInt(item.dataset.productMinStockLevel)
                    };
                    selectProductForTransaction(product, selectedProductInfoDiv, processButton, quantityInput, currentStockDisplayInput);
                    searchInput.value = product.name;
                    searchResultsDiv.innerHTML = '';
                }
            });
        }

        async function fetchProductsForAutocomplete(query, searchResultsDiv, selectedProductInfoDiv, processButton, quantityInput, currentStockDisplayInput) {
            try {
                const response = await fetchWithAuth(`${API_URL}/products?search=${encodeURIComponent(query)}&limit=10`);
                const products = response.products;
                searchResultsDiv.innerHTML = '';

                if (products.length === 0) {
                    searchResultsDiv.innerHTML = '<div class="p-3 text-gray-500">Ürün bulunamadı.</div>';
                    processButton.disabled = true;
                    selectedProductInfoDiv.innerHTML = '<p class="text-gray-600">Lütfen bir ürün seçin veya barkod okutun.</p>';
                    currentSelectedProduct = null;
                    if(currentStockDisplayInput) currentStockDisplayInput.value = '';
                    return;
                }

                products.forEach(product => {
                    const item = document.createElement('div');
                    item.classList.add('search-result-item');
                    item.innerHTML = `
                        <span>${product.name}</span>
                        <span class="stock-info">Stok: ${product.stock}</span>
                    `;
                    item.dataset.productId = product.id;
                    item.dataset.productName = product.name;
                    item.dataset.productBarcode = product.barcode;
                    item.dataset.productStock = product.stock;
                    item.dataset.productMinStockLevel = product.min_stock_level;
                    searchResultsDiv.appendChild(item);
                });
                processButton.disabled = true;
                selectedProductInfoDiv.innerHTML = '<p class="text-gray-600">Lütfen listeden bir ürün seçin.</p>';
                currentSelectedProduct = null;
                if(currentStockDisplayInput) currentStockDisplayInput.value = '';

            } catch (error) {
                console.error('Ürün ararken hata:', error);
                searchResultsDiv.innerHTML = `<div class="p-3 text-red-600">${error.message}</div>`;
                processButton.disabled = true;
                selectedProductInfoDiv.innerHTML = '<p class="text-red-600">Ürün ararken hata oluştu.</p>';
                currentSelectedProduct = null;
                if(currentStockDisplayInput) currentStockDisplayInput.value = '';
            }
        }

        function selectProductForTransaction(product, selectedProductInfoDiv, processButton, quantityInput, currentStockDisplayInput) {
            currentSelectedProduct = product;
            selectedProductInfoDiv.innerHTML = `
                <p class="text-gray-700"><strong>Ürün Adı:</strong> ${product.name}</p>
                <p class="text-gray-700"><strong>Barkod:</strong> ${product.barcode}</p>
                <p class="text-gray-700"><strong>Mevcut Stok:</strong> <span class="current-stock-display ${product.stock <= product.min_stock_level && product.min_stock_level > 0 ? 'low-stock' : ''}">${product.stock}</span> adet</p>
            `;
            processButton.disabled = false;
            quantityInput.focus();

            if (currentStockDisplayInput) {
                currentStockDisplayInput.value = product.stock;
            }
    }

    // Company Autocomplete Setup
    function setupCompanyAutocomplete(inputElement, hiddenIdElement, resultsElement, typeFilter = 'all') {
        let searchTimeout;
        
        inputElement.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            const query = inputElement.value.trim();
            
            if (query.length < 2) {
                resultsElement.innerHTML = '';
                hiddenIdElement.value = '';
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                await fetchCompaniesForAutocomplete(query, inputElement, hiddenIdElement, resultsElement, typeFilter);
            }, 300);
        });

        // Enter tuşu ile ilk sonucu seç
        inputElement.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                const firstResult = resultsElement.querySelector('.search-result-item');
                if (firstResult) {
                    firstResult.click();
                }
            }
        });

        // Sonuçlara tıklama
        resultsElement.addEventListener('click', (e) => {
            const item = e.target.closest('.search-result-item');
            if (item) {
                selectCompanyForTransaction(item, inputElement, hiddenIdElement, resultsElement);
            }
        });
    }

    async function fetchCompaniesForAutocomplete(query, inputElement, hiddenIdElement, resultsElement, typeFilter) {
        try {
            const response = await fetchWithAuth(`${API_URL}/companies/search?query=${encodeURIComponent(query)}`);
            const companies = response;
            resultsElement.innerHTML = '';

            // "Kendi Üretimimiz" seçeneğini her zaman göster
            const ownProductionItem = document.createElement('div');
            ownProductionItem.classList.add('search-result-item');
            ownProductionItem.innerHTML = `<span>Kendi Üretimimiz</span>`;
            ownProductionItem.dataset.companyId = 'null';
            ownProductionItem.dataset.companyName = 'Kendi Üretimimiz';
            resultsElement.appendChild(ownProductionItem);

            if (companies.length === 0) {
                const noResultItem = document.createElement('div');
                noResultItem.classList.add('p-3', 'text-gray-500');
                noResultItem.textContent = 'Firma bulunamadı.';
                resultsElement.appendChild(noResultItem);
                return;
            }

            companies.forEach(company => {
                const item = document.createElement('div');
                item.classList.add('search-result-item');
                item.innerHTML = `<span>${company.name}</span>`;
                item.dataset.companyId = company.id;
                item.dataset.companyName = company.name;
                resultsElement.appendChild(item);
            });

        } catch (error) {
            console.error('Firma arama hatası:', error);
            resultsElement.innerHTML = `<div class="p-3 text-red-600">${error.message}</div>`;
        }
    }

    function selectCompanyForTransaction(item, inputElement, hiddenIdElement, resultsElement) {
    const companyId = item.dataset.companyId;
    const companyName = item.dataset.companyName;
    
    inputElement.value = companyName;
    hiddenIdElement.value = companyId === 'null' ? 'null' : companyId; // String olarak 'null' ver
    resultsElement.innerHTML = '';
    
    // DEBUG
    console.log('🔍 Company Selected:', { companyId, companyName, hiddenValue: hiddenIdElement.value });
}

    // Miktar artırma/azaltma butonları
        function setupQuantityControls(minusBtn, plusBtn, quantityInput) {
            minusBtn.addEventListener('click', () => {
                let val = parseInt(quantityInput.value);
                const min = parseInt(quantityInput.min || 1); // Varsayılan min 1
                if (!isNaN(val) && val > min) {
                    quantityInput.value = val - 1;
                } else if (isNaN(val)) {
                    quantityInput.value = min; // NaN ise min değere ayarla
                }
            });
            plusBtn.addEventListener('click', () => {
                let val = parseInt(quantityInput.value);
                if (!isNaN(val)) {
                    quantityInput.value = val + 1;
                } else {
                    quantityInput.value = parseInt(quantityInput.min || 1); // NaN ise min değere ayarla
                }
            });
        }

        // Mal Kabul, Sevkiyat, Düzeltme için miktar kontrollerini ayarla
        setupQuantityControls(stockInQuantityMinusButton, stockInQuantityPlusButton, stockInQuantityInput);
        setupQuantityControls(stockOutQuantityMinusButton, stockOutQuantityPlusButton, stockOutQuantityInput);
        // Düzeltme için miktar kontrolü farklı, direkt yeni miktar giriliyor, +/- butonları yok

        // Ortak işlem gönderme fonksiyonu
    async function processStockTransaction(type) { 
    const userId = parseInt(localStorage.getItem('userId'));
if (!userId) {
    showToast('Kullanıcı oturumu geçersiz. Lütfen tekrar giriş yapın.', 'error');
    logoutUser();
    return; // Fonksiyondan çık, devam etme
}    // Parametreleri kaldırıp içeride tekrar seçeceğiz
    console.log('🚀 processStockTransaction çağrıldı. Tip:', type);

    // 1. Tipe göre DOM elementlerini ve seçili ürün bilgisini tutacak değişkenleri ata
    let productSearchInput, selectedProductInfoDiv, quantityInput, notesInput, processButton, recentTransactionsTableBodyElement, companySelectElement, currentStockDisplayInput = null; 
    let currentProductForTransaction = null; // O anki işlem için seçili ürünü tutacak yerel değişken

    if (type === 'purchase_in') {
        productSearchInput = purchaseInProductSearchInput;
        selectedProductInfoDiv = purchaseInSelectedProductInfo;
        quantityInput = purchaseInQuantityInput;
        notesInput = purchaseInNotesInput;
        processButton = processPurchaseInButton;
        recentTransactionsTableBodyElement = purchaseInRecentTransactionsTableBody;
        companySelectElement = purchaseInCompanyId;
        currentProductForTransaction = selectedProductForPurchaseIn; // Doğru global değişkeni ata
    } else if (type === 'production_in') {
        productSearchInput = productionInProductSearchInput;
        selectedProductInfoDiv = productionInSelectedProductInfo;
        quantityInput = productionInQuantityInput;
        notesInput = productionInNotesInput;
        processButton = processProductionInButton;
        recentTransactionsTableBodyElement = productionInRecentTransactionsTableBody;
        companySelectElement = null;
        currentProductForTransaction = selectedProductForProductionIn; // Doğru global değişkeni ata
    } else if (type === 'in') {
        console.log('🔍 Stock In Company Values:');
        console.log('- Input value:', stockInCompanyInput.value);
        console.log('- Hidden ID value:', stockInCompanyId.value);
        productSearchInput = stockInProductSearchInput;
        selectedProductInfoDiv = stockInSelectedProductInfo;
        quantityInput = stockInQuantityInput;
        notesInput = stockInNotesInput;
        processButton = processStockInButton;
        recentTransactionsTableBodyElement = stockInRecentTransactionsTableBody;
        companySelectElement = stockInCompanyId;
        currentProductForTransaction = currentSelectedProduct; // Eski mantık için ilgili global değişken
    } else if (type === 'out') {
        console.log('🔍 Stock Out Company Values:');
        console.log('- Input value:', stockOutCompanyInput.value);
        console.log('- Hidden ID value:', stockOutCompanyId.value);
        productSearchInput = stockOutProductSearchInput;
        selectedProductInfoDiv = stockOutSelectedProductInfo;
        quantityInput = stockOutQuantityInput;
        notesInput = stockOutNotesInput;
        processButton = processStockOutButton;
        recentTransactionsTableBodyElement = stockOutRecentTransactionsTableBody;
        companySelectElement = stockOutCompanyId;
        currentProductForTransaction = currentSelectedProduct; // Eski mantık için ilgili global değişken
    } else if (type === 'adjustment') {
        // adjustment için currentStockDisplayInput da atanmalı
        
        productSearchInput = stockAdjustmentProductSearchInput;
        selectedProductInfoDiv = stockAdjustmentSelectedProductInfo;
        quantityInput = stockAdjustmentNewQuantityInput;
        notesInput = stockAdjustmentNotesInput;
        processButton = processStockAdjustmentButton;
        recentTransactionsTableBodyElement = stockAdjustmentRecentTransactionsTableBody;
        currentStockDisplayInput = stockAdjustmentCurrentStockDisplay; // Eğer tanımlıysa
        currentProductForTransaction = currentSelectedProduct; // Eski mantık için ilgili global değişken
    }

    // 2. İşlem için gerekli verileri topla
    let productId = currentProductForTransaction ? currentProductForTransaction.id : null;
    let name = currentProductForTransaction ? currentProductForTransaction.name : null;
    let barcode = productSearchInput ? productSearchInput.value.trim() : ''; // productSearchInput null olabilir, kontrol ekle

    // Eğer ürün seçilmemişse ve bu tipte yeni ürün eklenebiliyorsa, ürün adını input'tan al
    // Not: 'production_in' için bu senaryo genellikle olmaz.
    if (!productId && (type === 'purchase_in' || type === 'in')) {
        // Eğer HTML'de 'new-product-name-input' ID'li bir element varsa ve yeni ürün ekleme mantığı buysa:
        const newProductNameInput = document.getElementById('new-product-name-input');
        if (newProductNameInput) {
            name = newProductNameInput.value.trim();
        }
        // 'barcode' zaten productSearchInput'tan alınmıştı, yeni ürün için o kullanılabilir.
    }

    let quantityValue = quantityInput ? quantityInput.value : '';
    let transactionQuantity;
    let newStockQuantity = null;
    let notes = notesInput ? notesInput.value.trim() : '';
    let companyId = companySelectElement ? companySelectElement.value : null;

    // ... (companyId 'null' string kontrolü ve parse etme) ...
    // ... (userId alınıyor) ...

    // 3. Validasyonlar
    // "Yeni ürün için ürün adı girmeniz gerekmektedir." kontrolü:
    if (!productId && (type === 'purchase_in' || type === 'in')) { // Sadece izin verilen tiplerde yeni ürün kontrolü
        if (!name || name.length < 3) {
            showToast('Yeni ürün için ürün adı girmeniz gerekmektedir.', 'error');
            console.log('Hata: Yeni ürün adı eksik.');
            return;
        }
    } else if (!productId && (type === 'production_in' || type === 'out' || type === 'adjustment')) {
        // Bu tiplerde ürün seçimi zorunlu olmalı
        showToast('Lütfen önce bir ürün seçin.', 'error');
        console.log('Hata: Ürün seçilmedi.');
        return;
    }

            // Miktar validasyonu ve dönüşümü
            if (type === 'adjustment') {
                newStockQuantity = parseInt(quantityValue); // adjustment için quantityInput değeri yeni stoktur
                console.log('Adjustment - newStockQuantity (parse edilmiş):', newStockQuantity);
                if (isNaN(newStockQuantity) || newStockQuantity < 0) {
                    showToast('Yeni stok miktarı sıfırdan küçük olamaz ve sayı olmalıdır.', 'error');
                    console.log('Hata: Yeni stok miktarı geçersiz.');
                    return;
                }
                // quantity burada farkı temsil eder. Fark 0 veya negatif olabilir.
                transactionQuantity = newStockQuantity - (currentSelectedProduct ? currentSelectedProduct.stock : 0);
                console.log('Adjustment - transactionQuantity (fark):', transactionQuantity);

                if (!notes || notes.length < 5) { // Düzeltme için not zorunlu
                    showToast('Düzeltme işlemi için en az 5 karakter not girmek zorunludur.', 'error');
                    console.log('Hata: Düzeltme notu eksik.');
                    return;
                }

            } else { // 'in' ve 'out' için
                transactionQuantity = parseInt(quantityValue);
                console.log('In/Out - transactionQuantity (parse edilmiş):', transactionQuantity);
                if (isNaN(transactionQuantity) || transactionQuantity <= 0) {
                    showToast('Miktar sıfırdan büyük bir sayı olmalıdır.', 'error');
                    console.log('Hata: Miktar geçersiz veya sıfırdan küçük.');
                    return;
                }
            }


            if ((type === 'in' || type === 'out' || type === 'purchase_in') && companyId === '') {
    showToast(`${type === 'purchase_in' ? 'Satın alma' : (type === 'in' ? 'Giriş' : 'Çıkış')} işlemi için firma seçimi zorunludur.`, 'error');
    console.log(`Hata: ${type} işlemi için firma seçimi eksik.`); // Bu console.log satırı sizde farklı olabilir veya olmayabilir, sorun değil.
    return;
}

            if (type === 'out' && currentSelectedProduct) {
                if (transactionQuantity > currentSelectedProduct.stock) {
                    showToast(`Yetersiz stok! Mevcut: ${currentSelectedProduct.stock}, İstenen: ${transactionQuantity}`, 'error');
                    console.log('Hata: Yetersiz stok.');
                    return;
                }
            }

            processButton.disabled = true;
            processButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> İşleniyor...';

            try {
                const payload = {
    productId: productId,
    barcode: barcode,
    name: name,
    companyId: companyId, // Artık önceden parse edildi
                    type: type,
                    quantity: transactionQuantity, // Artık parse edilmiş ve doğrulanmış miktar
                    userId: userId,
                    notes: notes
                };
                if (type === 'adjustment') {
                    payload.new_stock_quantity = newStockQuantity; // Adjustment için yeni stok miktarı
                }
                console.log('API\'ye gönderilen payload:', payload);

                const data = await fetchWithAuth(`${API_URL}/transactions`, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                showToast(data.message, 'success');

                // UI'ı temizle ve sıfırla
                productSearchInput.value = '';
                selectedProductInfoDiv.innerHTML = '<p class="text-gray-600">Lütfen bir ürün seçin veya barkod okutun.</p>';
                if (quantityInput) quantityInput.value = type === 'adjustment' ? 0 : 1; // Null check eklendi
                notesInput.value = '';
                // Firma seçimini temizle
if (type === 'in') {
    stockInCompanyInput.value = '';
    stockInCompanyId.value = '';
    stockInCompanyResults.innerHTML = '';
} else if (type === 'out') {
    stockOutCompanyInput.value = '';
    stockOutCompanyId.value = '';
    stockOutCompanyResults.innerHTML = '';
}

// YENİ EKLENECEK BLOKLAR:
else if (type === 'purchase_in') {
    purchaseInCompanyInput.value = '';
    purchaseInCompanyId.value = '';
    purchaseInCompanyResults.innerHTML = '';
    selectedProductForPurchaseIn = null; // İlgili seçili ürünü sıfırla
} else if (type === 'production_in') {
    selectedProductForProductionIn = null; // İlgili seçili ürünü sıfırla
    currentBomPreview = null;              // Reçete önizlemesini sıfırla
    bomPreviewArea.classList.add('hidden'); // Reçete alanını gizle
}
// YENİ EKLENECEK BLOKLARIN SONU

                if (currentStockDisplayInput) currentStockDisplayInput.value = '';
                currentSelectedProduct = null;
                processButton.disabled = true;
                productSearchInput.focus();

                // İlgili tabloları ve dashboard'u güncelle
                await fetchRecentTransactions(type, recentTransactionsTableBodyElement); // Doğru tablo elemanı kullanıldı
                await loadDashboardData();
                await populateManageProductsTable(); // Ürün yönetim tablosunu da yenile

            } catch (error) {
                console.error('İşlem kaydetme hatası (catch bloğu):', error);
                // Hata mesajı fetchWithAuth tarafından gösterildiği için burada tekrar göstermiyoruz
            } finally {
                processButton.disabled = false;
                // ESKİ SATIR (BUNU SİLİN):
    // processButton.innerHTML = type === 'in' ? '<i class="fas fa-plus-circle mr-2"></i> Stoğa Ekle' : (type === 'out' ? '<i class="fas fa-truck mr-2"></i> Stoktan Düş / Sevket' : '<i class="fas fa-sync-alt mr-2"></i> Stok Düzelt');

    // YENİ SATIRLAR (BUNLARI EKLEYİN):
    let defaultButtonText = '';
    if (type === 'in') {
        defaultButtonText = '<i class="fas fa-plus-circle mr-2"></i> Stoğa Ekle';
    } else if (type === 'out') {
        defaultButtonText = '<i class="fas fa-truck mr-2"></i> Stoktan Düş / Sevket';
    } else if (type === 'adjustment') {
        defaultButtonText = '<i class="fas fa-sync-alt mr-2"></i> Stok Düzelt';
    } else if (type === 'purchase_in') {
        defaultButtonText = '<i class="fas fa-plus-circle mr-2"></i> Satın Almayı Tamamla';
    } else if (type === 'production_in') {
        defaultButtonText = '<i class="fas fa-industry mr-2"></i> Üretimi Tamamla';
    }
    // processButton null veya undefined değilse innerHTML'i ayarla
    if (processButton) {
        processButton.innerHTML = defaultButtonText;
    }
            }
}

        // Mal Kabul İşlemi
        processStockInButton.addEventListener('click', () => processStockTransaction('in')); // Parametreler kaldırıldı
        setupProductSearch(stockInProductSearchInput, stockInSearchResults, stockInSelectedProductInfo, processStockInButton, stockInQuantityInput, null);

        // Sevkiyat Hazırlık İşlemi
        processStockOutButton.addEventListener('click', () => processStockTransaction('out')); // Parametreler kaldırıldı
        setupProductSearch(stockOutProductSearchInput, stockOutSearchResults, stockOutSelectedProductInfo, processStockOutButton, stockOutQuantityInput, null);

        // Envanter Sayım / Düzeltme İşlemi
        processStockAdjustmentButton.addEventListener('click', () => processStockTransaction('adjustment')); // Parametreler kaldırıldı
        setupProductSearch(stockAdjustmentProductSearchInput, stockAdjustmentSearchResults, stockAdjustmentSelectedProductInfo, processStockAdjustmentButton, stockAdjustmentNewQuantityInput, stockAdjustmentCurrentStockDisplay);

        // Purchase-In Event Listeners (Satın Alma Girişi Olay Dinleyicileri)
if (processPurchaseInButton) { // Elementin var olup olmadığını kontrol et
    processPurchaseInButton.addEventListener('click', () => processStockTransaction('purchase_in'));
}

// Production-In Event Listeners (Üretim Tamamlama Olay Dinleyicileri)
if (processProductionInButton) { // Elementin var olup olmadığını kontrol et
    processProductionInButton.addEventListener('click', () => processStockTransaction('production_in'));
}

        // Son İşlemleri Yükle (Mal Kabul, Sevkiyat, Düzeltme, Satın Alma, Üretim ekranları için)
async function fetchRecentTransactions(type, tableBodyElement) {
    console.log(`WorkspaceRecentTransactions ÇAĞRILDI - Tip: ${type}, Element ID: ${tableBodyElement.id}`);

    // Colspan değerini dinamik olarak ayarlayalım
    let colspanValue = 4; // Varsayılan (örn: 'in', 'production_in')
    // Not: Her sayfanın kendi HTML'indeki <thead> başlık sayısıyla colspanValue eşleşmeli.
    // Bu değerleri her sayfanın kendi "Son Hareketler" tablosunun yapısına göre ayarlayın.
    if (type === 'out' || type === 'purchase_in') { 
        colspanValue = 5;
    } else if (type === 'adjustment') {
        colspanValue = 6;
    } else if (type === 'production_in') { // Üretim tamamlama için sütunları kontrol edin
        colspanValue = 4; 
    } else if (type === 'in') { // Eski genel stok girişi için
        colspanValue = 4;
    }

    tableBodyElement.innerHTML = `<tr><td colspan="${colspanValue}" class="text-center">Son ${type === 'in' ? 'girişler' : (type === 'out' ? 'çıkışlar' : (type === 'adjustment' ? 'düzeltmeler' : (type === 'purchase_in' ? 'satın almalar' : (type === 'production_in' ? 'üretimler' : 'hareketler'))))} yükleniyor...</td></tr>`;
    
    try {
        const params = new URLSearchParams();
        params.append('type', type); 
        params.append('limit', String(RECENT_TRANSACTIONS_LIMIT)); // Global RECENT_TRANSACTIONS_LIMIT sabiti
        
        const apiUrlWithParams = `${API_URL}/reports/transactions?${params.toString()}`;
        console.log(`Son Hareketler API İsteği (Tip: ${type}): ${apiUrlWithParams}`); 

        const data = await fetchWithAuth(apiUrlWithParams);
        // API'den dönen 'data'nın doğrudan dizi olduğunu varsayıyoruz (app.js'deki /api/reports/transactions'a göre)
        const transactionsFromApi = Array.isArray(data) ? data : []; 
        
        console.log(`Son Hareketler API Yanıtı (Tip: ${type}) - Dönen Kayıt Sayısı: ${transactionsFromApi.length}`);

        tableBodyElement.innerHTML = '';

        // Backend zaten limitli veri gönderdiği için slice'a gerek yok, ama API yanıtını garantiye almak için kalabilir.
        const transactionsToDisplay = transactionsFromApi.slice(0, RECENT_TRANSACTIONS_LIMIT); 

        if (Array.isArray(transactionsToDisplay) && transactionsToDisplay.length > 0) {
            transactionsToDisplay.forEach(transaction => {
                const row = tableBodyElement.insertRow();
                // Backend zaten tarihi DD.MM.YYYY HH:mm:ss formatında gönderiyor.
                const displayDate = transaction.transaction_date || '-'; 

                if (type === 'adjustment') {
                    row.innerHTML = `
                        <td>${transaction.transaction_code || '-'}</td>
                        <td>${transaction.product_name || '-'}</td>
                        <td>${transaction.product_stock_after_transaction - transaction.quantity || '-'}</td>
                        <td>${transaction.product_stock_after_transaction || '-'}</td>
                        <td>${transaction.quantity !== undefined ? transaction.quantity : '-'}</td>
                        <td>${displayDate}</td>
                    `;
                } else if (type === 'out') {
                    row.innerHTML = `
                        <td>${transaction.transaction_code || '-'}</td>
                        <td>${transaction.product_name || '-'}</td>
                        <td>${transaction.quantity !== undefined ? transaction.quantity : '-'}</td>
                        <td>${transaction.company_name || ( (transaction.company_id === null || String(transaction.company_id) === 'null') ? 'Kendi Üretimimiz' : '-' )}</td>
                        <td>${displayDate}</td>
                    `;
                } else if (type === 'purchase_in') {
                     row.innerHTML = `
                        <td>${transaction.transaction_code || '-'}</td>
                        <td>${transaction.product_name || '-'}</td>
                        <td>${transaction.quantity !== undefined ? transaction.quantity : '-'}</td>
                        <td>${transaction.company_name || '-'}</td> 
                        <td>${displayDate}</td>
                    `;
                } else if (type === 'production_in') {
                     row.innerHTML = `
                        <td>${transaction.transaction_code || '-'}</td>
                        <td>${transaction.product_name || '-'}</td>
                        <td>${transaction.quantity !== undefined ? transaction.quantity : '-'}</td>
                        
                        <td>${displayDate}</td>
                    `;
                } else if (type === 'in') { 
                    row.innerHTML = `
                        <td>${transaction.transaction_code || '-'}</td>
                        <td>${transaction.product_name || '-'}</td>
                        <td>${transaction.quantity !== undefined ? transaction.quantity : '-'}</td>
                        <td>${displayDate}</td>
                    `;
                } else { // Bilinmeyen bir tip gelirse (genel bir yapı)
                     row.innerHTML = `
                        <td>${transaction.transaction_code || '-'}</td>
                        <td>${transaction.product_name || '-'}</td>
                        <td>${transaction.quantity !== undefined ? transaction.quantity : '-'}</td>
                        <td>${displayDate}</td>
                    `;
                }
            });
        } else {
            let message = `Henüz bir ${type} hareketi bulunamadı.`;
            // type'a göre özel mesajlar...
            if (type === 'purchase_in') message = `Henüz bir satın alma girişi bulunamadı.`;
            if (type === 'production_in') message = `Henüz bir üretim tamamlama kaydı bulunamadı.`;
            tableBodyElement.innerHTML = `<tr><td colspan="${colspanValue}" class="text-center">${message}</td></tr>`;
        }
        console.log(`WorkspaceRecentTransactions TAMAMLANDI - Tip: ${type}`);
    } catch (error) {
        console.error(`Son ${type} hareketleri yüklenirken hata:`, error);
        if (tableBodyElement) { // Hata durumunda da tabloyu temizle
            tableBodyElement.innerHTML = `<tr><td colspan="${colspanValue}" class="text-center text-red-500">Hareketler yüklenirken hata oluştu.</td></tr>`;
        }
        showToast(`Son ${type} hareketleri yüklenirken hata: ${error.message}`, 'error');
    }
}


        // Stok Çıkışı için firma seçimini yükle
        async function loadCompaniesToSelect(selectElement, typeFilter = 'all') {
            try {
                const data = await fetchWithAuth(`${API_URL}/companies?limit=9999`); // Tipe göre filtrele
                const companies = data.companies;

                selectElement.innerHTML = '<option value="">Firma Seçiniz</option><option value="null">Kendi Üretimimiz</option>';
                if (Array.isArray(companies)) {
                    companies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.id;

                        option.textContent = company.name;
                        selectElement.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Firmaları yükleme hatası:', error);
                showToast(`Firmalar yüklenirken hata: ${error.message}`, 'error');
            }
        }

        // Ürün Yönetimi Tablosunu Doldur
        async function populateManageProductsTable() {
            manageProductsTableBody.innerHTML = '<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Ürünler yükleniyor...</td></tr>';

            const search = productSearchInput.value;
            const status = productStatusFilterSelect.value;
            const critical = status === 'critical' ? 'true' : 'false';
            const categoryId = productCategoryFilterSelect.value;
            console.log('🔍 Ürün Yönetimi - Kategori filtresi için seçilen categoryId:', categoryId); 
            const [sortBy, sortOrder] = productSortBySelect.value.split('_'); // Sıralama kriterleri

            try {
                const data = await fetchWithAuth(`${API_URL}/products?page=${currentProductPage}&limit=${productsPerPage}&search=${search}&status=${status !== 'critical' ? status : ''}&critical=${critical}&categoryId=${categoryId}&sortBy=${sortBy}&sortOrder=${sortOrder}`);
                const products = data.products;
                const totalPages = data.totalPages;
                const totalItems = data.totalItems;

                manageProductsTableBody.innerHTML = '';

                if (Array.isArray(products) && products.length > 0) {
                    products.forEach(product => {
                        const row = manageProductsTableBody.insertRow();
                        const stockStatus = product.stock <= product.min_stock_level && product.min_stock_level > 0 ? 'critical' : (product.stock > 0 ? 'normal' : 'empty');
const stockClass = stockStatus === 'critical' ? 'text-red-600 font-bold' : (stockStatus === 'empty' ? 'text-gray-500' : '');

row.innerHTML = `
    <td>${product.id}</td>
    <td>${product.barcode}</td>
    <td>${product.name}</td>
    <td>${product.category_name || '-'}</td>
    <td class="${stockClass}">${product.stock}</td>
    <td>${product.min_stock_level || 0}</td>
    <td><span class="status-badge ${product.is_active ? 'status-active' : 'status-inactive'}">${product.is_active ? 'Aktif' : 'Pasif'}</span></td>
    <td class="action-buttons">
                                <button class="btn btn-secondary edit-product-button" data-id="${product.id}" ${localStorage.getItem('userRole') === 'admin' || localStorage.getItem('userRole') === 'uretim' ? '' : 'disabled'}>Düzenle</button>
                                <button class="btn btn-danger delete-product-button" data-id="${product.id}" ${localStorage.getItem('userRole') === 'admin' ? '' : 'disabled'}>Sil</button>
                            </td>
                        `;
                    });
                } else {
    manageProductsTableBody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-8">
                <div class="flex flex-col items-center space-y-3">
                    <i class="fas fa-boxes text-gray-400 text-4xl"></i>
                    <p class="text-gray-600 font-medium">Kayıtlı ürün bulunamadı</p>
                    <p class="text-gray-500 text-sm">Filtreleri temizleyerek tekrar deneyin veya yeni ürün ekleyin</p>
                </div>
            </td>
        </tr>
    `;
}

                currentProductPageSpan.textContent = currentProductPage;
                totalProductPagesSpan.textContent = totalPages;
                prevProductPageButton.disabled = currentProductPage === 1;
                nextProductPageButton.disabled = currentProductPage === totalPages || totalPages === 0;

            } catch (error) {
                console.error('Yönetim için ürünleri listeleme hatası:', error);
                manageProductsTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Ürünler yüklenirken hata oluştu.</td></tr>';
                showToast(`Ürünler yüklenirken hata: ${error.message}`, 'error');
            }
        }

        // Ürün Yönetimi için Kategorileri Yükle (hem filtre hem modal için)
        async function loadCategoriesToProductFilter() {
             console.log('Debug - loadCategoriesToProductFilter BAŞLADI'); // YENİ LOG
         console.log('Debug - İçerideki productCategoryFilterSelect:', productCategoryFilterSelect); // YENİ LOG
         console.log('Debug - İçerideki modalProductCategorySelect:', modalProductCategorySelect); // YENİ LOG
            try {
                const data = await fetchWithAuth(`${API_URL}/categories?limit=9999`);
                const categories = data.categories;

                // Ürün filtreleme select box'ını doldur
                productCategoryFilterSelect.innerHTML = '<option value="">Tümü</option>';
                if (Array.isArray(categories)) {
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        console.log(`Kategori FİLTRE Option Oluşturuldu: Değer (value) = "${option.value}", Metin = "${category.name}", Kategori ID (category.id) = "${category.id}"`);
                        option.textContent = category.name;
                        productCategoryFilterSelect.appendChild(option);
                    });
                }

                // Ürün modalındaki kategori select box'ını doldur
                modalProductCategorySelect.innerHTML = '<option value="">Kategori Seçiniz</option>';
                if (Array.isArray(categories)) {
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        modalProductCategorySelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Ürün filtresi için kategorileri yükleme hatası:', error);
                showToast(`Kategoriler yüklenirken hata: ${error.message}`, 'error');
            }
        }


async function populateManageCategoriesTable(searchTerm = "") { // searchTerm parametresi eklendi
    if (!manageCategoriesTableBody) return;
    manageCategoriesTableBody.innerHTML = '<tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Kategoriler yükleniyor...</td></tr>';
    
    try {
        const params = new URLSearchParams({
            page: currentCategoryPage,
            limit: categoriesPerPage,
            sortBy: 'id',
            sortOrder: 'asc'
        });
        if (searchTerm) {
            params.append('search', searchTerm); // Backend'in bu 'search' parametresini işlemesi gerekir.
        }

        const data = await fetchWithAuth(`${API_URL}/categories?${params.toString()}`);
        const categories = data.categories;
        const totalPages = data.totalPages || 1;

        manageCategoriesTableBody.innerHTML = '';

        if (Array.isArray(categories) && categories.length > 0) {
            categories.forEach(category => {
                const row = manageCategoriesTableBody.insertRow();
                row.innerHTML = `
                    <td>${category.id}</td>
                    <td>${category.name}</td>
                    <td>${category.description || '-'}</td>
                    <td class="action-buttons" data-roles="admin">
                        <button class="btn btn-secondary btn-sm edit-category-button" data-id="${category.id}">Düzenle</button>
                        <button class="btn btn-danger btn-sm delete-category-button" data-id="${category.id}">Sil</button>
                    </td>
                `;
            });
        } else {
            manageCategoriesTableBody.innerHTML = `<tr><td colspan="4" class="text-center">${searchTerm ? 'Aramanıza uygun kategori bulunamadı.' : 'Kayıtlı kategori bulunamadı.'}</td></tr>`;
        }
        if (currentCategoryPageSpan) currentCategoryPageSpan.textContent = currentCategoryPage;
        if (totalCategoryPagesSpan) totalCategoryPagesSpan.textContent = totalPages;
        if (prevCategoryPageButton) prevCategoryPageButton.disabled = currentCategoryPage === 1;
        if (nextCategoryPageButton) nextCategoryPageButton.disabled = currentCategoryPage === totalPages || totalPages === 0;

    } catch (error) {
        console.error('Kategorileri yükleme hatası:', error);
        manageCategoriesTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Kategoriler yüklenirken hata oluştu.</td></tr>';
        showToast(`Kategoriler yüklenirken hata: ${error.message}`, 'error');
    }
}


        // Birim Yönetimi Tablosunu Doldur (YENİ FONKSİYON)
async function populateManageUnitsTable(searchTerm = "") {
    console.log(`populateManageUnitsTable ÇAĞRILDI - Sayfa: ${currentUnitPage}, Arama Terimi: "${searchTerm}"`);

    if (!manageUnitsTableBody) {
        console.warn('manageUnitsTableBody elementi bulunamadı. Birimler yüklenemiyor.');
        return;
    }
    manageUnitsTableBody.innerHTML = `<tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Birimler yükleniyor...</td></tr>`;
    
    try {
        const params = new URLSearchParams({
            page: currentUnitPage,
            limit: unitsPerPage, // Bu değişken script başında tanımlı olmalı
            sortBy: 'id', 
            sortOrder: 'asc'
        });

        if (searchTerm && searchTerm.trim() !== "") {
            params.append('search', searchTerm.trim());
            console.log(`API'ye gönderilecek birim arama terimi: "${searchTerm.trim()}"`);
        }

        const finalApiUrl = `${API_URL}/units?${params.toString()}`;
        console.log(`Birim API İsteği URL: ${finalApiUrl}`);
        
        const data = await fetchWithAuth(finalApiUrl);
        const units = data.units || [];
        const totalPages = data.totalPages || 1;
        const totalItems = data.totalItems || 0;

        manageUnitsTableBody.innerHTML = '';

        if (Array.isArray(units) && units.length > 0) {
            units.forEach(unit => {
                const row = manageUnitsTableBody.insertRow();
                row.innerHTML = `
                    <td>${unit.id}</td>
                    <td>${unit.name}</td>
                    <td>${unit.abbreviation}</td>
                    <td>${unit.created_at ? new Date(unit.created_at).toLocaleDateString('tr-TR') : '-'}</td>
                    <td class="action-buttons" data-roles="admin">
                        <button class="btn btn-secondary btn-sm edit-unit-button" 
                                data-id="${unit.id}" 
                                data-name="${encodeURIComponent(unit.name)}" 
                                data-abbreviation="${encodeURIComponent(unit.abbreviation)}">Düzenle</button>
                        <button class="btn btn-danger btn-sm delete-unit-button" data-id="${unit.id}">Sil</button>
                    </td>
                `;
            });
        } else {
            manageUnitsTableBody.innerHTML = `<tr><td colspan="5" class="text-center">${searchTerm.trim() !== "" ? 'Aramanıza uygun birim bulunamadı.' : 'Kayıtlı birim bulunamadı.'}</td></tr>`;
        }

        if (currentUnitPageSpan) currentUnitPageSpan.textContent = currentUnitPage;
        if (totalUnitPagesSpan) totalUnitPagesSpan.textContent = totalPages;
        if (prevUnitPageButton) prevUnitPageButton.disabled = currentUnitPage === 1;
        if (nextUnitPageButton) nextUnitPageButton.disabled = currentUnitPage === totalPages || totalItems === 0;

    } catch (error) {
        console.error('Birimleri yükleme hatası:', error);
        if (manageUnitsTableBody) {
            manageUnitsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-red-500">Birimler yüklenirken bir hata oluştu.</td></tr>';
        }
        showToast(`Birimler yüklenirken hata: ${error.message}`, 'error');
    }
}




        async function populateManageCategoriesTable(searchTerm = "") {
    console.log(`populateManageCategoriesTable ÇAĞRILDI - Sayfa: ${currentCategoryPage}, Arama Terimi: "${searchTerm}"`);

    if (!manageCategoriesTableBody) {
        console.warn('manageCategoriesTableBody elementi bulunamadı. Kategoriler yüklenemiyor.');
        return;
    }
    manageCategoriesTableBody.innerHTML = `<tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Kategoriler yükleniyor...</td></tr>`;
    
    try {
        const params = new URLSearchParams({
            page: currentCategoryPage,
            limit: categoriesPerPage, // Bu değişken script başında tanımlı olmalı
            sortBy: 'id',
            sortOrder: 'asc'
        });

        if (searchTerm && searchTerm.trim() !== "") {
            params.append('search', searchTerm.trim());
            console.log(`API'ye gönderilecek kategori arama terimi: "${searchTerm.trim()}"`);
        }

        const finalApiUrl = `${API_URL}/categories?${params.toString()}`;
        console.log(`Kategori API İsteği URL: ${finalApiUrl}`);
        
        const data = await fetchWithAuth(finalApiUrl);
        const categories = data.categories || [];
        const totalPages = data.totalPages || 1;
        const totalItems = data.totalItems || 0;

        manageCategoriesTableBody.innerHTML = '';

        if (Array.isArray(categories) && categories.length > 0) {
            categories.forEach(category => {
                const row = manageCategoriesTableBody.insertRow();
                row.innerHTML = `
                    <td>${category.id}</td>
                    <td>${category.name}</td>
                    <td>${category.description || '-'}</td>
                    <td class="action-buttons" data-roles="admin">
                        <button class="btn btn-secondary btn-sm edit-category-button" data-id="${category.id}">Düzenle</button>
                        <button class="btn btn-danger btn-sm delete-category-button" data-id="${category.id}">Sil</button>
                    </td>
                `;
            });
        } else {
            manageCategoriesTableBody.innerHTML = `<tr><td colspan="4" class="text-center">${searchTerm.trim() !== "" ? 'Aramanıza uygun kategori bulunamadı.' : 'Kayıtlı kategori bulunamadı.'}</td></tr>`;
        }

        if (currentCategoryPageSpan) currentCategoryPageSpan.textContent = currentCategoryPage;
        if (totalCategoryPagesSpan) totalCategoryPagesSpan.textContent = totalPages;
        if (prevCategoryPageButton) prevCategoryPageButton.disabled = currentCategoryPage === 1;
        if (nextCategoryPageButton) nextCategoryPageButton.disabled = currentCategoryPage === totalPages || totalItems === 0;

    } catch (error) {
        console.error('Kategorileri yükleme hatası:', error);
        if(manageCategoriesTableBody) {
             manageCategoriesTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-red-500">Kategoriler yüklenirken hata oluştu.</td></tr>';
        }
        showToast(`Kategoriler yüklenirken hata: ${error.message}`, 'error');
    }
}


        // Firma Yönetimi Tablosunu Doldur
        async function populateManageCompaniesTable() {
            manageCompaniesTableBody.innerHTML = '<tr><td colspan="10" class="text-center">Firmalar yükleniyor...</td></tr>';
            try {
                const data = await fetchWithAuth(`${API_URL}/companies?page=${currentCompanyPage}&limit=${companiesPerPage}`);
                const companies = data.companies;
                const totalPages = data.totalPages;

                manageCompaniesTableBody.innerHTML = '';

                if (Array.isArray(companies) && companies.length > 0) {
                    companies.forEach(company => {
                        const row = manageCompaniesTableBody.insertRow();
                        row.classList.add('company-row'); // Tıklanabilir satır sınıfı
                        row.dataset.companyId = company.id; // Firma ID'sini data attribute olarak sakla
                        row.innerHTML = `
                            <td>${company.id}</td>
                            <td>${company.name}</td>
                            <td>${company.contact_person || '-'}</td>
                            <td>${company.phone || '-'}</td>
                            <td>${company.address || '-'}</td>
                            <td>${company.tax_office || '-'}</td>
                            <td>${company.tax_number || '-'}</td>
                            <td>${company.type || '-'}</td>
                            <td>${new Date(company.created_at).toLocaleDateString('tr-TR')}</td>
                            <td class="action-buttons" data-roles="admin">
                                <button class="btn btn-secondary edit-company-button" data-id="${company.id}" ${localStorage.getItem('userRole') === 'admin' ? '' : 'disabled'}>Düzenle</button>
                                <button class="btn btn-danger delete-company-button" data-id="${company.id}" ${localStorage.getItem('userRole') === 'admin' ? '' : 'disabled'}>Sil</button>
                            </td>
                        `;
                    });
                } else {
                    manageCompaniesTableBody.innerHTML = '<tr><td colspan="10" class="text-center">Kayıtlı firma bulunamadı.</td></tr>';
                }
                currentCompanyPageSpan.textContent = currentCompanyPage;
                totalCompanyPagesSpan.textContent = totalPages;
                prevCompanyPageButton.disabled = currentCompanyPage === 1;
                nextCompanyPageButton.disabled = currentCompanyPage === totalPages || totalPages === 0;

            } catch (error) {
                console.error('Firmaları tabloya yükleme hatası:', error);
                manageCompaniesTableBody.innerHTML = '<tr><td colspan="10" class="text-center">Firmalar yüklenirken hata oluştu.</td></tr>';
                showToast(`Firmalar yüklenirken hata: ${error.message}`, 'error');
            }
        }

        // Firma Detaylarını Yükle
        async function loadCompanyDetails(companyId) {
            try {
                const data = await fetchWithAuth(`${API_URL}/companies/${companyId}`);
                const company = data.company;
                companyDetailName.textContent = company.name;
                companyDetailContactPerson.textContent = company.contact_person || '-';
                companyDetailPhone.textContent = company.phone || '-';
                companyDetailAddress.textContent = company.address || '-';
                companyDetailTaxOffice.textContent = company.tax_office || '-';
                companyDetailTaxNumber.textContent = company.tax_number || '-';
                companyDetailType.textContent = company.type || '-';
            } catch (error) {
                console.error('Firma detayları yüklenirken hata:', error);
                showToast(`Firma detayları yüklenirken hata: ${error.message}`, 'error');
                companyDetailName.textContent = 'Firma bulunamadı.';
            }
        }

        // Firma Rapor Filtresi için Ürünleri Yükle
        async function loadProductsToCompanyReportFilter() {
            try {
                const data = await fetchWithAuth(`${API_URL}/products?limit=9999`);
                const products = data.products;

                companyReportProductFilterSelect.innerHTML = '<option value="">Tümü</option>';
                if (Array.isArray(products)) {
                    products.forEach(product => {
                        const option = document.createElement('option');
                        const productTypeDisplay = getProductTypeDisplay(product.product_type);
                        option.textContent = `${product.name} (${product.barcode}) - ${productTypeDisplay}`;
                        companyReportProductFilterSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Firma rapor filtresi için ürünleri yükleme hatası:', error);
                showToast(`Ürün listesi yüklenirken hata: ${error.message}`, 'error');
            }
        }

        // Firma Hareketlerini Yükle
        async function fetchCompanyTransactions() {
    companyTransactionsTableBody.innerHTML = '<tr><td colspan="9" class="text-center">Firma hareketleri yükleniyor...</td></tr>';

    const globalSearch = companyReportGlobalSearchInput.value;
    const startDate = companyReportStartDateInput.value;
            const endDate = companyReportEndDateInput.value;
            const productId = companyReportProductFilterSelect.value;
            const transactionType = companyReportTransactionTypeFilterSelect.value;

            const params = new URLSearchParams();
if (globalSearch) params.append('searchQuery', globalSearch);
if (startDate) params.append('startDate', startDate);
if (endDate) params.append('endDate', endDate);
            if (productId) params.append('productId', productId);
            if (transactionType) params.append('type', transactionType);

            params.append('page', currentCompanyReportPage);
            params.append('limit', companyTransactionsPerPage);

            try {
                const data = await fetchWithAuth(`${API_URL}/reports/transactions?companyId=${currentCompanyId}&${params.toString()}`);
const transactions = data;
const totalPages = Math.ceil((data.totalCount || transactions.length) / companyTransactionsPerPage) || 1;
                companyTransactionsTableBody.innerHTML = '';

                if (Array.isArray(transactions) && transactions.length > 0) {
                    transactions.forEach(transaction => {
                        const row = companyTransactionsTableBody.insertRow();
                        const transactionTypeDisplay = transaction.transaction_type === 'in' ? 'Giriş' : (transaction.transaction_type === 'out' ? 'Çıkış' : 'Düzeltme');
                        row.innerHTML = `
                            <td>${transaction.transaction_code || '-'}</td>
                            <td>${transaction.product_name}</td>
                            <td>${transaction.category_name || '-'}</td>
                            <td>${transaction.product_barcode || '-'}</td>
                            <td>${transactionTypeDisplay}</td>
                            <td>${transaction.quantity}</td>
                            <td>${transaction.user_full_name || '-'}</td>
                            <td>${transaction.transaction_date || '-'}</td>
                            <td>
${transaction.transaction_notes 
  ? `<button class="btn btn-info btn-sm view-note-btn" data-note="${transaction.transaction_notes.replace(/"/g, '&quot;')}">Not Görüntüle</button>`
  : '-'}
</td>
                        `;
                    });
                } else {
                    companyTransactionsTableBody.innerHTML = '<tr><td colspan="9" class="text-center">Bu firmaya ait kayıtlı hareket bulunamadı.</td></tr>';
                }

                currentCompanyReportPageSpan.textContent = currentCompanyReportPage;
                totalCompanyReportPagesSpan.textContent = totalPages;
                prevCompanyReportPageButton.disabled = currentCompanyReportPage === 1;
                nextCompanyReportPageButton.disabled = currentCompanyReportPage === totalPages || totalPages === 0;

            } catch (error) {
                console.error('Firma hareketleri yüklenirken hata:', error);
                companyTransactionsTableBody.innerHTML = '<tr><td colspan="9" class="text-center">Firma hareketleri yüklenirken hata oluştu.</td></tr>';
                showToast(`Firma hareketleri yüklenirken hata: ${error.message}`, 'error');
            }
        }


        // Rapor Filtresi için Ürünleri Yükle
        async function loadProductsToReportFilter() {
            try {
                const data = await fetchWithAuth(`${API_URL}/products?limit=9999`); // Tüm ürünleri çek
                const products = data.products;

                reportProductFilterSelect.innerHTML = '<option value="">Tümü</option>';
                if (Array.isArray(products)) {
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        const productTypeDisplay = getProductTypeDisplay(product.product_type);
                        option.textContent = `${product.name} (${product.barcode}) - ${productTypeDisplay}`;
                        reportProductFilterSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Rapor filtresi için ürünleri yükleme hatası:', error);
                showToast(`Ürün listesi yüklenirken hata: ${error.message}`, 'error');
            }
        }

        // Rapor Filtresi için Kategorileri Yükle
        async function loadCategoriesToReportFilter() {
            try {
                const data = await fetchWithAuth(`${API_URL}/categories?limit=9999`);
                const categories = data.categories;
                allReportCategories = Array.isArray(categories) ? categories : []; // <<-- BU SATIR ÖNEMLİ
                reportCategoryFilterSelect.innerHTML = '<option value="">Tümü</option>';
                if (Array.isArray(categories)) {
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        console.log(`RAPOR Kategori Option Oluşturuldu: Değer (value) = "<span class="math-inline">\{option\.value\}", Metin \= "</span>{category.name}", Kategori ID (category.id) = "${category.id}"`);
                        option.textContent = category.name;
                        reportCategoryFilterSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Rapor filtresi için kategorileri yükleme hatası:', error);
                showToast(`Kategori listesi yüklenirken hata: ${error.message}`, 'error');
            }
        }

        // Rapor Filtresi için Firmaları Yükle
        async function loadCompaniesToReportFilter() {
            try {
                const data = await fetchWithAuth(`${API_URL}/companies?limit=9999`);
                const companies = data.companies;

                reportCompanyFilterSelect.innerHTML = '<option value="">Tümü</option>';
                if (Array.isArray(companies)) {
                    companies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.id;
                        option.textContent = company.name;
                        reportCompanyFilterSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Rapor filtresi için firmaları yükleme hatası:', error);
                showToast(`Firma listesi yüklenirken hata: ${error.message}`, 'error');
            }
        }

        // Rapor Filtresi için Kullanıcıları Yükle
        async function loadUsersToReportFilter() {
            try {
                const data = await fetchWithAuth(`${API_URL}/users?limit=9999`);
                const users = data.users;

                reportUserFilterSelect.innerHTML = '<option value="">Tümü</option>';
                if (Array.isArray(users)) {
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.full_name || user.username;
                        reportUserFilterSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Rapor filtresi için kullanıcıları yükleme hatası:', error);
                showToast(`Kullanıcı listesi yüklenirken hata: ${error.message}`, 'error');
            }
        }


        // Tüm Stok Hareketlerini Raporlar Sayfasına Yükle
async function fetchAllTransactionsForReports() {
    transactionsTableBody.innerHTML = '<tr><td colspan="10" class="text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Hareketler yükleniyor...</td></tr>';

    const globalSearch = reportGlobalSearchInput.value;
    const startDate = reportStartDateInput.value;
    const endDate = reportEndDateInput.value;
    const productId = reportProductFilterSelect.value;
    const selectedCategoryId = reportCategoryFilterSelect.value; // Bu hala dropdown'dan gelen ID
    const companyId = reportCompanyFilterSelect.value;
    const transactionType = reportTransactionTypeFilterSelect.value;
    const userId = reportUserFilterSelect.value;
    console.log(`WorkspaceAllTransactionsForReports ÇAĞRILDI - globalSearch değeri: "${globalSearch}", Kategori ID: "${selectedCategoryId}"`); 

    console.log('🔍 Raporlar - Kategori filtresi için seçilen categoryId:', selectedCategoryId);

    // === SEÇİLEN KATEGORİ ADINI BULMA ===
    let selectedCategoryNameToFilter = ""; // Filtrelemek için kullanılacak kategori adı
    if (selectedCategoryId && selectedCategoryId !== "") {
        const foundCategory = allReportCategories.find(cat => String(cat.id) === String(selectedCategoryId));
        if (foundCategory) {
            selectedCategoryNameToFilter = foundCategory.name;
            console.log('Filtreleme için Eşleşen Kategori Adı:', selectedCategoryNameToFilter);
        } else {
            console.warn(`Seçilen ID (${selectedCategoryId}) için kategori adı bulunamadı!`);
        
        }
         console.warn('⚠️ allReportCategories dizisi boş, tanımsız veya dolu değil. Kategori adı bulunamıyor!');
        
    
    }



    // === SEÇİLEN KATEGORİ ADINI BULMA SONU ===

    const params = new URLSearchParams();
    // API'ye categoryId göndermenin bir anlamı yok, çünkü backend bunu işlemiyor gibi duruyor.
    // if (selectedCategoryId) params.append('categoryId', selectedCategoryId); // Bu satırı kaldırabilir veya yorumda bırakabilirsiniz.
    
    if (globalSearch) params.append('searchQuery', globalSearch);
    if (startDate) params.append('startDate', startDate);
    if (endDate) params.append('endDate', endDate);
    if (productId) params.append('productId', productId);
    if (companyId) params.append('companyId', companyId);
    if (transactionType) params.append('type', transactionType);
    if (userId) params.append('userId', userId);
    params.append('sortBy', 'transaction_date');
    params.append('sortOrder', 'desc');

    const finalApiUrl = `${API_URL}/reports/transactions?${params.toString()}`;
    console.log(`Raporlar API İsteği URL: ${finalApiUrl}`);


    try {
        const dataFromApi = await fetchWithAuth(`${API_URL}/reports/transactions?${params.toString()}`);
        let allTransactionsFromApi = Array.isArray(dataFromApi) ? dataFromApi : (dataFromApi.transactions || []);

        // === CLIENT-SIDE KATEGORİ ADIYLA FİLTRELEME ===
        let filteredTransactions;
        if (selectedCategoryNameToFilter !== "") { // Eğer bir kategori adı bulunduysa ve seçildiyse
            filteredTransactions = allTransactionsFromApi.filter(transaction => {
                // API yanıtınızda kategori adı 'category_name' olarak geliyor
                return transaction.category_name === selectedCategoryNameToFilter;
            });
            console.log(`Client-side kategori ADIYLA filtreleme uygulandı. Kategori Adı: "${selectedCategoryNameToFilter}". Sonuç sayısı: ${filteredTransactions.length}`);
        } else {
            // Kategori seçilmemişse ("Tümü") veya ad bulunamadıysa, tüm işlemleri kullan
            filteredTransactions = allTransactionsFromApi;
        }
        // === CLIENT-SIDE KATEGORİ FİLTRELEMESİ SONU ===

        const totalItems = filteredTransactions.length;
        const totalPages = Math.ceil(totalItems / transactionsPerPage) || 1;
        const startIndex = (currentReportPage - 1) * transactionsPerPage;
        const endIndex = startIndex + transactionsPerPage;
        const transactionsToDisplay = filteredTransactions.slice(startIndex, endIndex);

        // ... (transactionsTableBody.innerHTML ve sonrası aynı kalacak) ...
        // ... (forEach döngüsü transactionsToDisplay üzerinden devam edecek) ...
        // ... (sayfalama butonları güncellenecek) ...
        // Kalan kısım bir önceki doğru çalışan versiyonunuzdaki gibi olmalı.
        // Sadece yukarıdaki filtreleme mantığını doğru eklediğinizden emin olun.

        transactionsTableBody.innerHTML = '';

        if (Array.isArray(transactionsToDisplay) && transactionsToDisplay.length > 0) {
            transactionsToDisplay.forEach(transaction => {
                const row = transactionsTableBody.insertRow();
                const transactionTypeDisplay = getTransactionTypeDisplay(transaction.transaction_type);
                row.innerHTML = `
                    <td>${transaction.transaction_code || '-'}</td>
                    <td>${transaction.product_name || '-'}</td>
                    <td>${transaction.product_barcode || '-'}</td>
                    <td>${transaction.category_name || '-'}</td>
                    <td>${transactionTypeDisplay}</td>
                    <td>${transaction.quantity !== undefined ? transaction.quantity : '-'}</td>
                    <td>${transaction.company_name || ( (transaction.company_id === null || String(transaction.company_id) === 'null') ? 'Kendi Üretimimiz' : '-' )}</td>
                    <td>${transaction.user_full_name || transaction.user_username || '-'}</td>
                    <td>${transaction.transaction_date || '-'}</td>
                    <td>
                        ${transaction.transaction_notes 
                            ? `<button class="btn btn-info btn-sm view-note-btn" data-note="${String(transaction.transaction_notes).replace(/"/g, '&quot;')}">Not Görüntüle</button>` 
                            : '-'
                        }
                    </td>
                `;
            });
        } else {
             if (currentReportPage > 1 && totalItems > 0) {
                 transactionsTableBody.innerHTML = `<tr><td colspan="10" class="text-center">Bu sayfada kayıt bulunamadı. (Filtrelenmiş toplam ${totalItems} kayıt)</td></tr>`;
            } else {
                 transactionsTableBody.innerHTML = '<tr><td colspan="10" class="text-center">Filtrelerinize uygun kayıtlı hareket bulunamadı.</td></tr>';
            }
        }

        currentReportPageSpan.textContent = currentReportPage;
        totalReportPagesSpan.textContent = totalPages;
        prevReportPageButton.disabled = currentReportPage === 1;
        nextReportPageButton.disabled = currentReportPage === totalPages || totalItems === 0;


    } catch (error) {
        console.error('Raporlar için hareketleri listeleme hatası:', error);
        transactionsTableBody.innerHTML = '<tr><td colspan="10" class="text-center">Hareketler yüklenirken hata oluştu.</td></tr>';
        showToast(`Hareketler yüklenirken hata: ${error.message}`, 'error');
    }
}
        

        // İşlem Raporlarını CSV Olarak İndir
        exportTransactionsCsvButton.addEventListener('click', async () => {
            const originalButtonText = exportTransactionsCsvButton.innerHTML;
            exportTransactionsCsvButton.disabled = true;
            exportTransactionsCsvButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> İndiriliyor...';

            const globalSearch = reportGlobalSearchInput.value;
const startDate = reportStartDateInput.value;
            const endDate = reportEndDateInput.value;
            const productId = reportProductFilterSelect.value;
            const categoryId = reportCategoryFilterSelect.value;
            const companyId = reportCompanyFilterSelect.value;
            const transactionType = reportTransactionTypeFilterSelect.value;
            const userId = reportUserFilterSelect.value;

        const params = new URLSearchParams();
        if (globalSearch) params.append('searchQuery', globalSearch);
        if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);
            if (productId) params.append('productId', productId);
            if (categoryId) params.append('categoryId', categoryId);
            if (companyId) params.append('companyId', companyId);
            if (transactionType) params.append('type', transactionType);
            if (userId) params.append('userId', userId);

            try {
                const response = await fetchWithAuth(`${API_URL}/reports/transactions/csv?${params.toString()}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `stok_hareketleri_${new Date().toISOString().slice(0,10)}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showToast('CSV raporu başarıyla indirildi.', 'success');
                } else {
                    const errorData = await response.json();
                    showToast(errorData.message || 'CSV raporu indirilirken bir hata oluştu.', 'error');
                }
            } catch (error) {
                console.error('CSV indirme hatası:', error);
                showToast(`CSV raporu indirilirken hata: ${error.message}`, 'error');
            } finally {
                exportTransactionsCsvButton.disabled = false;
                exportTransactionsCsvButton.innerHTML = '<i class="fas fa-file-csv mr-2"></i> CSV İndir';
            }
        });

        // İşlem Raporlarını PDF Olarak İndir
        exportTransactionsPdfButton.addEventListener('click', async () => {
            const originalButtonText = exportTransactionsPdfButton.innerHTML;
            exportTransactionsPdfButton.disabled = true;
            exportTransactionsPdfButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> İndiriliyor...';

            const globalSearch = reportGlobalSearchInput.value;
const startDate = reportStartDateInput.value;
            const endDate = reportEndDateInput.value;
            const productId = reportProductFilterSelect.value;
            const categoryId = reportCategoryFilterSelect.value;
            const companyId = reportCompanyFilterSelect.value;
            const transactionType = reportTransactionTypeFilterSelect.value;
            const userId = reportUserFilterSelect.value;

        const params = new URLSearchParams();
        if (globalSearch) params.append('searchQuery', globalSearch);
        if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);
            if (productId) params.append('productId', productId);
            if (categoryId) params.append('categoryId', categoryId);
            if (companyId) params.append('companyId', companyId);
            if (transactionType) params.append('type', transactionType);
            if (userId) params.append('userId', userId);

            try {
                const response = await fetchWithAuth(`${API_URL}/reports/transactions/pdf?${params.toString()}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `stok_hareketleri_${new Date().toISOString().slice(0,10)}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showToast('PDF raporu başarıyla indirildi.', 'success');
                } else {
                    const errorData = await response.json();
                    showToast(errorData.message || 'PDF raporu indirilirken bir hata oluştu.', 'error');
                }
            } catch (error) {
                console.error('PDF indirme hatası:', error);
                showToast(`PDF raporu indirilirken hata: ${error.message}`, 'error');
            } finally {
                exportTransactionsPdfButton.disabled = false;
                exportTransactionsPdfButton.innerHTML = '<i class="fas fa-file-pdf mr-2"></i> PDF İndir';
            }
        });

        // Kullanıcı Yönetimi Tablosunu Doldur
        async function populateManageUsersTable() {
            manageUsersTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Kullanıcılar yükleniyor...</td></tr>';
            try {
                const data = await fetchWithAuth(`${API_URL}/users?page=${currentUserPage}&limit=${usersPerPage}`);
                const users = data.users;
                const totalPages = data.totalPages;

                manageUsersTableBody.innerHTML = '';

                if (Array.isArray(users) && users.length > 0) {
                    users.forEach(user => {
                        const row = manageUsersTableBody.insertRow();
                        row.innerHTML = `
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.full_name || '-'}</td>
                            <td>${user.role}</td>
                            <td>${user.is_active ? 'Evet' : 'Hayır'}</td>
                            <td>${new Date(user.created_at).toLocaleDateString('tr-TR')}</td>
                            <td>${new Date(user.last_login).toLocaleString('tr-TR')}</td>
                            <td class="action-buttons" data-roles="admin">
                                <button class="btn btn-secondary edit-user-button" data-id="${user.id}" ${localStorage.getItem('userRole') === 'admin' ? '' : 'disabled'}>Düzenle</button>
                                <button class="btn btn-danger delete-user-button" data-id="${user.id}" ${localStorage.getItem('userRole') === 'admin' ? '' : 'disabled'}>Sil</button>
                            </td>
                        `;
                    });
                } else {
                    manageUsersTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Kayıtlı kullanıcı bulunamadı.</td></tr>';
                }
                currentUserPageSpan.textContent = currentUserPage;
                totalUserPagesSpan.textContent = totalPages;
                prevUserPageButton.disabled = currentUserPage === 1;
                nextUserPageButton.disabled = currentUserPage === totalPages || totalPages === 0;

            } catch (error) {
                console.error('Kullanıcıları yükleme hatası:', error);
                manageUsersTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Kullanıcılar yüklenirken hata oluştu.</td></tr>';
                showToast(`Kullanıcılar yüklenirken hata: ${error.message}`, 'error');
            }
        }

         // ------------------- BOM YÖNETİMİ FONKSİYONLARI -------------------

        
        // BOM Sayfasını Yükle
// BOM Sayfasını Yükle (Yeni Arama Input'lu Haliyle)
async function loadManageBomPage() {
    console.log('--- loadManageBomPage ÇAĞRILDI ---');
    selectedFinishedProductId = null; // Sayfa her açıldığında seçili bitmiş ürün ID'sini sıfırla

    // Yeni "Bitmiş Ürün Arama Input'unu" temizle
    if (bomFinishedProductSearchInput) {
        bomFinishedProductSearchInput.value = '';
    } else {
        console.warn('loadManageBomPage: bomFinishedProductSearchInput elementi bulunamadı.');
    }
    // Seçili bitmiş ürün ID'sini tutan gizli input'u da temizleyebiliriz (eğer kullanıyorsak)
    // if (bomFinishedProductSelectedIdInput) bomFinishedProductSelectedIdInput.value = '';

    // Arama sonuçları div'ini temizle ve gizle
    if (bomFinishedProductResultsDiv) {
        bomFinishedProductResultsDiv.innerHTML = '';
        bomFinishedProductResultsDiv.classList.add('hidden');
    } else {
        console.warn('loadManageBomPage: bomFinishedProductResultsDiv elementi bulunamadı.');
    }

    // Reçete gösterme alanını gizle
    if (bomDisplayArea) {
        bomDisplayArea.classList.add('hidden');
    } else {
        console.warn('loadManageBomPage: bomDisplayArea elementi bulunamadı.');
    }
    
    // loadFinishedProductsForBomSelection fonksiyonunu artık çağırmıyoruz.
    // loadRawMaterialsForBomSelection çağrısını zaten kaldırmıştık.
    
    // Yeni hammadde arama input'larını ve sonuç div'ini başlangıçta temizle/gizle
    if (bomRawMaterialSearchInput) {
        bomRawMaterialSearchInput.value = '';
    } else {
         console.warn('loadManageBomPage: bomRawMaterialSearchInput elementi bulunamadı.');
    }
    if (bomRawMaterialSelectedIdInput) {
        bomRawMaterialSelectedIdInput.value = '';
    } else {
        console.warn('loadManageBomPage: bomRawMaterialSelectedIdInput elementi bulunamadı.');
    }
    if (bomRawMaterialResultsDiv) {
        bomRawMaterialResultsDiv.innerHTML = '';
        bomRawMaterialResultsDiv.classList.add('hidden');
    } else {
        console.warn('loadManageBomPage: bomRawMaterialResultsDiv elementi bulunamadı.');
    }

    // Formu doğrula (Ekle butonu pasif olabilir, çünkü henüz bitmiş ürün seçilmedi)
    if (typeof validateBomForm === 'function') {
        validateBomForm();
    } else {
        console.warn('loadManageBomPage: validateBomForm fonksiyonu TANIMLI DEĞİL!');
    }
    console.log('--- loadManageBomPage TAMAMLANDI ---');
}
        // Bitmiş Ürün Dropdown'ını Doldur
        async function loadFinishedProductsForBomSelection() {
            try {
                console.log('🔄 Bitmiş ürünler yükleniyor...');
                
                // BITMIS_URUN ve YARI_MAMUL tipindeki ürünleri çek
                const [finishedProducts, semiProducts] = await Promise.all([
                    fetchWithAuth(`${API_URL}/products?productType=BITMIS_URUN&limit=9999`),
                    fetchWithAuth(`${API_URL}/products?productType=YARI_MAMUL&limit=9999`)
                ]);

                const allProducts = [...finishedProducts.products, ...semiProducts.products];
                
                bomFinishedProductSelect.innerHTML = '<option value="">Ürün Seçiniz...</option>';
                
                if (allProducts.length > 0) {
                    allProducts.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        const productTypeDisplay = getProductTypeDisplay(product.product_type);
                        option.textContent = `${product.name} (${product.barcode}) - ${productTypeDisplay}`;
                        bomFinishedProductSelect.appendChild(option);
                    });
                    console.log(`✅ ${allProducts.length} bitmiş/yarı mamul ürün yüklendi`);
                } else {
                    bomFinishedProductSelect.innerHTML = '<option value="">Bitmiş ürün bulunamadı</option>';
                    console.log('⚠️ Hiç bitmiş/yarı mamul ürün bulunamadı');
                }
            } catch (error) {
                console.error('❌ Bitmiş ürünler yüklenirken hata:', error);
                showToast(`Bitmiş ürünler yüklenirken hata: ${error.message}`, 'error');
                bomFinishedProductSelect.innerHTML = '<option value="">Yükleme hatası</option>';
            }
        }


        // Ürün Modalındaki Ölçü Birimi Dropdown'ını Dinamik Olarak Doldurur
async function loadUnitsToProductModal() {
    console.log('--- loadUnitsToProductModal fonksiyonu ÇAĞRILDI ---');
    
    const selectElement = document.getElementById('modal-product-unit-of-measure');
    
    if (!selectElement) {
        console.error('Ürün modalı - Ölçü birimi select elementi (modal-product-unit-of-measure) bulunamadı.');
        return; // Fonksiyondan çık, select elementi yoksa devam etmenin anlamı yok.
    }

    // Mevcut seçili değeri (eğer varsa ve bir düzenleme işlemiyse) sakla,
    // böylece seçenekler yüklendikten sonra geri yükleyebiliriz.
    // Ancak, bu değeri product nesnesinden almak daha doğru olacak düzenleme sırasında.
    // Şimdilik bu satırı yoruma alabilir veya silebiliriz, çünkü düzenleme kısmında ayrıca ele alacağız.
    // const currentValue = selectElement.value; 

    try {
        // API'den tüm birimleri çek (isme göre sıralı)
        const data = await fetchWithAuth(`${API_URL}/units?limit=9999&sortBy=name&sortOrder=asc`);
        
        // API yanıtınızın yapısına göre data.units veya doğrudan data olabilir.
        // Backend taslağımızda { units: [...], ... } yapısı vardı.
        const units = data.units || []; 

        console.log('API /api/units yanıtından gelen birimler:', JSON.parse(JSON.stringify(units)));

        // Dropdown'ı temizle ve varsayılan "Birim Seçiniz..." seçeneğini ekle
        selectElement.innerHTML = '<option value="">Birim Seçiniz...</option>'; 

        if (Array.isArray(units) && units.length > 0) {
            units.forEach(unit => {
                const option = document.createElement('option');
                // DEĞER OLARAK BİRİMİN KISALTMASINI KULLANIYORUZ
                // ÇÜNKÜ products.unit_of_measure ALANI BU KISALTMAYI TUTUYOR OLMALI
                option.value = unit.abbreviation; 
                option.textContent = `${unit.name} (${unit.abbreviation})`; // Örn: Kilogram (kg)
                selectElement.appendChild(option);
            });
            console.log(`${units.length} adet ölçü birimi ürün modalına yüklendi.`);
        } else {
            console.log('Ürün modalına yüklenecek ölçü birimi bulunamadı veya API yanıtı boş.');
            // İsterseniz buraya "Tanımlı Birim Yok" gibi bir option ekleyebilirsiniz.
            // selectElement.innerHTML = '<option value="">Tanımlı Birim Yok</option>';
        }
        console.log('--- loadUnitsToProductModal fonksiyonu TAMAMLANDI ---');

    } catch (error) {
        console.error('Ürün modalı için ölçü birimleri yüklenirken hata:', error);
        if (selectElement) { // Hata durumunda da select elementini temizle
             selectElement.innerHTML = '<option value="">Birimler Yüklenemedi</option>';
        }
        showToast(`Ölçü birimleri yüklenirken hata: ${error.message}`, 'error');
        console.log('--- loadUnitsToProductModal fonksiyonu HATA ile bitti ---');
    }
}    


        // Hammadde/Yarı Mamul Dropdown'ını Doldur
        
        /*async function loadRawMaterialsForBomSelection() {
            try {
                console.log('🔄 Hammaddeler yükleniyor...');
                
                // HAMMADDE ve YARI_MAMUL tipindeki ürünleri çek
                const [rawMaterials, semiProducts] = await Promise.all([
                    fetchWithAuth(`${API_URL}/products?productType=HAMMADDE&limit=9999`),
                    fetchWithAuth(`${API_URL}/products?productType=YARI_MAMUL&limit=9999`)
                ]);

                const allMaterials = [...rawMaterials.products, ...semiProducts.products];
                
                bomRawMaterialSelect.innerHTML = '<option value="">Bileşen Seçiniz...</option>';
                
                if (allMaterials.length > 0) {
                    allMaterials.forEach(material => {
                        const option = document.createElement('option');
                        option.value = material.id;
                        option.textContent = `${material.name} (${material.barcode}) - ${material.product_type}`;
                        option.dataset.unitOfMeasure = material.unit_of_measure;
                        bomRawMaterialSelect.appendChild(option);
                    });
                    console.log(`✅ ${allMaterials.length} hammadde/yarı mamul yüklendi`);
                } else {
                    bomRawMaterialSelect.innerHTML = '<option value="">Hammadde bulunamadı</option>';
                    console.log('⚠️ Hiç hammadde/yarı mamul bulunamadı');
                }
            } catch (error) {
                console.error('❌ Hammaddeler yüklenirken hata:', error);
                showToast(`Hammaddeler yüklenirken hata: ${error.message}`, 'error');
                bomRawMaterialSelect.innerHTML = '<option value="">Yükleme hatası</option>';
            }
        }*/

        // Seçilen Ürünün Reçetesini Göster
async function displayBomForProduct(finishedProductId) {
    selectedFinishedProductId = finishedProductId; // Bu global değişken, hangi ürünün seçildiğini tutar
    
    // bomItemsTableBody elementinin varlığını kontrol et
    if (!bomItemsTableBody) {
        console.error("displayBomForProduct: bomItemsTableBody elementi bulunamadı!");
        return;
    }
    bomItemsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Reçete yükleniyor...</td></tr>';
    
    try {
        console.log(`🔄 Ürün ID ${finishedProductId} için reçete yükleniyor...`);
        
        // API'den hem ürün detaylarını (adını almak için) hem de BOM kalemlerini çekebiliriz.
        // VEYA ürün adı zaten bomFinishedProductSearchInput.value içinde mevcut.
        
        let finishedProductName = 'Seçilen Ürün'; // Varsayılan başlık

        // Eğer arama input'u varsa ve doluysa, oradan ürün adını alabiliriz.
        if (bomFinishedProductSearchInput && bomFinishedProductSearchInput.value && selectedFinishedProductId == finishedProductId) {
            // Arama input'undaki isim, tıklanan ve ID'si alınan ürünün ismi olmalı.
            // Ancak, kullanıcı input'u sonradan değiştirmiş olabilir. En güvenlisi API'den çekmek.
            // Şimdilik, searchBomRawMaterials içinde input'a set edilen ismi kullanalım.
            // Ya da daha iyisi, productResponse'dan alalım.
        }

        // Ürün bilgisini (adını almak için) ve reçetesini al
        // productResponse'dan sadece name'i alacağız, bu yüzden tüm ürünleri çekmek yerine
        // (eğer varsa) tek bir ürünü ID ile çeken bir endpoint kullanmak daha iyi olur.
        // Şimdilik, /api/products?productId=X gibi bir endpoint olmadığını varsayarak,
        // ve finishedProductName'i searchBomProductsForBom'da seçilen ürünün adından aldığımızı varsayarak devam edebiliriz.
        // Ya da productResponse'u kullanabiliriz.

        // Promise.all'dan productResponse'u kaldıralım, çünkü zaten finishedProductId'yi biliyoruz.
        // Ürün adını, arama sonuçlarından birine tıklandığında searchFinishedProductsForBom içinde
        // bomFinishedProductSearchInput.value'ya atamıştık. Onu kullanalım.
        if (bomFinishedProductSearchInput && String(selectedFinishedProductId) === String(finishedProductId)) {
            finishedProductName = bomFinishedProductSearchInput.value || 'Seçilen Ürün';
        } else {
            // Eğer ID eşleşmiyorsa veya input boşsa, API'den ürün adını çekmeyi deneyebiliriz
            // (Bu ek bir API çağrısı demek, eğer /api/products/:id endpoint'iniz varsa)
            // Şimdilik sadece 'Seçilen Ürün' olarak bırakalım veya ID'yi yazalım.
            finishedProductName = `Ürün ID: ${finishedProductId}`;
            console.warn(`displayBomForProduct: Bitmiş ürün adı bomFinishedProductSearchInput'tan alınamadı. selectedFinishedProductId: ${selectedFinishedProductId}, finishedProductId: ${finishedProductId}`);
        }


        const bomItems = await fetchWithAuth(`${API_URL}/bill-of-materials/${finishedProductId}`);

        // bomTitle elementinin varlığını kontrol et
        if (bomTitle) {
            bomTitle.textContent = `${finishedProductName} Reçetesi`;
        } else {
            console.warn("displayBomForProduct: bomTitle elementi bulunamadı!");
        }
        // bomItemsCount elementinin varlığını kontrol et
        if (bomItemsCount) {
            bomItemsCount.textContent = bomItems.length;
        } else {
            console.warn("displayBomForProduct: bomItemsCount elementi bulunamadı!");
        }
        
        bomItemsTableBody.innerHTML = ''; // Tabloyu temizle
        
        if (Array.isArray(bomItems) && bomItems.length > 0) {
            bomItems.forEach(item => {
                const row = bomItemsTableBody.insertRow();
                row.innerHTML = `
                    <td class="font-medium">${item.raw_material_name || 'Bilinmeyen'}</td>
                    <td class="text-gray-600">${item.raw_material_barcode || '-'}</td>
                    <td class="font-semibold text-blue-600">${Number(item.quantity_required) || 0}</td>
                    <td class="text-gray-600">${item.raw_material_unit_of_measure || 'adet'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-secondary btn-sm edit-bom-item-button" data-id="${item.bom_item_id}" data-current-quantity="${item.quantity_required}">
                            <i class="fas fa-edit mr-1"></i> Düzenle
                        </button>
                        <button class="btn btn-danger btn-sm delete-bom-item-button" data-id="${item.bom_item_id}">
                            <i class="fas fa-trash mr-1"></i> Sil
                        </button>
                    </td>
                `;
            });
            console.log(`✅ ${bomItems.length} reçete kalemi yüklendi.`);
        } else {
            bomItemsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">Bu ürünün henüz reçetesi bulunmuyor. Aşağıdan bileşen ekleyebilirsiniz.</td></tr>';
            console.log('ℹ️ Reçete boş.');
        }
        
        // bomDisplayArea elementinin varlığını kontrol et
        if (bomDisplayArea) {
            bomDisplayArea.classList.remove('hidden'); // Reçete gösterme alanını göster
        } else {
            console.warn("displayBomForProduct: bomDisplayArea elementi bulunamadı!");
        }
        
    } catch (error) {
        console.error(`❌ Reçete (Ürün ID: ${finishedProductId}) yüklenirken hata:`, error);
        showToast(`Reçete yüklenirken hata: ${error.message}`, 'error');
        if (bomItemsTableBody) { // Hata durumunda da tabloyu temizle
            bomItemsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-red-600">Reçete yüklenirken bir hata oluştu.</td></tr>';
        }
    }
}

    // BOM Form Validasyonu
            function validateBomForm() {
    if (!addToBomButton || !bomQuantityRequiredInput || !bomRawMaterialSelectedIdInput) return; // Elementler yoksa çık

    const rawMaterialSelected = bomRawMaterialSelectedIdInput.value !== '';
    const quantityValid = bomQuantityRequiredInput.value !== '' && parseFloat(bomQuantityRequiredInput.value) > 0;
    const finishedProductSelected = selectedFinishedProductId !== null;

    addToBomButton.disabled = !(rawMaterialSelected && quantityValid && finishedProductSelected);
}


        // Reçeteye Yeni Bileşen Ekle
        async function addBomItem() {
    // Hammadde ID'sini yeni gizli input'tan al
    const rawMaterialId = bomRawMaterialSelectedIdInput ? bomRawMaterialSelectedIdInput.value : '';
    const quantityRequired = bomQuantityRequiredInput ? parseFloat(bomQuantityRequiredInput.value) : 0;

    // Validasyon (Bu validasyonlar zaten addBomItem çağrılmadan önce validateBomForm ile yapılıyor olmalı,
    // ama burada da bir güvenlik katmanı olarak kalabilir veya daha basit tutulabilir)
    if (!selectedFinishedProductId) {
        showToast('Reçeteye bileşen eklemek için önce bir bitmiş ürün seçmelisiniz.', 'warning');
        return;
    }
    if (!rawMaterialId) {
        showToast('Lütfen bir hammadde/yarı mamul seçin veya arayın.', 'warning');
        if (bomRawMaterialSearchInput) bomRawMaterialSearchInput.focus();
        return;
    }
    if (isNaN(quantityRequired) || quantityRequired <= 0) {
        showToast('Geçerli bir miktar girin (sıfırdan büyük bir sayı).', 'warning');
        if (bomQuantityRequiredInput) bomQuantityRequiredInput.focus();
        return;
    }
    // Kendi kendine bileşen eklemeyi engelle (bu kontrol önemli)
    if (parseInt(rawMaterialId) === parseInt(selectedFinishedProductId)) {
        showToast('Bir ürün kendi kendisine bileşen olarak eklenemez.', 'error');
        return;
    }

    // Butonun orijinal metnini al ve yükleniyor durumuna geç
    const originalButtonText = addToBomButton ? addToBomButton.innerHTML : 'Reçeteye Ekle';
    if (addToBomButton) {
        addToBomButton.disabled = true;
        addToBomButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Ekleniyor...';
    }

    try {
        console.log('🔄 Reçeteye bileşen ekleniyor:', { 
            finished_product_id: parseInt(selectedFinishedProductId), 
            raw_material_id: parseInt(rawMaterialId), 
            quantity_required: quantityRequired 
        });
        
        const data = await fetchWithAuth(`${API_URL}/bill-of-materials`, {
            method: 'POST',
            body: JSON.stringify({
                finished_product_id: parseInt(selectedFinishedProductId),
                raw_material_id: parseInt(rawMaterialId),
                quantity_required: quantityRequired
            })
        });

        showToast(data.message || 'Bileşen başarıyla eklendi.', 'success'); // API'den message gelmiyorsa varsayılan mesaj
        console.log('✅ Bileşen başarıyla eklendi', data.bom_item);

        // Formu Temizle
        if (bomRawMaterialSearchInput) bomRawMaterialSearchInput.value = '';
        if (bomRawMaterialSelectedIdInput) bomRawMaterialSelectedIdInput.value = '';
        if (bomQuantityRequiredInput) bomQuantityRequiredInput.value = '';
        
        // Form temizlendikten sonra butonu tekrar doğrula/pasif yap
        if (typeof validateBomForm === 'function') {
            validateBomForm(); 
        }

        // Reçeteyi yenile
        if (selectedFinishedProductId && typeof displayBomForProduct === 'function') {
            await displayBomForProduct(selectedFinishedProductId);
        }

    } catch (error) {
        console.error('❌ Bileşen eklenirken hata:', error);
        // fetchWithAuth zaten toast mesajı gösteriyor olmalı,
        // ama isterseniz burada API'den dönen spesifik hata mesajını (error.message içinde olabilir)
        // veya genel bir hata mesajını tekrar gösterebilirsiniz.
        // showToast(error.message || 'Bileşen eklenirken bir hata oluştu.', 'error');
    } finally {
        if (addToBomButton) {
            addToBomButton.disabled = false; // validateBomForm zaten bunu ayarlayacak ama garanti olsun
            addToBomButton.innerHTML = originalButtonText;
        }
    }
}

        // Reçete Kalemi Miktarını Düzenle
        async function editBomItem(bomItemId, currentQuantity) {
            const newQuantity = prompt(`Yeni miktar girin:`, currentQuantity);
            
            if (newQuantity === null) return; // İptal edildi
            
            const parsedQuantity = parseFloat(newQuantity);
            if (isNaN(parsedQuantity) || parsedQuantity <= 0) {
                showToast('Geçerli bir miktar girin.', 'error');
                return;
            }

            try {
                console.log('🔄 Reçete kalemi güncelleniyor:', { bomItemId, parsedQuantity });
                
                const data = await fetchWithAuth(`${API_URL}/bill-of-materials/${bomItemId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        quantity_required: parsedQuantity
                    })
                });

                showToast(data.message, 'success');
                console.log('✅ Reçete kalemi başarıyla güncellendi');

                // Reçeteyi yenile
                await displayBomForProduct(selectedFinishedProductId);

            } catch (error) {
                console.error('❌ Reçete kalemi güncellenirken hata:', error);
                // Hata mesajı fetchWithAuth tarafından gösterildiği için burada tekrar göstermiyoruz
            }
        }

        // Reçete Kalemini Sil
        async function deleteBomItem(bomItemId) {
            const confirmed = await showConfirmModal('Bu bileşeni reçeteden çıkarmak istediğinizden emin misiniz?');
            if (!confirmed) return;

            try {
                console.log('🔄 Reçete kalemi siliniyor:', bomItemId);
                
                const data = await fetchWithAuth(`${API_URL}/bill-of-materials/${bomItemId}`, {
                    method: 'DELETE'
                });

                showToast(data.message, 'success');
                console.log('✅ Reçete kalemi başarıyla silindi');

                // Reçeteyi yenile
                await displayBomForProduct(selectedFinishedProductId);

            } catch (error) {
                console.error('❌ Reçete kalemi silinirken hata:', error);
                // Hata mesajı fetchWithAuth tarafından gösterildiği için burada tekrar göstermiyoruz
            }
        }

        // Denetim Kayıtlarını Yükle
        async function fetchAuditLogs() {
            auditLogsTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Denetim kayıtları yükleniyor...</td></tr>';
            try {
                const data = await fetchWithAuth(`${API_URL}/audit-logs?page=${currentAuditLogPage}&limit=${auditLogsPerPage}`);
                const auditLogs = data.auditLogs;
                const totalPages = data.totalPages;

                auditLogsTableBody.innerHTML = '';

                if (Array.isArray(auditLogs) && auditLogs.length > 0) {
                    auditLogs.forEach(log => {
                        const row = auditLogsTableBody.insertRow();
                        row.innerHTML = `
                            <td>${log.id}</td>
                            <td>${log.user_username || 'N/A'}</td>
                            <td>${log.action_type}</td>
                            <td>${log.table_name}</td>
                            <td>${log.record_id || '-'}</td>
                            <td><pre>${log.old_value ? JSON.stringify(log.old_value, null, 2) : '-'}</pre></td>
                            <td><pre>${log.new_value ? JSON.stringify(log.new_value, null, 2) : '-'}</pre></td>
                            <td>${new Date(log.timestamp).toLocaleString('tr-TR')}</td>
                        `;
                    });
                } else {
                    auditLogsTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Kayıtlı denetim kaydı bulunamadı.</td></tr>';
                }
                currentAuditLogPageSpan.textContent = currentAuditLogPage;
                totalAuditLogPagesSpan.textContent = totalPages;
                prevAuditLogPageButton.disabled = currentAuditLogPage === 1;
                nextAuditLogPageButton.disabled = currentAuditLogPage === totalPages || totalPages === 0;

            } catch (error) {
                console.error('Denetim kayıtlarını yükleme hatası:', error);
                auditLogsTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Denetim kayıtları yüklenirken hata oluştu.</td></tr>';
                showToast(`Denetim kayıtları yüklenirken hata: ${error.message}`, 'error');
            }
        }


        // Modalları ve Formları Yönetme

        // Tüm modal kapatma butonlarına event listener ekle
        document.querySelectorAll('[data-modal-close]').forEach(button => {
            button.addEventListener('click', (e) => {
                const modalId = e.target.dataset.modalClose;
                closeModal(document.getElementById(modalId));
            });
        });

        // Product Modal (Ekle/Düzenle)
       if (addNewProductButton) {
    console.log('addNewProductButton elementi bulundu ve listener ATANACAK.');
    addNewProductButton.addEventListener('click', async () => {
        console.log('addNewProductButton TIKLANDI!');

        if (typeof loadCategoriesToProductFilter === 'function') {
            console.log('loadCategoriesToProductFilter bir fonksiyon olarak TANIMLI.');
            try {
                console.log('loadCategoriesToProductFilter ÇAĞRILIYOR...');
                await loadCategoriesToProductFilter();
                console.log('loadCategoriesToProductFilter TAMAMLANDI.');
            } catch (error) {
                console.error('loadCategoriesToProductFilter çağrılırken HATA:', error);
            }
        } else {
            console.error('HATA: loadCategoriesToProductFilter TANIMLI DEĞİL!');
        }

        if (typeof loadUnitsToProductModal === 'function') {
            console.log('loadUnitsToProductModal bir fonksiyon olarak TANIMLI.');
            try {
                console.log('loadUnitsToProductModal ÇAĞRILIYOR...');
                await loadUnitsToProductModal(); // Bu fonksiyonun içinde de kendi logları var
                console.log('loadUnitsToProductModal TAMAMLANDI.');
            } catch (error) {
                console.error('loadUnitsToProductModal çağrılırken HATA:', error);
            }
        } else {
            console.error('HATA: loadUnitsToProductModal TANIMLI DEĞİL!');
        }
        
        // !!! BU SATIRLARI AKTİF HALE GETİRİN !!!
        if (productModalForm) productModalForm.reset(); // Formu temizle
        if (document.getElementById('product-modal-title')) document.getElementById('product-modal-title').textContent = 'Yeni Ürün Ekle';
        if (modalProductIdInput) modalProductIdInput.value = '';
        if (modalProductStockInput) modalProductStockInput.value = 0;
        if (modalProductMinStockLevelInput) modalProductMinStockLevelInput.value = 0;
        if (modalProductIsActiveSelect) modalProductIsActiveSelect.value = 'true';
        if (modalProductTypeSelect) modalProductTypeSelect.value = 'BITMIS_URUN';
        
        const unitSelect = document.getElementById('modal-product-unit-of-measure');
        if (unitSelect) {
            unitSelect.value = ""; // "Birim Seçiniz..." seçili kalsın
        }
        
        openModal(productModal); // Modalı aç
        // !!! YORUM SATIRLARI KALDIRILDI !!!
        
        console.log('addNewProductButton listener sonu. Modal açılmış olmalı.');
    });
} else {
    console.warn('addNewProductButton elementi (add-new-product-button ID\'li) HTML\'de bulunamadı!');
}

       if (productModalForm) {
    productModalForm.addEventListener('submit', async (e) => {
        e.preventDefault(); // Formun sayfa yenilemesini engelle

        const id = modalProductIdInput ? modalProductIdInput.value : '';
        const barcode = modalProductBarcodeInput ? modalProductBarcodeInput.value.trim() : '';
        const name = modalProductNameInput ? modalProductNameInput.value.trim() : '';
        const category_id = modalProductCategorySelect ? (modalProductCategorySelect.value ? parseInt(modalProductCategorySelect.value) : null) : null;
        const stock = modalProductStockInput ? parseInt(modalProductStockInput.value) : 0;
        const min_stock_level = modalProductMinStockLevelInput ? parseInt(modalProductMinStockLevelInput.value) : 0;
        const is_active = modalProductIsActiveSelect ? (modalProductIsActiveSelect.value === 'true') : true;
        const product_type = modalProductTypeSelect ? modalProductTypeSelect.value : 'BITMIS_URUN';
        
        // Ölçü birimini <select> elementinden alıyoruz, .trim() genellikle gereksizdir ama zararı da olmaz.
        const unit_of_measure = modalProductUnitOfMeasureInput ? modalProductUnitOfMeasureInput.value : '';

        // Temel Validasyonlar
        if (!name) {
            showToast('Ürün adı boş bırakılamaz.', 'warning');
            if (modalProductNameInput) modalProductNameInput.focus();
            return;
        }
        if (!barcode) {
            showToast('Barkod boş bırakılamaz.', 'warning');
            if (modalProductBarcodeInput) modalProductBarcodeInput.focus();
            return;
        }
        if (!product_type) { // Normalde <select> olduğu için her zaman bir değeri olur.
            showToast('Lütfen bir ürün tipi seçin.', 'warning');
            if (modalProductTypeSelect) modalProductTypeSelect.focus();
            return;
        }
        if (!unit_of_measure) { // <option value="">Birim Seçiniz...</option> seçiliyse value boş string olur.
            showToast('Lütfen bir ölçü birimi seçin.', 'warning');
            if (modalProductUnitOfMeasureInput) modalProductUnitOfMeasureInput.focus();
            return;
        }
        if (isNaN(stock) || stock < 0) {
            showToast('Stok miktarı geçerli bir sayı olmalı ve 0\'dan küçük olmamalıdır.', 'warning');
            if (modalProductStockInput) modalProductStockInput.focus();
            return;
        }
        if (isNaN(min_stock_level) || min_stock_level < 0) {
            showToast('Minimum stok seviyesi geçerli bir sayı olmalı ve 0\'dan küçük olmamalıdır.', 'warning');
            if (modalProductMinStockLevelInput) modalProductMinStockLevelInput.focus();
            return;
        }

        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL}/products/${id}` : `${API_URL}/products`;

        const payload = {
            barcode,
            name,
            category_id, // null olabilir
            stock,
            min_stock_level,
            is_active,
            product_type,
            unit_of_measure
        };

        // Butonu geçici olarak devre dışı bırak ve yükleniyor durumu göster
        const submitButton = productModalForm.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';

        try {
            const responseData = await fetchWithAuth(url, {
                method: method,
                body: JSON.stringify(payload)
            });

            showToast(responseData.message, 'success');
            closeModal(productModal); // productModal'ı kapat
            
            // Arama ve filtre değerlerini koruyarak tabloyu yenile
            const searchTerm = productSearchInput ? productSearchInput.value.trim() : "";
            await populateManageProductsTable(searchTerm); // populateManageProductsTable zaten filtreleri dikkate almalı
            
            await loadDashboardData(); // Dashboard'u yenile (stok miktarları değişmiş olabilir)

        } catch (error) {
            // fetchWithAuth zaten hata mesajını gösteriyor olmalı.
            console.error('Ürün kaydetme/güncelleme API hatası:', error);
        } finally {
            // Butonu tekrar aktif hale getir ve eski metnini yükle
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        }
    });
}

        manageProductsTableBody.addEventListener('click', async (e) => {
            // Ürün Düzenle Butonu
        if (e.target.classList.contains('edit-product-button')) {
            const productId = e.target.dataset.id;
            try {
                // Ürün detaylarını API'den çekmek idealdir.
                // Eğer backend'inizde /api/products/:id gibi bir endpoint varsa onu kullanın.
                // Örnek: const productResponse = await fetchWithAuth(`${API_URL}/products/${productId}`);
                // const product = productResponse.product; // API yanıtınıza göre

                // Şimdilik tüm ürünleri çekip içinden bulma yönteminizi koruyorum,
                // ama bunun çok sayıda ürün olduğunda yavaş olabileceğini unutmayın.
                const response = await fetchWithAuth(`${API_URL}/products?limit=9999`); 
                
                let product;
                if (response && response.products) {
                     product = response.products.find(p => String(p.id) === String(productId));
                }

                if (product) {
                    document.getElementById('product-modal-title').textContent = 'Ürün Düzenle';
                    
                    productModalForm.reset(); // Formu temizle
                    modalProductIdInput.value = product.id; // ID'yi ata

                    // Diğer alanları doldur
                    modalProductBarcodeInput.value = product.barcode || '';
                    modalProductNameInput.value = product.name || '';
                    modalProductStockInput.value = product.stock !== undefined ? product.stock : 0;
                    modalProductMinStockLevelInput.value = product.min_stock_level || 0;
                    modalProductIsActiveSelect.value = String(product.is_active);
                    modalProductTypeSelect.value = product.product_type || 'BITMIS_URUN';
                    
                    console.log('Ürün düzenleme modalı açılıyor, kategoriler ve birimler yükleniyor...');
                    // Kategorileri ve Birimleri ASENKRON olarak yükle
                    await Promise.all([
                        loadCategoriesToProductFilter(), // Kategorileri ürün modalındaki kategori select'ine yükler
                        loadUnitsToProductModal()        // Birimleri ürün modalındaki birim select'ine yükler
                    ]).catch(err => console.error("Modal için kategori/birim dropdown'ları yüklenirken hata:", err));
                    
                    // Dropdown'lar dolduktan SONRA seçili değerleri ata
                    modalProductCategorySelect.value = product.category_id || '';
                    
                    // Ölçü Birimini Seçili Hale Getir
                    const unitSelectElement = document.getElementById('modal-product-unit-of-measure');
                    if (unitSelectElement && product.unit_of_measure) {
                        unitSelectElement.value = product.unit_of_measure; // product.unit_of_measure, birimin kısaltması olmalı
                        // Atamanın başarılı olup olmadığını kontrol etmek için bir log eklenebilir:
                        if (unitSelectElement.value !== product.unit_of_measure) {
                            console.warn(`Düzenleme: Ölçü birimi "${product.unit_of_measure}" dropdown'da bulunamadı/atanamadı. Güncel select değeri: "${unitSelectElement.value}"`);
                        } else {
                            console.log(`Düzenleme: Ölçü birimi "${product.unit_of_measure}" başarıyla seçildi.`);
                        }
                    } else if (unitSelectElement) {
                        unitSelectElement.value = ""; // Eğer üründe birim tanımlı değilse "Birim Seçiniz..." seçili kalsın
                    }
                                        
                    openModal(productModal);
                } else {
                    showToast('Düzenlenecek ürün bulunamadı.', 'error');
                }
            } catch (error) {
                console.error('Ürün düzenleme için veri getirme/modal hazırlama hatası:', error);
                showToast(`Ürün bilgileri alınırken bir hata oluştu: ${error.message}`, 'error');
            }
        }
        // ... (delete-product-button kısmı aynı kalır) ...

            if (e.target.classList.contains('delete-product-button')) {
                const productId = e.target.dataset.id;
                const confirmed = await showConfirmModal('Bu ürünü silmek istediğinizden emin misiniz? Eğer ürüne bağlı stok hareketleri varsa, ürün pasif hale getirilecektir.');
                if (confirmed) {
                    try {
                        const data = await fetchWithAuth(`${API_URL}/products/${productId}`, {
                            method: 'DELETE'
                        });
                        showToast(data.message, 'success');
                        await populateManageProductsTable();
                        await loadDashboardData();
                    } catch (error) {
                        console.error('Ürün silme hatası:', error);
                        // Hata mesajı fetchWithAuth tarafından gösterildiği için burada tekrar göstermiyoruz
                    }
                }
            }
            // Kategori Ata butonu kaldırıldığı için ilgili event listener kısmı silindi.
        });


        // Category Modal (Ekle/Düzenle)
        addNewCategoryButton.addEventListener('click', () => {
            categoryModalForm.reset();
            document.getElementById('category-modal-title').textContent = 'Yeni Kategori Ekle';
            modalCategoryIdInput.value = '';
            openModal(categoryModal);
        });

        categoryModalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = modalCategoryIdInput.value;
            const name = modalCategoryNameInput.value;
            const description = modalCategoryDescriptionInput.value;

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/categories/${id}` : `${API_URL}/categories`;

            try {
                const data = await fetchWithAuth(url, {
                    method: method,
                    body: JSON.stringify({ name, description })
                });

                showToast(data.message, 'success');
                closeModal(categoryModal);
                await populateManageCategoriesTable(); // Kategori tablosunu yenile
                await loadCategoriesToProductFilter(); // Ürün filtre ve modal kategorilerini yenile
                await loadCategoriesToReportFilter(); // Rapor filtresi kategorilerini yenile
            } catch (error) {
                // Hata mesajı fetchWithAuth tarafından gösterildiği için burada tekrar göstermiyoruz
            }
        });

        manageCategoriesTableBody.addEventListener('click', async (e) => {
            if (e.target.classList.contains('edit-category-button')) {
                const categoryId = e.target.dataset.id;
                try {
                    const data = await fetchWithAuth(`${API_URL}/categories?limit=9999`); // Tüm kategorileri çek
                    const categories = data.categories;
                    const category = categories.find(c => c.id == categoryId);

                    if (category) {
                        document.getElementById('category-modal-title').textContent = 'Kategori Düzenle';
                        modalCategoryIdInput.value = category.id;
                        modalCategoryNameInput.value = category.name;
                        modalCategoryDescriptionInput.value = category.description || '';
                        openModal(categoryModal);
                    } else {
                        showToast('Kategori bulunamadı.', 'error');
                    }
                } catch (error) {
                    console.error('Kategori düzenleme hatası:', error);
                    showToast(`Kategori düzenlenirken hata: ${error.message}`, 'error');
                }
            }

            if (e.target.classList.contains('delete-category-button')) {
                const categoryId = e.target.dataset.id;
                const confirmed = await showConfirmModal('Bu kategoriyi silmek istediğinizden emin misiniz? Bu kategoriye bağlı ürünler "Kategorisiz" olarak atanacaktır.');
                if (confirmed) {
                    try {
                        const data = await fetchWithAuth(`${API_URL}/categories/${categoryId}`, {
                            method: 'DELETE'
                        });
                        showToast(data.message, 'success');
                        await populateManageCategoriesTable();
                        await loadCategoriesToProductFilter();
                        await loadCategoriesToReportFilter();
                    } catch (error) {
                        console.error('Kategori silme hatası:', error);
                        // Hata mesajı fetchWithAuth tarafından gösterildiği için burada tekrar göstermiyoruz
                    }
                }
            }
        });


        // Company Modal (Ekle/Düzenle)
        addNewCompanyButton.addEventListener('click', () => {
            companyModalForm.reset();
            document.getElementById('company-modal-title').textContent = 'Yeni Firma Ekle';
            modalCompanyIdInput.value = '';
            modalCompanyTypeSelect.value = 'both'; // Varsayılan değer
            openModal(companyModal);
        });

        companyModalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = modalCompanyIdInput.value;
            const name = modalCompanyNameInput.value;
            const contact_person = modalCompanyContactPersonInput.value;
            const phone = modalCompanyPhoneInput.value;
            const address = modalCompanyAddressInput.value;
            const tax_office = modalCompanyTaxOfficeInput.value;
            const tax_number = modalCompanyTaxNumberInput.value;
            const type = modalCompanyTypeSelect.value;

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/companies/${id}` : `${API_URL}/companies`;

            try {
                const data = await fetchWithAuth(url, {
                    method: method,
                    body: JSON.stringify({ name, contact_person, phone, address, tax_office, tax_number, type })
                });

                showToast(data.message, 'success');
                closeModal(companyModal);
                await populateManageCompaniesTable();
                
                await loadCompaniesToReportFilter(); // Raporlar için firmaları yenile
            } catch (error) {
                console.error('Firma kaydetme hatası:', error);
                // Hata mesajı fetchWithAuth tarafından gösterildiği için burada tekrar göstermiyoruz
            }
        });

        manageCompaniesTableBody.addEventListener('click', async (e) => {
            // Firma detay sayfasına gitme
            if (e.target.closest('.company-row') && !e.target.classList.contains('edit-company-button') && !e.target.classList.contains('delete-company-button')) {
                const companyId = e.target.closest('.company-row').dataset.companyId;
                window.location.hash = `company-detail?id=${companyId}`;
                return; // Edit/Delete butonlarına tıklamayı engelle
            }

            if (e.target.classList.contains('edit-company-button')) {
                const companyId = e.target.dataset.id;
                try {
                    const data = await fetchWithAuth(`${API_URL}/companies/${companyId}`);
                    const company = data.company;

                    if (company) {
                        document.getElementById('company-modal-title').textContent = 'Firma Düzenle';
                        modalCompanyIdInput.value = company.id;
                        modalCompanyNameInput.value = company.name;
                        modalCompanyContactPersonInput.value = company.contact_person || '';
                        modalCompanyPhoneInput.value = company.phone || '';
                        modalCompanyAddressInput.value = company.address || '';
                        modalCompanyTaxOfficeInput.value = company.tax_office || '';
                        modalCompanyTaxNumberInput.value = company.tax_number || '';
                        modalCompanyTypeSelect.value = company.type || 'both';
                        openModal(companyModal);
                    } else {
                        showToast('Firma bulunamadı.', 'error');
                    }
                } catch (error) {
                    console.error('Firma düzenleme hatası:', error);
                    showToast(`Firma düzenlenirken hata: ${error.message}`, 'error');
                }
            }

            if (e.target.classList.contains('delete-company-button')) {
                const companyId = e.target.dataset.id;
                const confirmed = await showConfirmModal('Bu firmayı silmek istediğinizden emin misiniz? Bu firmaya bağlı stok hareketleri varsa silinemez.');
                if (confirmed) {
                    try {
                        const data = await fetchWithAuth(`${API_URL}/companies/${companyId}`, {
                            method: 'DELETE'
                        });
                        showToast(data.message, 'success');
                        await populateManageCompaniesTable();
                        
                        await loadCompaniesToReportFilter();
                    } catch (error) {
                        console.error('Firma silme hatası:', error);
                        // Hata mesajı fetchWithAuth tarafından gösterildiği için burada tekrar göstermiyoruz
                    }
                }
            }
        });

        // Firma Detay Sayfası Butonları
        backToCompaniesButton.addEventListener('click', () => {
            window.location.hash = '#manage-companies';
        });

        filterCompanyReportsButton.addEventListener('click', async () => {
    currentCompanyReportPage = 1;
    if (currentCompanyId) {
        await fetchCompanyTransactions();
    }
});

// Real-time global search için firma rapor arama inputu
let companyReportSearchTimeout;
companyReportGlobalSearchInput.addEventListener('input', () => {
    clearTimeout(companyReportSearchTimeout);
    companyReportSearchTimeout = setTimeout(async () => {
        currentCompanyReportPage = 1;
        if (currentCompanyId) {
            await fetchCompanyTransactions();
        }
    }, 700); // 700ms bekle
});

        clearCompanyReportFilterButton.addEventListener('click', async () => {
    companyReportGlobalSearchInput.value = '';
    companyReportStartDateInput.value = '';
    companyReportEndDateInput.value = '';
            companyReportProductFilterSelect.value = '';
            companyReportTransactionTypeFilterSelect.value = '';
            currentCompanyReportPage = 1;
            if (currentCompanyId) {
                await fetchCompanyTransactions();
            }
        });

        exportCompanyTransactionsCsvButton.addEventListener('click', async () => {
            if (!currentCompanyId) {
                showToast('Firma seçili değil.', 'warning');
                return;
            }

            const originalButtonText = exportCompanyTransactionsCsvButton.innerHTML;
            exportCompanyTransactionsCsvButton.disabled = true;
            exportCompanyTransactionsCsvButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> İndiriliyor...';

            const startDate = companyReportStartDateInput.value;
            const endDate = companyReportEndDateInput.value;
            const productId = companyReportProductFilterSelect.value;
            const transactionType = companyReportTransactionTypeFilterSelect.value;

            const params = new URLSearchParams();
if (globalSearch) params.append('searchQuery', globalSearch);
if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);
            if (productId) params.append('productId', productId);
            if (transactionType) params.append('type', transactionType);
            params.append('companyId', currentCompanyId); // Firma ID'sini parametre olarak ekle

            try {
                const response = await fetchWithAuth(`${API_URL}/reports/export-transactions?${params.toString()}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `firma_${currentCompanyId}_hareketleri_${new Date().toISOString().slice(0,10)}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showToast('CSV raporu başarıyla indirildi.', 'success');
                } else {
                    const errorData = await response.json();
                    showToast(errorData.message || 'CSV raporu indirilirken bir hata oluştu.', 'error');
                }
            } catch (error) {
                console.error('CSV indirme hatası:', error);
                showToast(`CSV raporu indirilirken hata: ${error.message}`, 'error');
            } finally {
                exportCompanyTransactionsCsvButton.disabled = false;
                exportCompanyTransactionsCsvButton.innerHTML = originalButtonText;
            }
        });

        // Firma Hareketlerini PDF Olarak İndir
        exportCompanyTransactionsPdfButton.addEventListener('click', async () => {
            if (!currentCompanyId) {
                showToast('Firma seçili değil.', 'warning');
                return;
            }

            const originalButtonText = exportCompanyTransactionsPdfButton.innerHTML;
            exportCompanyTransactionsPdfButton.disabled = true;
            exportCompanyTransactionsPdfButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> İndiriliyor...';

            const globalSearch = companyReportGlobalSearchInput.value;
const startDate = companyReportStartDateInput.value;
const endDate = companyReportEndDateInput.value;
            const productId = companyReportProductFilterSelect.value;
            const transactionType = companyReportTransactionTypeFilterSelect.value;

            const params = new URLSearchParams();
            if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);
            if (productId) params.append('productId', productId);
            if (transactionType) params.append('type', transactionType);
            params.append('companyId', currentCompanyId);

            try {
                const response = await fetchWithAuth(`${API_URL}/reports/transactions/pdf?${params.toString()}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `firma_${currentCompanyId}_hareketleri_${new Date().toISOString().slice(0,10)}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showToast('PDF raporu başarıyla indirildi.', 'success');
                } else {
                    const errorData = await response.json();
                    showToast(errorData.message || 'PDF raporu indirilirken bir hata oluştu.', 'error');
                }
            } catch (error) {
                console.error('PDF indirme hatası:', error);
                showToast(`PDF raporu indirilirken hata: ${error.message}`, 'error');
            } finally {
                exportCompanyTransactionsPdfButton.disabled = false;
                exportCompanyTransactionsPdfButton.innerHTML = originalButtonText;
            }
        });

        prevCompanyReportPageButton.addEventListener('click', async () => {
            if (currentCompanyReportPage > 1) {
                currentCompanyReportPage--;
                if (currentCompanyId) {
                    await fetchCompanyTransactions();
                }
            }
        });
        nextCompanyReportPageButton.addEventListener('click', async () => {
            if (currentCompanyReportPage < parseInt(totalCompanyReportPagesSpan.textContent)) {
                currentCompanyReportPage++;
                if (currentCompanyId) {
                    await fetchCompanyTransactions();
                }
            }
        });


        // User Modal (Ekle/Düzenle)
        addNewUserButton.addEventListener('click', () => {
            userModalForm.reset();
            document.getElementById('user-modal-title').textContent = 'Yeni Kullanıcı Ekle';
            modalUserIdInput.value = '';
            modalUserPasswordInput.required = true; // Yeni kullanıcı için şifre zorunlu
            openModal(userModal);
        });

        userModalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = modalUserIdInput.value;
            const username = modalUserUsernameInput.value;
            const password = modalUserPasswordInput.value;
            const full_name = modalUserFullNameInput.value;
            const role = modalUserRoleSelect.value;
            const is_active = modalUserIsActiveSelect.value === 'true';

            let body = { username, full_name, role, is_active };
            if (password) { // Şifre boş değilse gönder
                body.password = password;
            }

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/users/${id}` : `${API_URL}/users`; // Yeni kullanıcı endpoint'i /api/users

            try {
                const data = await fetchWithAuth(url, {
                    method: method,
                    body: JSON.stringify(body)
                });

                showToast(data.message, 'success');
                closeModal(userModal);
                await populateManageUsersTable();
                await loadUsersToReportFilter();
            } catch (error) {
                console.error('Kullanıcı kaydetme hatası:', error);
                // Hata mesajı fetchWithAuth tarafından gösterildiği için burada tekrar göstermiyoruz
            }
        });

        manageUsersTableBody.addEventListener('click', async (e) => {
            if (e.target.classList.contains('edit-user-button')) {
                const userId = e.target.dataset.id;
                try {
                    const data = await fetchWithAuth(`${API_URL}/users?limit=9999`); // Tüm kullanıcıları çek
                    const users = data.users;
                    const user = users.find(u => u.id == userId);

                    if (user) {
                        document.getElementById('user-modal-title').textContent = 'Kullanıcı Düzenle';
                        modalUserIdInput.value = user.id;
                        modalUserUsernameInput.value = user.username;
                        modalUserFullNameInput.value = user.full_name || '';
                        modalUserRoleSelect.value = user.role;
                        modalUserIsActiveSelect.value = String(user.is_active);
                        modalUserPasswordInput.value = ''; // Şifreyi boş bırak (değiştirmek istemiyorsa)
                        modalUserPasswordInput.required = false; // Şifre zorunluluğunu kaldır
                        openModal(userModal);
                    } else {
                        showToast('Kullanıcı bulunamadı.', 'error');
                    }
                } catch (error) {
                    console.error('Kullanıcı düzenleme hatası:', error);
                    showToast(`Kullanıcı düzenlenirken hata: ${error.message}`, 'error');
                }
            }

            if (e.target.classList.contains('delete-user-button')) {
                const userId = e.target.dataset.id;
                const confirmed = await showConfirmModal('Bu kullanıcıyı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.');
                if (confirmed) {
                    try {
                        const data = await fetchWithAuth(`${API_URL}/users/${userId}`, {
                            method: 'DELETE'
                        });
                        showToast(data.message, 'success');
                        await populateManageUsersTable();
                        await loadUsersToReportFilter();
                    } catch (error) {
                        console.error('Kullanıcı silme hatası:', error);
                        // Hata mesajı fetchWithAuth tarafından gösterildiği için burada tekrar göstermiyoruz
                    }
                }
            }
        });

        // Onay Modalı Butonları
        confirmYesButton.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback(true);
            }
        });

        confirmNoButton.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback(false);
            }
        });


        // Event Listeners ve Başlangıç İşlemleri
        document.addEventListener('DOMContentLoaded', () => {


            // BOM Bitmiş Ürün Arama için global değişken
let bomFinishedProductSearchTimeout;

if (bomFinishedProductSearchInput && bomFinishedProductResultsDiv) {
    bomFinishedProductSearchInput.addEventListener('input', () => {
        clearTimeout(bomFinishedProductSearchTimeout);
        const query = bomFinishedProductSearchInput.value.trim();
        
        selectedFinishedProductId = null; // Arama yapıldığında seçili Bitmiş Ürün ID'sini temizle
        if (bomDisplayArea) bomDisplayArea.classList.add('hidden'); // Reçete alanını gizle
        if (typeof validateBomForm === 'function') validateBomForm(); // Buton durumunu güncelle

        if (query.length < 2) { // En az 2 karakter girilince ara
            bomFinishedProductResultsDiv.innerHTML = '';
            bomFinishedProductResultsDiv.classList.add('hidden');
            return;
        }

        bomFinishedProductSearchTimeout = setTimeout(async () => {
            await searchFinishedProductsForBom(query);
        }, 300); // 300ms debounce
    });

    // Sonuç listesi dışına tıklayınca listeyi gizle (hammadde aramayla aynı mantık)
    document.addEventListener('click', function(event) {
        if (bomFinishedProductSearchInput && bomFinishedProductResultsDiv) {
            const isClickInsideSearch = bomFinishedProductSearchInput.contains(event.target);
            const isClickInsideResults = bomFinishedProductResultsDiv.contains(event.target);
            if (!isClickInsideSearch && !isClickInsideResults) {
                bomFinishedProductResultsDiv.classList.add('hidden');
            }
        }
    });
}

async function searchFinishedProductsForBom(query) {
    if (!bomFinishedProductResultsDiv || !bomFinishedProductSearchInput) return;
    try {
        // Sadece BITMIS_URUN ve YARI_MAMUL tipindeki ürünleri ara
        const response = await fetchWithAuth(`${API_URL}/products?search=${encodeURIComponent(query)}&productType=BITMIS_URUN,YARI_MAMUL&limit=10&sortBy=name&sortOrder=asc`);
        const products = response.products || [];
        
        bomFinishedProductResultsDiv.innerHTML = ''; // Önceki sonuçları temizle

        if (products.length > 0) {
            products.forEach(product => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('search-result-item', 'p-2', 'hover:bg-gray-100', 'cursor-pointer');
                // getProductTypeDisplay fonksiyonunuzun var olduğunu varsayıyorum
                itemDiv.innerHTML = `<span>${product.name} (${product.barcode}) - ${getProductTypeDisplay(product.product_type)}</span>`; 
                itemDiv.addEventListener('click', async () => {
                    bomFinishedProductSearchInput.value = product.name; // Seçilen ürün adını input'a yaz
                    selectedFinishedProductId = product.id; // Global değişkeni güncelle
                    
                    console.log('🔄 Bitmiş ürün seçildi (arama ile):', selectedFinishedProductId, product.name);
                    
                    bomFinishedProductResultsDiv.innerHTML = ''; 
                    bomFinishedProductResultsDiv.classList.add('hidden');
                    
                    if (typeof displayBomForProduct === 'function') {
                        await displayBomForProduct(selectedFinishedProductId); // Seçilen ürünün reçetesini göster
                    }
                    if (typeof validateBomForm === 'function') {
                        validateBomForm(); // Formu doğrula
                    }
                });
                bomFinishedProductResultsDiv.appendChild(itemDiv);
            });
            if (bomFinishedProductResultsDiv.children.length > 0) {
                 bomFinishedProductResultsDiv.classList.remove('hidden');
            } else {
                 bomFinishedProductResultsDiv.classList.add('hidden');
            }
        } else {
            bomFinishedProductResultsDiv.innerHTML = '<div class="p-2 text-gray-500">Bitmiş ürün/yarı mamul bulunamadı.</div>';
            bomFinishedProductResultsDiv.classList.remove('hidden');
        }
    } catch (error) {
        console.error('BOM için Bitmiş Ürün arama hatası:', error);
        if (bomFinishedProductResultsDiv) {
            bomFinishedProductResultsDiv.innerHTML = '<div class="p-2 text-red-500">Arama sırasında hata oluştu.</div>';
            bomFinishedProductResultsDiv.classList.remove('hidden');
        }
    }
}


            // BOM hammadde arama için global değişken
        let bomRawMaterialSearchTimeout;


if (bomRawMaterialSearchInput && bomRawMaterialResultsDiv && bomRawMaterialSelectedIdInput) {
    bomRawMaterialSearchInput.addEventListener('input', () => {
        clearTimeout(bomRawMaterialSearchTimeout);
        const query = bomRawMaterialSearchInput.value.trim();
        bomRawMaterialSelectedIdInput.value = ''; // Arama yapıldığında seçili ID'yi temizle
        validateBomForm(); // Seçim kalktığı için butonu pasif yapabilir

        if (query.length < 2) { // En az 2 karakter girilince ara
            bomRawMaterialResultsDiv.innerHTML = '';
            bomRawMaterialResultsDiv.classList.add('hidden');
            return;
        }

        bomRawMaterialSearchTimeout = setTimeout(async () => {
            await searchBomRawMaterials(query);
        }, 300); // 300ms debounce
    });

    // Sonuç listesi dışına tıklayınca listeyi gizle
    document.addEventListener('click', function(event) {
        if (bomRawMaterialSearchInput && bomRawMaterialResultsDiv) {
            const isClickInsideSearch = bomRawMaterialSearchInput.contains(event.target);
            const isClickInsideResults = bomRawMaterialResultsDiv.contains(event.target);
            if (!isClickInsideSearch && !isClickInsideResults) {
                bomRawMaterialResultsDiv.classList.add('hidden');
            }
        }
    });
}

async function searchBomRawMaterials(query) {
    if (!bomRawMaterialResultsDiv || !bomRawMaterialSelectedIdInput || !bomRawMaterialSearchInput) return;
    try {
        // API'ye productType=HAMMADDE,YARI_MAMUL gönderiyoruz.
        // Backend /api/products endpoint'inizin bu productType filtresini desteklediğinden emin olun.
        // app.js'deki GET /api/products endpoint'i productType filtresini destekliyordu.
        const response = await fetchWithAuth(`${API_URL}/products?search=${encodeURIComponent(query)}&productType=HAMMADDE,YARI_MAMUL&limit=10&sortBy=name&sortOrder=asc`);
        const products = response.products || [];
        
        bomRawMaterialResultsDiv.innerHTML = ''; // Önceki sonuçları temizle

        if (products.length > 0) {
            products.forEach(product => {
                // Reçetesini oluşturduğumuz bitmiş ürünün kendisini hammadde listesinde göstermeyelim.
                if (selectedFinishedProductId && product.id === parseInt(selectedFinishedProductId)) {
                    return; 
                }

                const itemDiv = document.createElement('div');
                itemDiv.classList.add('search-result-item', 'p-2', 'hover:bg-gray-100', 'cursor-pointer');
                itemDiv.innerHTML = `<span>${product.name} (${product.barcode}) - ${getProductTypeDisplay(product.product_type)}</span>`; // getProductTypeDisplay fonksiyonunu kullan
                itemDiv.addEventListener('click', () => {
                    bomRawMaterialSearchInput.value = product.name; // Seçilen ürün adını input'a yaz
                    bomRawMaterialSelectedIdInput.value = product.id; // Seçilen ürünün ID'sini gizli input'a yaz
                    bomRawMaterialResultsDiv.innerHTML = ''; // Sonuçları temizle
                    bomRawMaterialResultsDiv.classList.add('hidden'); // Sonuç listesini gizle
                    validateBomForm(); // Formu doğrula (Reçeteye Ekle butonu aktif olabilir)
                });
                bomRawMaterialResultsDiv.appendChild(itemDiv);
            });
            if (bomRawMaterialResultsDiv.children.length > 0) {
                 bomRawMaterialResultsDiv.classList.remove('hidden'); // Sonuç varsa listeyi göster
            } else {
                 bomRawMaterialResultsDiv.classList.add('hidden');
            }
        } else {
            bomRawMaterialResultsDiv.innerHTML = '<div class="p-2 text-gray-500">Sonuç bulunamadı.</div>';
            bomRawMaterialResultsDiv.classList.remove('hidden');
        }
    } catch (error) {
        console.error('BOM hammadde arama hatası:', error);
        if (bomRawMaterialResultsDiv) {
            bomRawMaterialResultsDiv.innerHTML = '<div class="p-2 text-red-500">Arama sırasında hata oluştu.</div>';
            bomRawMaterialResultsDiv.classList.remove('hidden');
        }
    }
}


            // Barkod arama butonu (Raporlar Sayfası)
const barcodeSearchReportsButton = document.getElementById('barcode-search-reports-button');
if (barcodeSearchReportsButton) {
    barcodeSearchReportsButton.addEventListener('click', async () => {
        console.log("Barkod Ara butonuna tıklandı."); // DEBUG LOG
        const barcode = prompt('Aranacak barkodu girin:');
        console.log("Prompt'tan gelen barkod:", barcode); // DEBUG LOG

        if (barcode && barcode.trim() !== "") { // Kullanıcı bir şey girdiyse ve İptal demediyse
            if (reportGlobalSearchInput) { // reportGlobalSearchInput elementinin varlığını kontrol et
                reportGlobalSearchInput.value = barcode.trim(); // Barkodu genel arama kutusuna yaz
                console.log("reportGlobalSearchInput'a atanan barkod:", reportGlobalSearchInput.value); // DEBUG LOG
            } else {
                console.warn('reportGlobalSearchInput elementi bulunamadı. Barkod arama kutuya yazılamadı.');
                // İsteğe bağlı olarak kullanıcıya bir toast mesajı da gösterebilirsiniz.
                // showToast('Genel arama kutusu bulunamadı, barkod arama yapılamıyor.', 'error');
                // return; // Eğer genel arama kutusu yoksa devam etmenin anlamı yoksa buradan çıkılabilir.
            }
            currentReportPage = 1; // Aramayı ilk sayfadan başlat
            console.log("fetchAllTransactionsForReports çağrılıyor (barkod araması için)..."); // DEBUG LOG
            await fetchAllTransactionsForReports(); // Raporları yeniden yükle
        } else if (barcode !== null) { // Kullanıcı bir şey girmedi (boş bıraktı) ama İptal'e de basmadı
            showToast('Lütfen geçerli bir barkod girin.', 'warning');
        }
        // Eğer barcode === null ise (kullanıcı prompt'ta İptal'e bastı), hiçbir şey yapma.
    });
} else {
    console.warn("barcode-search-reports-button HTML element (ID'si ile) bulunamadı.");
}


            // DOMContentLoaded veya script'inizin uygun bir yerinde:

// "Yeni Birim Ekle" Butonu
if (addNewUnitButton) {
    addNewUnitButton.addEventListener('click', () => {
        unitModalForm.reset(); // Formu temizle
        if (modalUnitId) modalUnitId.value = ''; // Gizli ID'yi temizle
        if (document.getElementById('unit-modal-title')) {
            document.getElementById('unit-modal-title').textContent = 'Yeni Birim Ekle';
        }
        openModal(unitModal); // unitModal'ı aç (Bu fonksiyonunuz zaten var)
    });
}

// Birim Ekleme/Düzenleme Formu Gönderildiğinde
if (unitModalForm) {
    unitModalForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = modalUnitId ? modalUnitId.value : '';
        const name = modalUnitName ? modalUnitName.value.trim() : '';
        const abbreviation = modalUnitAbbreviation ? modalUnitAbbreviation.value.trim() : '';

        if (!name || !abbreviation) {
            showToast('Birim adı ve kısaltması boş bırakılamaz.', 'warning');
            return;
        }

        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL}/units/${id}` : `${API_URL}/units`;

        try {
            const data = await fetchWithAuth(url, {
                method: method,
                body: JSON.stringify({ name, abbreviation })
            });

            showToast(data.message, 'success');
            closeModal(unitModal); // unitModal'ı kapat
            await populateManageUnitsTable(unitSearchInput ? unitSearchInput.value.trim() : ""); // Birim tablosunu yenile
            
            // Ürün modalındaki birimler listesini de güncellemek isteyebiliriz,
            // çünkü yeni birim eklendi veya mevcut birim güncellendi.
            // Bu fonksiyonun var olduğunu ve doğru çalıştığını varsayıyorum:
            if (typeof loadUnitsToProductModal === 'function') {
                await loadUnitsToProductModal();
            }

        } catch (error) {
            // Hata mesajı fetchWithAuth tarafından zaten gösteriliyor olmalı
            console.error('Birim kaydetme/güncelleme hatası:', error);
        }
    });
}

// Birim Tablosundaki Düzenle/Sil Butonları
if (manageUnitsTableBody) {
    manageUnitsTableBody.addEventListener('click', async (e) => {
        const target = e.target;

        // Birim Düzenle
        if (target.classList.contains('edit-unit-button')) {
            const unitId = target.dataset.id;
            const unitName = target.dataset.name;
            const unitAbbreviation = target.dataset.abbreviation;

            if (modalUnitId) modalUnitId.value = unitId;
            if (modalUnitName) modalUnitName.value = unitName;
            if (modalUnitAbbreviation) modalUnitAbbreviation.value = unitAbbreviation;
            
            if (document.getElementById('unit-modal-title')) {
                document.getElementById('unit-modal-title').textContent = 'Birimi Düzenle';
            }
            openModal(unitModal);
        }

        // Birim Sil
        if (target.classList.contains('delete-unit-button')) {
            const unitId = target.dataset.id;
            const confirmed = await showConfirmModal('Bu birimi silmek istediğinizden emin misiniz? Eğer bu birim ürünlerde kullanılıyorsa silinemeyebilir.'); // showConfirmModal fonksiyonunuzun var olduğunu varsayıyorum

            if (confirmed) {
                try {
                    const data = await fetchWithAuth(`${API_URL}/units/${unitId}`, {
                        method: 'DELETE'
                    });
                    showToast(data.message, 'success');
                    await populateManageUnitsTable(unitSearchInput ? unitSearchInput.value.trim() : ""); // Birim tablosunu yenile
                    
                    if (typeof loadUnitsToProductModal === 'function') {
                        await loadUnitsToProductModal();
                    }
                } catch (error) {
                    // Hata fetchWithAuth'ta zaten gösteriliyor.
                    console.error('Birim silme hatası:', error);
                }
            }
        }
    });
}
            
            
            // Menü öğelerine tıklama olayları
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const page = e.target.closest('.menu-item').dataset.page;
                    // showContent fonksiyonu URL hash'ini güncelleyecektir, bu yüzden direkt showPage çağırmaya gerek yok
                    // window.location.hash = page; // showContent içinde zaten var
                    await showContent(page);
                });
            });


        
            // Kategori Arama (YENİ)
            if (categorySearchInput) {
                console.log('Kategori arama input elementi bulundu:', categorySearchInput); // EKLENDİ
                let categorySearchTimeout;
                categorySearchInput.addEventListener('input', () => {
                    clearTimeout(categorySearchTimeout);
                    categorySearchTimeout = setTimeout(async () => {
                        currentCategoryPage = 1; // Arama yapıldığında ilk sayfaya dön
                        await populateManageCategoriesTable(categorySearchInput.value.trim());
                    }, 500); // 500ms debounce süresi
                });
            }

            // Kategori Arama
if (categorySearchInput) {
    console.log('Kategori arama input elementi bulundu:', categorySearchInput);
    let categorySearchTimeout;
    categorySearchInput.addEventListener('input', () => {
        const currentSearchTerm = categorySearchInput.value.trim();
        console.log(`Kategori arama input değeri değişti: "${currentSearchTerm}"`);
        clearTimeout(categorySearchTimeout);
        categorySearchTimeout = setTimeout(async () => {
            console.log(`DEBOUNCE - Kategori araması tetikleniyor. Terim: "${currentSearchTerm}"`);
            currentCategoryPage = 1; 
            await populateManageCategoriesTable(currentSearchTerm);
        }, 700); // Debounce sürenizi buradan ayarlayabilirsiniz (örn: 500 veya 300)
    });
} else {
    console.warn('Kategori arama input elementi (category-search-input) bulunamadı!');
}

// Birim Arama
if (unitSearchInput) {
    console.log('Birim arama input elementi bulundu:', unitSearchInput);
    let unitSearchTimeout;
    unitSearchInput.addEventListener('input', () => {
        const currentSearchTerm = unitSearchInput.value.trim();
        console.log(`Birim arama input değeri değişti: "${currentSearchTerm}"`);
        clearTimeout(unitSearchTimeout);
        unitSearchTimeout = setTimeout(async () => {
            console.log(`DEBOUNCE - Birim araması tetikleniyor. Terim: "${currentSearchTerm}"`);
            currentUnitPage = 1;
            await populateManageUnitsTable(currentSearchTerm);
        }, 700); // Debounce sürenizi buradan ayarlayabilirsiniz
    });
} else {
    console.warn('Birim arama input elementi (unit-search-input) bulunamadı!');
}

            // Birim Yönetimi Pagination Butonları (YENİ)
            if (prevUnitPageButton) {
                prevUnitPageButton.addEventListener('click', async () => {
                    if (currentUnitPage > 1) {
                        currentUnitPage--;
                        await populateManageUnitsTable(unitSearchInput ? unitSearchInput.value.trim() : "");
                    }
                });
            }
            if (nextUnitPageButton) {
                nextUnitPageButton.addEventListener('click', async () => {
                    const totalPages = totalUnitPagesSpan ? parseInt(totalUnitPagesSpan.textContent) : 1;
                    if (currentUnitPage < totalPages) {
                        currentUnitPage++;
                        await populateManageUnitsTable(unitSearchInput ? unitSearchInput.value.trim() : "");
                    }
                });
            }


            // Hamburger menü butonu
            if (hamburgerMenuButton && sidebarDiv) {
                hamburgerMenuButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sidebarDiv.classList.toggle('open');

                    if (window.innerWidth <= 991) { // Mobil
                        if (sidebarDiv.classList.contains('open')) {
                            document.documentElement.classList.add('sidebar-active'); // Yatay kaydırmayı engelle
                        } else {
                            document.documentElement.classList.remove('sidebar-active');
                        }
                    } else { // Masaüstü
                        mainContentWrapperDiv.classList.toggle('sidebar-open');
                        document.documentElement.classList.remove('sidebar-active'); // Masaüstünde bu sınıfa gerek yok
                    }
                    hamburgerMenuButton.textContent = sidebarDiv.classList.contains('open') ? '✖' : '☰';
                });
            }

            // Menü dışına tıklayınca mobil menüyü kapatma
            if (mainContentWrapperDiv && sidebarDiv && hamburgerMenuButton) {
                mainContentWrapperDiv.addEventListener('click', function(event) {
                    if (window.innerWidth <= 991 && sidebarDiv.classList.contains('open') &&
                        !sidebarDiv.contains(event.target) &&
                        event.target !== hamburgerMenuButton &&
                        !hamburgerMenuButton.contains(event.target)) {
                        sidebarDiv.classList.remove('open');
                        hamburgerMenuButton.textContent = '☰';
                        document.documentElement.classList.remove('sidebar-active'); // Yatay kaydırmayı kaldır
                    }
                });
            }

            // Login formu için event listener
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            // Logout butonu
            if (logoutButton) {
                logoutButton.addEventListener('click', logoutUser);
            }

            // Ürün Yönetimi Filtreleme ve Pagination
filterProductsButton.addEventListener('click', async () => {
    currentProductPage = 1;
    await populateManageProductsTable();
});

// Real-time search için ürün arama inputu
let productSearchTimeout;
productSearchInput.addEventListener('input', () => {
    clearTimeout(productSearchTimeout);
    productSearchTimeout = setTimeout(async () => {
        currentProductPage = 1;
        await populateManageProductsTable();
    }, 500); // 500ms bekle
});
            clearProductFilterButton.addEventListener('click', async () => {
                productSearchInput.value = '';
                productStatusFilterSelect.value = 'all';
                productCategoryFilterSelect.value = '';
                productSortBySelect.value = 'id_asc'; // Sıralamayı varsayılana çek
                currentProductPage = 1;
                await populateManageProductsTable();
            });
            prevProductPageButton.addEventListener('click', async () => {
                if (currentProductPage > 1) {
                    currentProductPage--;
                    await populateManageProductsTable();
                }
            });
            nextProductPageButton.addEventListener('click', async () => {
                if (currentProductPage < parseInt(totalProductPagesSpan.textContent)) {
                    currentProductPage++;
                    await populateManageProductsTable();
                }
            });
            productSortBySelect.addEventListener('change', async () => { // Sıralama değiştiğinde tabloyu yenile
                currentProductPage = 1;
                await populateManageProductsTable();
            });


            // Kategori Yönetimi Pagination
            prevCategoryPageButton.addEventListener('click', async () => {
                if (currentCategoryPage > 1) {
                    currentCategoryPage--;
                    await populateManageCategoriesTable();
                }
            });
            nextCategoryPageButton.addEventListener('click', async () => {
                if (currentCategoryPage < parseInt(totalCategoryPagesSpan.textContent)) {
                    currentCategoryPage++;
                    await populateManageCategoriesTable();
                }
            });

            // Firma Yönetimi Pagination
            prevCompanyPageButton.addEventListener('click', async () => {
                if (currentCompanyPage > 1) {
                    currentCompanyPage--;
                    await populateManageCompaniesTable();
                }
            });
            nextCompanyPageButton.addEventListener('click', async () => {
                if (currentCompanyPage < parseInt(totalCompanyPagesSpan.textContent)) {
                    currentCompanyPage++;
                    await populateManageCompaniesTable();
                }
            });

  // Raporlar Filtreleme ve Pagination
filterReportsButton.addEventListener('click', async () => {
    currentReportPage = 1;
    await fetchAllTransactionsForReports();
});

// Real-time global search için rapor arama inputu
let reportSearchTimeout;
reportGlobalSearchInput.addEventListener('input', () => {
    clearTimeout(reportSearchTimeout);
    reportSearchTimeout = setTimeout(async () => {
        currentReportPage = 1;
        await fetchAllTransactionsForReports();
    }, 700); // 700ms bekle (daha uzun çünkü daha ağır sorgu)
}); 
            clearReportsFilterButton.addEventListener('click', async () => {
    reportGlobalSearchInput.value = '';
    reportStartDateInput.value = '';
    reportEndDateInput.value = '';
    reportProductFilterSelect.value = '';
    reportCategoryFilterSelect.value = '';
    reportCompanyFilterSelect.value = '';
    reportTransactionTypeFilterSelect.value = '';
    reportUserFilterSelect.value = '';
    currentReportPage = 1;
    await fetchAllTransactionsForReports();
});

// Quick Filter Event Listeners
quickFilterTodayButton.addEventListener('click', async () => {
    const today = new Date().toISOString().split('T')[0];
    reportStartDateInput.value = today;
    reportEndDateInput.value = today;
    currentReportPage = 1;
    await fetchAllTransactionsForReports();
});

quickFilterWeekButton.addEventListener('click', async () => {
    const today = new Date();
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    reportStartDateInput.value = weekAgo.toISOString().split('T')[0];
    reportEndDateInput.value = today.toISOString().split('T')[0];
    currentReportPage = 1;
    await fetchAllTransactionsForReports();
});

quickFilterMonthButton.addEventListener('click', async () => {
    const today = new Date();
    const monthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    reportStartDateInput.value = monthAgo.toISOString().split('T')[0];
    reportEndDateInput.value = today.toISOString().split('T')[0];
    currentReportPage = 1;
    await fetchAllTransactionsForReports();
});
            prevReportPageButton.addEventListener('click', async () => {
                if (currentReportPage > 1) {
                    currentReportPage--;
                    await fetchAllTransactionsForReports();
                }
            });
            nextReportPageButton.addEventListener('click', async () => {
                if (currentReportPage < parseInt(totalReportPagesSpan.textContent)) {
                    currentReportPage++;
                    await fetchAllTransactionsForReports();
                }
            });

            // Kullanıcı Yönetimi Pagination
            prevUserPageButton.addEventListener('click', async () => {
                if (currentUserPage > 1) {
                    currentUserPage--;
                    await populateManageUsersTable();
                }
            });
            nextUserPageButton.addEventListener('click', async () => {
                if (currentUserPage < parseInt(totalUserPagesSpan.textContent)) {
                    currentUserPage++;
                    await populateManageUsersTable();
                }
            });

            // Denetim Kayıtları Pagination
            prevAuditLogPageButton.addEventListener('click', async () => {
                if (currentAuditLogPage > 1) {
                    currentAuditLogPage--;
                    await fetchAuditLogs();
                }
            });
            nextAuditLogPageButton.addEventListener('click', async () => {
                if (currentAuditLogPage < parseInt(totalAuditLogPagesSpan.textContent)) {
                    currentAuditLogPage++;
                    await fetchAuditLogs();
                }
            });
            

         
            // ------------------- BOM YÖNETİMİ EVENT LISTENERS -------------------

            // Bitmiş Ürün Seçim Değişikliği
            //bomFinishedProductSelect.addEventListener('change', async (e) => {
              //  const selectedProductId = e.target.value;
              //  if (selectedProductId) {
                //    console.log('🔄 Bitmiş ürün seçildi:', selectedProductId);
                  //  await displayBomForProduct(selectedProductId);
               // } else {
                 //   console.log('ℹ️ Ürün seçimi temizlendi');
                   // selectedFinishedProductId = null;
                    //bomDisplayArea.classList.add('hidden');
                //}
            //});

            
            
            // Hammadde/Yarı Mamul Seçim Değişikliği (Add butonu aktivasyonu)
            
            //bomRawMaterialSelect.addEventListener('change', () => {
            //    validateBomForm();
            //});

            // Miktar Input Değişikliği (Add butonu aktivasyonu)
            bomQuantityRequiredInput.addEventListener('input', () => {
                validateBomForm();
            });

            

            // Reçeteye Ekle Butonu
            addToBomButton.addEventListener('click', async () => {
                await addBomItem();
            });

            // Enter tuşu ile ekleme
            bomQuantityRequiredInput.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter' && !addToBomButton.disabled) {
                    await addBomItem();
                }
            });

            // BOM Tablosu Event Delegation (Düzenle/Sil butonları)
            bomItemsTableBody.addEventListener('click', async (e) => {
                if (e.target.classList.contains('edit-bom-item-button') || e.target.closest('.edit-bom-item-button')) {
                    const button = e.target.classList.contains('edit-bom-item-button') ? e.target : e.target.closest('.edit-bom-item-button');
                    const bomItemId = button.dataset.id;
                    const currentQuantity = button.dataset.currentQuantity;
                    
                    if (bomItemId && currentQuantity) {
                        await editBomItem(bomItemId, currentQuantity);
                    }
                }

                if (e.target.classList.contains('delete-bom-item-button') || e.target.closest('.delete-bom-item-button')) {
                    const button = e.target.classList.contains('delete-bom-item-button') ? e.target : e.target.closest('.delete-bom-item-button');
                    const bomItemId = button.dataset.id;
                    
                    if (bomItemId) {
                        await deleteBomItem(bomItemId);
                    }
                }
            });


            // Sayfa ilk yüklendiğinde çalışacaklar
            checkLoginStatus(); // Bu, login durumuna göre doğru sayfayı gösterecek
            if (currentYearSpan) currentYearSpan.textContent = new Date().getFullYear();

            // Masaüstü için başlangıçta sidebar'ı açma
            adjustLayoutForScreenSize();
        });

        // URL hash değiştiğinde sayfayı güncelle
        window.addEventListener('hashchange', async () => {
            const hash = window.location.hash;
            if (hash.startsWith('#company-detail?id=')) {
                const companyId = hash.split('id=')[1];
                await showPage('company-detail', { companyId: parseInt(companyId) });
            } else {
                const pageName = hash.substring(1) || 'dashboard';
                await showPage(pageName);
            }
        });

        // Ekran boyutu değiştiğinde layout'u ayarla
        window.addEventListener('resize', adjustLayoutForScreenSize);


        // Step 6.A: Product Search for Purchase-In (Satın Alma Girişi için)
function setupProductSearchForPurchase() {
    let searchTimeout;

    purchaseInProductSearchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const query = purchaseInProductSearchInput.value.trim();

        if (query.length < 2) {
            purchaseInSearchResults.innerHTML = '';
            processPurchaseInButton.disabled = true;
            selectedProductForPurchaseIn = null;
            // Hata durumunda veya kısa sorguda ürün bilgi alanını da temizleyelim
            purchaseInSelectedProductInfo.innerHTML = '<p class="text-gray-600">Lütfen bir ürün seçin veya arayın.</p>';
            return;
        }

        searchTimeout = setTimeout(async () => {
            await fetchProductsForPurchase(query);
        }, 300);
    });

    purchaseInProductSearchInput.addEventListener('keypress', async (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            const firstResult = purchaseInSearchResults.querySelector('.search-result-item');
            if (firstResult) {
                selectProductForPurchase(firstResult);
            }
        }
    });

    purchaseInSearchResults.addEventListener('click', (e) => {
        const item = e.target.closest('.search-result-item');
        if (item) {
            selectProductForPurchase(item);
        }
    });
}

async function fetchProductsForPurchase(query) {
    try {
        // DÜZELTİLDİ: API_URL template literal içinde doğru kullanıldı
        const response = await fetchWithAuth(`${API_URL}/products?search=${encodeURIComponent(query)}&productType=HAMMADDE,YARI_MAMUL&limit=10`);
        const products = response.products;

        purchaseInSearchResults.innerHTML = '';

        if (products.length === 0) {
            purchaseInSearchResults.innerHTML = '<div class="p-3 text-gray-500">Hammadde veya yarı mamul bulunamadı.</div>';
            return;
        }

        products.forEach(product => {
            const item = document.createElement('div');
            item.classList.add('search-result-item');
            // DÜZELTİLDİ: item.innerHTML template literal içinde doğru kullanıldı
            item.innerHTML = `
                <span>${product.name} - <span class="text-gray-500">${product.product_type}</span></span>
                <span class="stock-info">Stok: ${product.stock}</span>
            `;
            item.dataset.productId = product.id;
            item.dataset.productName = product.name;
            item.dataset.productBarcode = product.barcode;
            item.dataset.productStock = product.stock;
            item.dataset.productType = product.product_type;
            purchaseInSearchResults.appendChild(item);
        });
    } catch (error) {
        console.error('Ürün arama hatası (fetchProductsForPurchase):', error);
        purchaseInSearchResults.innerHTML = `<div class="p-3 text-red-600">Ürünler getirilirken hata: ${error.message}</div>`;
    }
}

function selectProductForPurchase(item) {
    const product = {
        id: parseInt(item.dataset.productId),
        name: item.dataset.productName,
        barcode: item.dataset.productBarcode,
        stock: parseInt(item.dataset.productStock),
        product_type: item.dataset.productType
    };

    selectedProductForPurchaseIn = product;

    purchaseInSelectedProductInfo.innerHTML = `
        <p class="text-gray-700"><strong>Ürün Adı:</strong> ${product.name}</p>
        <p class="text-gray-700"><strong>Barkod:</strong> ${product.barcode}</p>
        <p class="text-gray-700"><strong>Tip:</strong> ${product.product_type}</p>
        <p class="text-gray-700"><strong>Mevcut Stok:</strong> ${product.stock} adet</p>
    `;

    purchaseInProductSearchInput.value = product.name;
    purchaseInSearchResults.innerHTML = '';
    validatePurchaseInForm(); // Bu fonksiyon Adım 8'de oluşturulmuştu
    purchaseInQuantityInput.focus();
}

// Step 6.B: Product Search for Production-In (Üretim Tamamlama için)

function setupProductSearchForProduction() {
    let searchTimeout;

    productionInProductSearchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const query = productionInProductSearchInput.value.trim();

        if (query.length < 2) {
            productionInSearchResults.innerHTML = '';
            processProductionInButton.disabled = true;
            selectedProductForProductionIn = null;
            bomPreviewArea.classList.add('hidden');
             // Hata durumunda veya kısa sorguda ürün bilgi alanını da temizleyelim
            productionInSelectedProductInfo.innerHTML = '<p class="text-gray-600">Lütfen bir ürün seçin veya arayın.</p>';
            return;
        }

        searchTimeout = setTimeout(async () => {
            await fetchProductsForProduction(query);
        }, 300);
    });

    productionInProductSearchInput.addEventListener('keypress', async (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            const firstResult = productionInSearchResults.querySelector('.search-result-item');
            if (firstResult) {
                await selectProductForProduction(firstResult);
            }
        }
    });

    productionInSearchResults.addEventListener('click', async (e) => {
        const item = e.target.closest('.search-result-item');
        if (item) {
            await selectProductForProduction(item);
        }
    });
}

async function fetchProductsForProduction(query) {
    try {
        // DÜZELTİLDİ: API_URL template literal içinde doğru kullanıldı
        const response = await fetchWithAuth(`${API_URL}/products?search=${encodeURIComponent(query)}&productType=BITMIS_URUN,YARI_MAMUL&limit=10`);
        const products = response.products;

        productionInSearchResults.innerHTML = '';

        if (products.length === 0) {
            productionInSearchResults.innerHTML = '<div class="p-3 text-gray-500">Bitmiş ürün veya yarı mamul bulunamadı.</div>';
            return;
        }

        products.forEach(product => {
            const item = document.createElement('div');
            item.classList.add('search-result-item');
            // DÜZELTİLDİ: item.innerHTML template literal içinde doğru kullanıldı
            item.innerHTML = `
                <span>${product.name} - <span class="text-gray-500">${product.product_type}</span></span>
                <span class="stock-info">Stok: ${product.stock}</span>
            `;
            item.dataset.productId = product.id;
            item.dataset.productName = product.name;
            item.dataset.productBarcode = product.barcode;
            item.dataset.productStock = product.stock;
            item.dataset.productType = product.product_type;
            productionInSearchResults.appendChild(item);
        });
    } catch (error) {
        console.error('Ürün arama hatası (fetchProductsForProduction):', error);
        productionInSearchResults.innerHTML = `<div class="p-3 text-red-600">Ürünler getirilirken hata: ${error.message}</div>`;
    }
}

async function selectProductForProduction(item) {
    const product = {
        id: parseInt(item.dataset.productId),
        name: item.dataset.productName,
        barcode: item.dataset.productBarcode,
        stock: parseInt(item.dataset.productStock),
        product_type: item.dataset.productType
    };

    selectedProductForProductionIn = product;

    productionInSelectedProductInfo.innerHTML = `
        <p class="text-gray-700"><strong>Ürün Adı:</strong> ${product.name}</p>
        <p class="text-gray-700"><strong>Barkod:</strong> ${product.barcode}</p>
        <p class="text-gray-700"><strong>Tip:</strong> ${product.product_type}</p>
        <p class="text-gray-700"><strong>Mevcut Stok:</strong> ${product.stock} adet</p>
    `;

    productionInProductSearchInput.value = product.name;
    productionInSearchResults.innerHTML = '';
    bomPreviewArea.classList.remove('hidden');

    await updateBomPreview(); // Bu fonksiyon Adım 7'de oluşturulmuştu
    productionInQuantityInput.focus();
}



// Step 7: BOM Preview Functionality

/**
 * Updates the Bill of Materials (BOM) preview section based on the selected product and quantity.
 * Fetches BOM data from the API and displays it, including component requirements and stock availability.
 */
async function updateBomPreview() {
    // Ensure a product is selected for production
    if (!selectedProductForProductionIn) return;

    // Get the production quantity, default to 1 if not set or invalid
    const quantity = parseInt(productionInQuantityInput.value) || 1;

    // Display loading messages and disable the process button
    bomPreviewTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Reçete kontrol ediliyor...</td></tr>';
    bomValidationMessage.innerHTML = '';
    processProductionInButton.disabled = true;

    try {
        const response = await fetchWithAuth(`${API_URL}/bom-preview/${selectedProductForProductionIn.id}/${quantity}?view=components`);

        // Clear the BOM table body
        bomPreviewTableBody.innerHTML = '';

        // Scenario 1: The selected product does not have a BOM
        if (!response.has_bom) {
            bomPreviewTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">Bu ürünün reçetesi bulunmuyor. Doğrudan stoğa eklenecek.</td></tr>';
            bomValidationMessage.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded-lg p-3"><i class="fas fa-info-circle text-blue-600 mr-2"></i>Bu ürün reçetesi olmadan üretilebilir.</div>';
            processProductionInButton.disabled = false; // Allow production without BOM
            currentBomPreview = { is_valid: true, has_bom: false }; // Update global BOM state
            return;
        }

        // =============================================================================
        // !!! API'DEN GELEN REÇETE KALEMLERİNİ KONSOLA YAZDIRALIM !!!
        // =============================================================================
        if (response.items) { // response.items varsa konsola yazdır
            console.log("API'den Gelen Reçete Kalemleri (response.items):", JSON.parse(JSON.stringify(response.items)));
        } else {
            console.log("API'den 'response.items' gelmedi veya tanımsız.");
        }
        // =============================================================================

        // Scenario 2: The product has a BOM, and items are present
        if (response.items && response.items.length > 0) {
            response.items.forEach(item => {
                const row = bomPreviewTableBody.insertRow();
                
                const availableQty = Number(item.available) || 0;
                const requiredQty = Number(item.required) || 0;  

                const statusClass = availableQty >= requiredQty ? 'text-green-600' : 'text-red-600';
                const statusIcon = availableQty >= requiredQty ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
                const statusText = availableQty >= requiredQty ? 'Yeterli' : 'Yetersiz';

                row.innerHTML = `
                    <td>${item.product_name || 'Bilinmeyen hammadde'}</td>
                <td>${requiredQty} ${item.unit_of_measure || item.product_unit_of_measure || 'adet'}</td>
                <td>${availableQty} ${item.unit_of_measure || item.product_unit_of_measure || 'adet'}</td>
                <td class="${statusClass}"><i class="${statusIcon} mr-1"></i>${statusText}</td>
                `;
            });
        } else { // response.items yoksa veya boşsa
             bomPreviewTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">Bu ürün için reçete bileşeni bulunamadı.</td></tr>';
        }

        // ... (fonksiyonun geri kalanı: if (response.is_valid) bloğu vs.) ...
        // Display validation message based on BOM check
        if (response.is_valid) {
            // All components are available
            bomValidationMessage.innerHTML = '<div class="bg-green-50 border border-green-200 rounded-lg p-3"><i class="fas fa-check-circle text-green-600 mr-2"></i>Tüm hammaddeler yeterli. Üretim gerçekleştirilebilir.</div>';
            processProductionInButton.disabled = false; // Enable the production button
        } else {
            // Some components are insufficient
            let errorHtml = '<div class="bg-red-50 border border-red-200 rounded-lg p-3"><i class="fas fa-exclamation-triangle text-red-600 mr-2"></i><strong>Yetersiz stok!</strong>';
            if (response.errors && response.errors.length > 0) {
                errorHtml += '<ul class="mt-2 ml-4 list-disc">';
                response.errors.forEach(error => {
                    errorHtml += `<li>${error}</li>`;
                });
                errorHtml += '</ul>';
            }
            errorHtml += '</div>';
            bomValidationMessage.innerHTML = errorHtml;
            processProductionInButton.disabled = true; // Keep production button disabled
        }

        currentBomPreview = response; // Update global BOM state

    } catch (error) {
        // Handle errors during API fetch or processing
        console.error('BOM preview hatası:', error);
        bomPreviewTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-red-600">Reçete bilgisi alınırken hata oluştu</td></tr>';
        bomValidationMessage.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-3"><i class="fas fa-exclamation-circle text-red-600 mr-2"></i>Reçete kontrolü yapılamadı. Lütfen tekrar deneyin.</div>';
        processProductionInButton.disabled = true;
        currentBomPreview = null; // Reset global BOM state on error
    }
}

/**
 * Debounce function to limit the rate at which a function is called.
 * This is useful for event handlers like 'input' on a text field to prevent
 * excessive API calls or computations.
 * @param {Function} func The function to debounce.
 * @param {number} wait The debounce delay in milliseconds.
 * @returns {Function} The debounced version of the function.
 */
function debounce(func, wait) {
    let timeout; // Variable to store the timeout ID

    // Return a new function that will be the debounced version
    return function executedFunction(...args) {
        // 'this' and 'args' are captured from the context where debounced function is called
        const context = this;

        // Function to be executed after the debounce delay
        const later = () => {
            timeout = null; // Clear the timeout ID
            func.apply(context, args); // Call the original function with original context and arguments
        };

        // Clear the existing timeout, if any
        clearTimeout(timeout);
        // Set a new timeout to execute 'later' function after 'wait' milliseconds
        timeout = setTimeout(later, wait);
    };
}

function getProductTypeDisplay(productType) {
    switch (productType) {
        case 'BITMIS_URUN':
            return 'Bitmiş Ürün';
        case 'YARI_MAMUL':
            return 'Yarı Mamul';
        case 'HAMMADDE':
            return 'Hammadde';
        default:
            return productType || 'Bilinmiyor'; // Eğer bilinmeyen bir tip gelirse veya boşsa
    }
}
// Step 8: Form Validation Functions

/**
 * Validates the Purchase-In form to enable/disable the process button.
 * Checks if a product is selected, a company is selected, and a valid quantity is entered.
 */
function validatePurchaseInForm() {
    // Check if a product has been selected for the purchase
    const productSelected = selectedProductForPurchaseIn !== null;
    // Check if a company ID has been set (meaning a company has been selected from autocomplete)
    const companySelected = purchaseInCompanyId.value !== '';
    // Check if the entered quantity is a number greater than 0
    const quantityValid = parseInt(purchaseInQuantityInput.value) > 0;

    // Enable the process button only if all conditions are met
    // Otherwise, disable it
    processPurchaseInButton.disabled = !(productSelected && companySelected && quantityValid);
}

// Add event listeners for real-time validation on the Purchase-In form.
// These will call validatePurchaseInForm whenever the user types in these fields.

// Validate when the company input changes
if (purchaseInCompanyInput) { // Check if the element exists
    purchaseInCompanyInput.addEventListener('input', validatePurchaseInForm);
}

// Validate when the quantity input changes
if (purchaseInQuantityInput) { // Check if the element exists
    purchaseInQuantityInput.addEventListener('input', validatePurchaseInForm);
}



        


        function adjustLayoutForScreenSize() {
    if (window.innerWidth > 991) {
        sidebarDiv.classList.add('open');
        mainContentWrapperDiv.classList.add('sidebar-open');
        hamburgerMenuButton.style.display = 'none';
        document.documentElement.classList.remove('sidebar-active');
    } else {
        sidebarDiv.classList.remove('open');
        mainContentWrapperDiv.classList.remove('sidebar-open');
        hamburgerMenuButton.style.display = 'block';
        hamburgerMenuButton.textContent = '☰';
        document.documentElement.classList.remove('sidebar-active');
    }
}

    // Not modal listener
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('view-note-btn')) {
        alert(e.target.dataset.note);
    }
});

    </script>


